<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Ø£Ù†Ø´Ø¦ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„ØªÙƒ Ù…Ø¬Ø§Ù†Ø§Ù‹ | Ø¹ÙØ¯Ù‘Ø©</title>
  <meta name="description" content="Ø£Ø¯Ø§Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø©. Ø£Ø¶Ù Ø§Ù„Ø£Ø´Ø®Ø§Øµ ÙˆØ§Ù„Ø¹Ù„Ø§Ù‚Ø§ØªØŒ Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±ØŒ ÙˆØµØ¯Ù‘Ø± Ø§Ù„Ø´Ø¬Ø±Ø© ÙƒØµÙˆØ±Ø© Ø£Ùˆ PDF.">
  <meta name="keywords" content="Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©ØŒ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„Ø©ØŒ Ù†Ø³Ø¨ØŒ Ø³Ù„Ø§Ù„Ø©ØŒ Ø£Ù†Ø³Ø§Ø¨ØŒ Ø¹Ù„Ø§Ù‚Ø§Øª Ø¹Ø§Ø¦Ù„ÙŠØ©ØŒ family tree">
  <meta name="author" content="Udda">
  <meta name="robots" content="index, follow">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Ø£Ù†Ø´Ø¦ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„ØªÙƒ Ù…Ø¬Ø§Ù†Ø§Ù‹ | Ø¹ÙØ¯Ù‘Ø©">
  <meta property="og:description" content="Ø£Ø¯Ø§Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø©. Ø£Ø¶Ù Ø§Ù„Ø£Ø´Ø®Ø§Øµ ÙˆØ§Ù„Ø¹Ù„Ø§Ù‚Ø§ØªØŒ Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±ØŒ ÙˆØµØ¯Ù‘Ø± Ø§Ù„Ø´Ø¬Ø±Ø© ÙƒØµÙˆØ±Ø© Ø£Ùˆ PDF.">
  <meta property="og:url" content="https://udda.tools/ar/tools/family-tree.html">
  <meta property="og:site_name" content="Ø¹ÙØ¯Ù‘Ø©">
  <meta property="og:locale" content="ar_SA">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Ø£Ù†Ø´Ø¦ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„ØªÙƒ Ù…Ø¬Ø§Ù†Ø§Ù‹ | Ø¹ÙØ¯Ù‘Ø©">
  <meta name="twitter:description" content="Ø£Ø¯Ø§Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø©. Ø£Ø¶Ù Ø§Ù„Ø£Ø´Ø®Ø§Øµ ÙˆØ§Ù„Ø¹Ù„Ø§Ù‚Ø§ØªØŒ Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±ØŒ ÙˆØµØ¯Ù‘Ø± Ø§Ù„Ø´Ø¬Ø±Ø© ÙƒØµÙˆØ±Ø© Ø£Ùˆ PDF.">
  
  <link rel="alternate" hreflang="ar" href="https://udda.tools/ar/tools/family-tree.html">
  <link rel="alternate" hreflang="en" href="https://udda.tools/en/tools/family-tree.html">
  <link rel="alternate" hreflang="x-default" href="https://udda.tools/ar/tools/family-tree.html">
  <link rel="canonical" href="https://udda.tools/ar/tools/family-tree.html">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/main.css">
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©",
    "description": "Ø£Ø¯Ø§Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø©. Ø£Ø¶Ù Ø§Ù„Ø£Ø´Ø®Ø§Øµ ÙˆØ§Ù„Ø¹Ù„Ø§Ù‚Ø§ØªØŒ Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±ØŒ ÙˆØµØ¯Ù‘Ø± Ø§Ù„Ø´Ø¬Ø±Ø© ÙƒØµÙˆØ±Ø© Ø£Ùˆ PDF.",
    "url": "https://udda.tools/ar/tools/family-tree.html",
    "applicationCategory": "UtilityApplication",
    "operatingSystem": "Any",
    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
    "inLanguage": ["ar", "en"],
    "isAccessibleForFree": true
  }
  </script>
</head>
<body data-tool-id="family-tree">
  <div class="app-container">
    <div class="sidebar-overlay"></div>
    
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="../../ar/" class="logo">
          <div class="logo-icon">ğŸ”§</div>
          <span class="logo-text sidebar-text">Ø¹ÙØ¯Ù‘Ø©</span>
        </a>
      </div>
      
      <div class="sidebar-search">
        <div class="search-input-wrapper">
          <input type="text" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¯Ø§Ø©..." aria-label="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¯Ø§Ø©...">
          <svg class="search-icon" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        
        <a href="../../ar/" class="nav-item ">
          <span class="nav-item-icon">ğŸ </span>
          <span class="sidebar-text">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </a>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ§®</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø§Øª</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
            <a href="../../ar/tools/percentage.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ”¢</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</span>
            </a>
            <a href="../../ar/tools/interest-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ’°</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ§Ø¦Ø¯</span>
            </a>
            <a href="../../ar/tools/loan-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ¦</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚Ø±ÙˆØ¶</span>
            </a>
            <a href="../../ar/tools/body-calculator.html" class="nav-item ">
              <span class="nav-item-icon">âš–ï¸</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø© ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù…</span>
            </a>
            <a href="../../ar/tools/age-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ‚</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…Ø±</span>
            </a>
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ”„</span>
              <span class="sidebar-text">Ù…Ø­ÙˆÙ‘Ù„Ø§Øª</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ“</span>
              <span class="sidebar-text">Ø£Ø¯ÙˆØ§Øª Ù†ØµÙŠØ©</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ“…</span>
              <span class="sidebar-text">ÙˆÙ‚Øª ÙˆØªØ§Ø±ÙŠØ®</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">âš¡</span>
              <span class="sidebar-text">Ù…ÙˆÙ„Ù‘Ø¯Ø§Øª</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ–¼ï¸</span>
              <span class="sidebar-text">Ø£Ø¯ÙˆØ§Øª ØµÙˆØ±</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ’»</span>
              <span class="sidebar-text">Ø£Ø¯ÙˆØ§Øª Ù…Ø·ÙˆØ±ÙŠÙ†</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section open">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ </span>
              <span class="sidebar-text">Ø£Ø¯ÙˆØ§Øª ÙŠÙˆÙ…ÙŠØ©</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
            <a href="../../ar/tools/family-tree.html" class="nav-item active">
              <span class="nav-item-icon">ğŸŒ³</span>
              <span class="sidebar-text">Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</span>
            </a>
          </div>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <button class="sidebar-toggle" aria-label="Toggle sidebar">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
          </svg>
          <span class="sidebar-text">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©</span>
        </button>
      </div>
    </aside>
    
    <div class="main-content">
      <header class="main-header">
        <button class="header-btn mobile-menu-btn" aria-label="Menu">
          <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        
        <nav class="header-breadcrumb">
          <a href="../../ar/" class="breadcrumb-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          <span class="breadcrumb-separator">â€º</span>
          <a href="../../ar/category/everyday.html" class="breadcrumb-link">Ø£Ø¯ÙˆØ§Øª ÙŠÙˆÙ…ÙŠØ©</a>
          <span class="breadcrumb-separator">â€º</span>
          <span class="breadcrumb-current">Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</span>
        </nav>
        
        <div class="header-actions">
          <button class="header-btn" data-favorite-btn aria-label="Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©">â˜†</button>
          <button class="header-btn" onclick="App.shareUrl('Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©')" aria-label="Ù…Ø´Ø§Ø±ÙƒØ©">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
              <polyline points="16 6 12 2 8 6"></polyline>
              <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg>
          </button>
          <button class="header-btn" data-open-settings aria-label="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </button>
        </div>
      </header>
      
      <main class="page-content">
        <style>
:root {
  --primary: #059669;
  --primary-dark: #047857;
  --male-color: #3b82f6;
  --female-color: #ec4899;
  --married-color: #f59e0b;
  --divorced-color: #6b7280;
  --widowed-color: #4b5563;
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --bg-card: #334155;
  --text-primary: #f8fafc;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border-color: #475569;
  --danger: #ef4444;
}

* { box-sizing: border-box; }

.family-tree-app {
  display: flex;
  gap: 16px;
  min-height: 75vh;
  font-family: inherit;
}

/* Sidebar */
.persons-sidebar {
  width: 260px;
  background: var(--bg-secondary);
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  flex-shrink: 0;
}

.sidebar-header {
  padding: 14px 16px;
  border-bottom: 2px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.sidebar-header h3 {
  font-size: 0.95rem;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 0;
}

.sidebar-header .count {
  background: var(--primary);
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.75rem;
}

.sidebar-search {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border-color);
}

.sidebar-search input {
  width: 100%;
  padding: 8px 12px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 0.85rem;
  font-family: inherit;
}

.sidebar-search input:focus {
  outline: none;
  border-color: var(--primary);
}

.persons-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.person-list-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 10px;
  background: var(--bg-card);
  border-radius: 8px;
  margin-bottom: 5px;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
}

.person-list-item:hover { border-color: var(--primary); }
.person-list-item.unlinked { border-color: var(--divorced-color); border-style: dashed; }

.person-list-item .avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  flex-shrink: 0;
}

.person-list-item .avatar.male { background: rgba(59, 130, 246, 0.2); }
.person-list-item .avatar.female { background: rgba(236, 72, 153, 0.2); }
.person-list-item .avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

.person-list-item .info { flex: 1; min-width: 0; }
.person-list-item .name { font-size: 0.8rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.person-list-item .lineage { font-size: 0.65rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.person-list-item .menu-btn {
  padding: 2px 6px;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 0.9rem;
  border-radius: 4px;
}

.person-list-item .menu-btn:hover { background: var(--bg-secondary); color: var(--text-primary); }

.section-title {
  font-size: 0.7rem;
  color: var(--text-muted);
  padding: 6px 10px;
  display: flex;
  align-items: center;
  gap: 6px;
  border-top: 1px solid var(--border-color);
  margin-top: 6px;
}

.add-person-btn {
  margin: 10px;
  padding: 10px;
  background: var(--primary);
  border: none;
  border-radius: 8px;
  color: white;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-family: inherit;
  font-size: 0.9rem;
}

.add-person-btn:hover { background: var(--primary-dark); }

/* Main Area */
.main-area { flex: 1; display: flex; flex-direction: column; min-width: 0; }

/* Toolbar */
.tree-toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 10px 14px;
  background: var(--bg-secondary);
  border-radius: 10px;
  margin-bottom: 10px;
  align-items: center;
}

.toolbar-group {
  display: flex;
  gap: 4px;
  padding: 0 10px;
  border-right: 2px solid var(--border-color);
}

.toolbar-group:last-child { border-right: none; }

.tool-btn {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 7px 12px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.2s;
}

.tool-btn:hover { border-color: var(--primary); }
.tool-btn .icon { font-size: 0.95rem; }

/* Canvas */
.canvas-container {
  flex: 1;
  position: relative;
  background: var(--bg-secondary);
  border-radius: 10px;
  overflow: hidden;
  min-height: 400px;
  border: 2px solid var(--border-color);
}

.tree-canvas { width: 100%; height: 100%; min-height: 400px; cursor: grab; font-family: inherit; }
.tree-canvas:active { cursor: grabbing; }
.tree-canvas text { font-family: inherit; }

/* Empty State */
.empty-state {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  color: var(--text-muted);
  pointer-events: none;
}

.empty-state .icon { font-size: 3rem; margin-bottom: 10px; opacity: 0.5; }
.empty-state h3 { font-size: 1.2rem; margin-bottom: 5px; color: var(--text-secondary); }

/* Zoom Controls */
.zoom-controls {
  position: absolute;
  bottom: 14px;
  left: 14px;
  display: flex;
  flex-direction: column;
  gap: 5px;
  background: var(--bg-card);
  padding: 5px;
  border-radius: 8px;
  border: 2px solid var(--border-color);
}

.zoom-btn {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-secondary);
  border: none;
  border-radius: 5px;
  color: var(--text-primary);
  font-size: 1rem;
  cursor: pointer;
}

.zoom-btn:hover { background: var(--primary); }
.zoom-level { text-align: center; font-size: 0.7rem; color: var(--text-muted); padding: 2px 0; }

/* Stats Bar */
.stats-bar {
  display: flex;
  gap: 14px;
  padding: 8px 14px;
  background: var(--bg-card);
  border-radius: 8px;
  margin-top: 10px;
  flex-wrap: wrap;
}

.stat-item { display: flex; align-items: center; gap: 5px; font-size: 0.8rem; }
.stat-item .label { color: var(--text-muted); }
.stat-item .value { font-weight: 700; color: var(--text-primary); }

/* Modals */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.modal-overlay.show { opacity: 1; visibility: visible; }

.modal-content {
  background: var(--bg-secondary);
  border-radius: 14px;
  width: 90%;
  max-width: 480px;
  max-height: 85vh;
  overflow-y: auto;
  transform: scale(0.9);
  transition: transform 0.3s;
}

.modal-overlay.show .modal-content { transform: scale(1); }

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
  border-bottom: 2px solid var(--border-color);
  position: sticky;
  top: 0;
  background: var(--bg-secondary);
  z-index: 10;
}

.modal-header h2 { font-size: 1rem; color: var(--text-primary); display: flex; align-items: center; gap: 8px; margin: 0; }

.modal-close {
  background: none;
  border: none;
  font-size: 1.3rem;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 5px;
}

.modal-close:hover { background: var(--bg-card); color: var(--text-primary); }

.modal-body { padding: 16px 18px; }

.form-group { margin-bottom: 14px; }
.form-group label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 5px; }

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 9px 12px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 7px;
  color: var(--text-primary);
  font-size: 0.9rem;
  font-family: inherit;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus { outline: none; border-color: var(--primary); }

.form-group textarea { min-height: 60px; resize: vertical; }

/* Gender Toggle */
.gender-toggle { display: flex; gap: 8px; }

.gender-option {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  padding: 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 7px;
  cursor: pointer;
  transition: all 0.2s;
}

.gender-option input { display: none; }
.gender-option.male:has(input:checked) { border-color: var(--male-color); background: rgba(59, 130, 246, 0.2); }
.gender-option.female:has(input:checked) { border-color: var(--female-color); background: rgba(236, 72, 153, 0.2); }
.gender-option span { font-weight: 600; font-size: 0.85rem; }

/* Photo Upload */
.photo-upload { display: flex; align-items: center; gap: 12px; }

.photo-preview {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  flex-shrink: 0;
}

.photo-preview img { width: 100%; height: 100%; object-fit: cover; }
.photo-preview .placeholder { font-size: 1.5rem; color: var(--text-muted); }

.photo-buttons { display: flex; flex-direction: column; gap: 5px; }

.photo-btn {
  padding: 5px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 5px;
  color: var(--text-primary);
  font-size: 0.75rem;
  cursor: pointer;
  font-family: inherit;
}

.photo-btn:hover { border-color: var(--primary); }
.photo-btn.remove { border-color: var(--danger); color: var(--danger); }

/* Link Person */
.link-selector { border: 2px solid var(--border-color); border-radius: 8px; overflow: hidden; }

.link-tabs { display: flex; background: var(--bg-card); }

.link-tab {
  flex: 1;
  padding: 9px;
  background: none;
  border: none;
  color: var(--text-muted);
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  font-size: 0.8rem;
}

.link-tab.active { background: var(--bg-secondary); color: var(--primary); }

.link-content { padding: 10px; }

.link-search {
  width: 100%;
  padding: 7px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 5px;
  color: var(--text-primary);
  font-size: 0.8rem;
  margin-bottom: 8px;
  font-family: inherit;
}

.link-search:focus { outline: none; border-color: var(--primary); }

.link-list { max-height: 160px; overflow-y: auto; }

.link-option {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 7px 8px;
  border-radius: 5px;
  cursor: pointer;
  margin-bottom: 3px;
  border: 2px solid transparent;
}

.link-option:hover { background: var(--bg-card); }
.link-option.selected { background: rgba(5, 150, 105, 0.2); border-color: var(--primary); }

.link-option .avatar { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
.link-option .name { font-size: 0.8rem; color: var(--text-primary); }
.link-option .lineage { font-size: 0.65rem; color: var(--text-muted); }
.link-option.none { border: 2px dashed var(--border-color); color: var(--text-muted); justify-content: center; }

/* Relations */
.relation-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 10px;
  background: var(--bg-card);
  border-radius: 6px;
  margin-bottom: 6px;
}

.relation-item .info { display: flex; align-items: center; gap: 8px; flex: 1; }
.relation-item .name { font-weight: 600; color: var(--text-primary); font-size: 0.85rem; }
.relation-item .lineage { font-size: 0.7rem; color: var(--text-muted); }
.relation-item .actions { display: flex; gap: 4px; }

.relation-item .action-btn {
  padding: 3px 7px;
  background: var(--bg-secondary);
  border: none;
  border-radius: 4px;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 0.75rem;
  font-family: inherit;
}

.relation-item .action-btn:hover { color: var(--text-primary); }
.relation-item .action-btn.danger:hover { color: var(--danger); }

/* Marriage Item */
.marriage-item {
  background: var(--bg-card);
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 8px;
  border-right: 4px solid var(--married-color);
}

.marriage-item.divorced { border-right-color: var(--divorced-color); }
.marriage-item.widowed { border-right-color: var(--widowed-color); }

.marriage-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.marriage-header .spouse-info { display: flex; align-items: center; gap: 8px; }
.marriage-header .spouse-name { font-weight: 600; color: var(--text-primary); font-size: 0.85rem; }

.marriage-details { display: flex; gap: 8px; flex-wrap: wrap; }

.marriage-details select,
.marriage-details input {
  padding: 5px 8px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 5px;
  color: var(--text-primary);
  font-size: 0.75rem;
  font-family: inherit;
}

.marriage-children { margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color); font-size: 0.75rem; color: var(--text-muted); }

/* Modal Footer */
.modal-footer {
  display: flex;
  gap: 8px;
  padding: 12px 18px;
  border-top: 2px solid var(--border-color);
  position: sticky;
  bottom: 0;
  background: var(--bg-secondary);
}

.modal-footer button {
  flex: 1;
  padding: 10px;
  border-radius: 7px;
  font-size: 0.9rem;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
}

.btn-cancel { background: var(--bg-card); border: 2px solid var(--border-color); color: var(--text-primary); }
.btn-save { background: var(--primary); border: none; color: white; }
.btn-save:hover { background: var(--primary-dark); }
.btn-delete { background: var(--danger); border: none; color: white; flex: 0.4; }

/* Context Menu */
.context-menu {
  position: fixed;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  min-width: 150px;
  z-index: 2000;
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  display: none;
}

.context-menu.show { display: block; }

.context-menu-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 9px 12px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.8rem;
}

.context-menu-item:first-child { border-radius: 6px 6px 0 0; }
.context-menu-item:last-child { border-radius: 0 0 6px 6px; }
.context-menu-item:hover { background: var(--bg-secondary); }
.context-menu-item.danger { color: var(--danger); }

.context-menu-divider { height: 1px; background: var(--border-color); margin: 3px 0; }

/* Add Menu */
.add-menu {
  position: fixed;
  background: var(--bg-card);
  border: 2px solid var(--primary);
  border-radius: 10px;
  min-width: 140px;
  z-index: 2000;
  box-shadow: 0 8px 25px rgba(0,0,0,0.4);
  display: none;
  transform: translate(-50%, 5px);
}

.add-menu.show { display: block; }

.add-menu-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
  transition: background 0.2s;
}

.add-menu-item:first-child { border-radius: 8px 8px 0 0; }
.add-menu-item:last-child { border-radius: 0 0 8px 8px; }
.add-menu-item:hover { background: var(--primary); }

/* Drag Ghost */
.drag-ghost {
  position: fixed;
  background: var(--bg-card);
  border: 2px solid var(--primary);
  border-radius: 8px;
  padding: 8px 14px;
  color: var(--text-primary);
  font-size: 0.85rem;
  font-weight: 600;
  z-index: 3000;
  pointer-events: none;
  transform: translate(-50%, -50%);
  box-shadow: 0 10px 30px rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  gap: 8px;
}

.drag-ghost span { font-size: 1.1rem; }

/* Drop Relation Options */
.drop-relation-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.drop-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  padding: 14px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 10px;
  color: var(--text-primary);
  cursor: pointer;
  font-family: inherit;
  font-size: 0.85rem;
  font-weight: 600;
  transition: all 0.2s;
}

.drop-option:hover {
  border-color: var(--primary);
  background: rgba(5, 150, 105, 0.1);
}

.drop-option span:first-child { font-size: 1.5rem; }

/* Toast */
.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--bg-card);
  border: 2px solid var(--primary);
  padding: 12px 18px;
  border-radius: 8px;
  color: var(--text-primary);
  font-weight: 600;
  z-index: 3000;
  opacity: 0;
  transition: all 0.3s;
}

.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* Dropdown */
.dropdown { position: relative; }

.dropdown-menu {
  position: absolute;
  top: 100%;
  left: 0;
  margin-top: 5px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  min-width: 150px;
  z-index: 100;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-6px);
  transition: all 0.2s;
}

.dropdown.open .dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }

.dropdown-item { display: flex; align-items: center; gap: 7px; padding: 8px 12px; color: var(--text-primary); font-size: 0.8rem; cursor: pointer; }
.dropdown-item:hover { background: var(--bg-secondary); }
.dropdown-item:first-child { border-radius: 6px 6px 0 0; }
.dropdown-item:last-child { border-radius: 0 0 6px 6px; }

.dropdown-divider { height: 1px; background: var(--border-color); margin: 3px 0; }

.hidden-input { display: none; }

@media (max-width: 850px) {
  .family-tree-app { flex-direction: column; }
  .persons-sidebar { width: 100%; max-height: 220px; }
  .toolbar-group { border-right: none; }
  .tool-btn span:not(.icon) { display: none; }
}
</style>

<div class="tool-card">
  <div class="tool-header">
    <div class="tool-icon">ğŸŒ³</div>
    <div>
      <h1 class="tool-title">Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>
      <p class="tool-description">Ø£Ù†Ø´Ø¦ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„ØªÙƒ Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØµØ¯Ù‘Ø±Ù‡Ø§ ÙƒØµÙˆØ±Ø©</p>
    </div>
  </div>

  <div class="family-tree-app">
    <aside class="persons-sidebar">
      <div class="sidebar-header">
        <h3>ğŸ“‹ <span id="sidebar-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø´Ø®Ø§Øµ</span> <span class="count" id="persons-count">0</span></h3>
      </div>
      <div class="sidebar-search">
        <input type="text" id="persons-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø´Ø®Øµ...">
      </div>
      <div class="persons-list" id="persons-list"></div>
      <button class="add-person-btn" onclick="openAddPersonModal()">â• Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</button>
    </aside>

    <main class="main-area">
      <div class="tree-toolbar">
        <div class="toolbar-group">
          <button class="tool-btn" onclick="saveToLocal()"><span class="icon">ğŸ’¾</span><span>Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ</span></button>
          <button class="tool-btn" onclick="loadFromLocal()"><span class="icon">ğŸ“‚</span><span>ØªØ­Ù…ÙŠÙ„ Ù…Ø­ÙÙˆØ¸</span></button>
        </div>
        <div class="toolbar-group">
          <div class="dropdown" id="export-dropdown">
            <button class="tool-btn" onclick="toggleDropdown('export-dropdown')"><span class="icon">ğŸ“¤</span><span>ØªØµØ¯ÙŠØ±</span></button>
            <div class="dropdown-menu">
              <div class="dropdown-item" onclick="exportAsPNG()">ğŸ–¼ï¸ ØªØµØ¯ÙŠØ± ÙƒØµÙˆØ±Ø© PNG</div>
              <div class="dropdown-item" onclick="exportAsSVG()">ğŸ“ ØªØµØ¯ÙŠØ± ÙƒÙ€ SVG</div>
              <div class="dropdown-divider"></div>
              <div class="dropdown-item" onclick="exportAsJSON()">ğŸ“„ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
            </div>
          </div>
          <button class="tool-btn" onclick="document.getElementById('import-input').click()"><span class="icon">ğŸ“¥</span><span>Ø§Ø³ØªÙŠØ±Ø§Ø¯</span></button>
        </div>
        <div class="toolbar-group">
          <button class="tool-btn" onclick="clearAll()"><span class="icon">ğŸ—‘ï¸</span><span>Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</span></button>
        </div>
      </div>

      <div class="canvas-container" id="canvas-container">
        <svg class="tree-canvas" id="tree-canvas">
          <defs>
            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="3" stdDeviation="4" flood-opacity="0.2"/>
            </filter>
          </defs>
          <g id="tree-content">
            <g id="connections-layer"></g>
            <g id="persons-layer"></g>
          </g>
        </svg>
        <div class="empty-state" id="empty-state">
          <div class="icon">ğŸŒ³</div>
          <h3>Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø´Ø®Øµ</h3>
          <p>Ø§Ø¶ØºØ· + Ù„Ø¥Ø¶Ø§ÙØ© Ù‚Ø±ÙŠØ¨</p>
        </div>
        <div class="zoom-controls">
          <button class="zoom-btn" onclick="zoomIn()">â•</button>
          <div class="zoom-level" id="zoom-level">100%</div>
          <button class="zoom-btn" onclick="zoomOut()">â–</button>
          <button class="zoom-btn" onclick="fitToScreen()">âŠ¡</button>
        </div>
      </div>

      <div class="stats-bar" id="stats-bar">
        <div class="stat-item"><span class="label">ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø´Ø®Ø§Øµ:</span><span class="value" id="stat-total">0</span></div>
        <div class="stat-item"><span class="label">ğŸ‘¨ Ø°ÙƒÙˆØ±:</span><span class="value" id="stat-males">0</span></div>
        <div class="stat-item"><span class="label">ğŸ‘© Ø¥Ù†Ø§Ø«:</span><span class="value" id="stat-females">0</span></div>
        <div class="stat-item"><span class="label">ğŸ“Š Ø§Ù„Ø£Ø¬ÙŠØ§Ù„:</span><span class="value" id="stat-generations">0</span></div>
      </div>
    </main>
  </div>
</div>

<!-- Person Modal -->
<div class="modal-overlay" id="person-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2><span id="modal-icon">ğŸ‘¤</span> <span id="modal-title">Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</span></h2>
      <button class="modal-close" onclick="closeModal('person-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Ø§Ù„Ø§Ø³Ù… *</label>
        <input type="text" id="person-name" required>
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ø¬Ù†Ø³</label>
        <div class="gender-toggle">
          <label class="gender-option male"><input type="radio" name="gender" value="male" checked><span>ğŸ‘¨ Ø°ÙƒØ±</span></label>
          <label class="gender-option female"><input type="radio" name="gender" value="female"><span>ğŸ‘© Ø£Ù†Ø«Ù‰</span></label>
        </div>
      </div>
      <div class="form-group">
        <label>Ø§Ù„ØµÙˆØ±Ø©</label>
        <div class="photo-upload">
          <div class="photo-preview" id="photo-preview"><span class="placeholder">ğŸ‘¤</span></div>
          <div class="photo-buttons">
            <button type="button" class="photo-btn" onclick="document.getElementById('photo-input').click()">ğŸ“· Ø±ÙØ¹ ØµÙˆØ±Ø©</button>
            <button type="button" class="photo-btn remove" onclick="removePhoto()" id="remove-photo-btn" style="display:none">ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©</button>
          </div>
        </div>
        <input type="file" id="photo-input" class="hidden-input" accept="image/*" onchange="handlePhotoUpload(event)">
      </div>
      <div class="form-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input type="date" id="person-birth"></div>
      <div class="form-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙØ§Ø©</label><input type="date" id="person-death"></div>
      <div class="form-group"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="person-notes"></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn-delete" id="delete-btn" onclick="deletePerson()" style="display:none">ğŸ—‘ï¸</button>
      <button class="btn-cancel" onclick="closeModal('person-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-save" onclick="savePerson()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Relations Modal -->
<div class="modal-overlay" id="relations-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ”— <span id="relations-title">Ø¹Ù„Ø§Ù‚Ø§Øª</span></h2>
      <button class="modal-close" onclick="closeModal('relations-modal')">&times;</button>
    </div>
    <div class="modal-body" id="relations-body"></div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('relations-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-save" onclick="saveRelations()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Link Modal -->
<div class="modal-overlay" id="link-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ”— <span id="link-title">Ø±Ø¨Ø·</span></h2>
      <button class="modal-close" onclick="closeModal('link-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="link-selector">
        <div class="link-tabs">
          <button class="link-tab active" onclick="switchLinkTab('existing')" data-tab="existing" id="tab-existing">Ø´Ø®Øµ Ù…ÙˆØ¬ÙˆØ¯</button>
          <button class="link-tab" onclick="switchLinkTab('new')" data-tab="new" id="tab-new">Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯</button>
        </div>
        <div class="link-content" id="link-content"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('link-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-save" onclick="confirmLink()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div class="context-menu" id="context-menu">
  <div class="context-menu-item" onclick="ctxAction('edit')">âœï¸ <span id="ctx-edit">ØªØ¹Ø¯ÙŠÙ„</span></div>
  <div class="context-menu-item" onclick="ctxAction('relations')">ğŸ”— <span id="ctx-relations">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª</span></div>
  <div class="context-menu-item" onclick="ctxAction('locate')">ğŸ“ <span id="ctx-locate">Ø¥Ø¸Ù‡Ø§Ø± ÙÙŠ Ø§Ù„Ø´Ø¬Ø±Ø©</span></div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item danger" onclick="ctxAction('delete')">ğŸ—‘ï¸ <span id="ctx-delete">Ø­Ø°Ù</span></div>
</div>

<!-- Add Menu -->
<div class="add-menu" id="add-menu">
  <div class="add-menu-item" onclick="addMenuAction('parent')">ğŸ‘¨â€ğŸ‘© <span id="add-parent">Ø£Ø¨ / Ø£Ù…</span></div>
  <div class="add-menu-item" onclick="addMenuAction('child')">ğŸ‘¶ <span id="add-child">Ø§Ø¨Ù† / Ø§Ø¨Ù†Ø©</span></div>
  <div class="add-menu-item" onclick="addMenuAction('sibling')">ğŸ‘« <span id="add-sibling">Ø£Ø® / Ø£Ø®Øª</span></div>
  <div class="add-menu-item" onclick="addMenuAction('spouse')">ğŸ’‘ <span id="add-spouse">Ø²ÙˆØ¬ / Ø²ÙˆØ¬Ø©</span></div>
</div>

<!-- Drop Relation Modal -->
<div class="modal-overlay" id="drop-relation-modal">
  <div class="modal-content" style="max-width:360px">
    <div class="modal-header">
      <h2>ğŸ”— <span id="drop-title">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©</span></h2>
      <button class="modal-close" onclick="closeModal('drop-relation-modal')">&times;</button>
    </div>
    <div class="modal-body" style="text-align:center">
      <p style="margin-bottom:15px;color:var(--text-secondary)">
        <strong id="drop-dragged-name">-</strong> 
        <span id="drop-relation-to">Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù€</span> 
        <strong id="drop-target-name">-</strong>
      </p>
      <div class="drop-relation-options">
        <button class="drop-option" onclick="confirmDropRelation('child-of')">
          <span>ğŸ‘¶</span>
          <span id="opt-child">Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø©</span>
        </button>
        <button class="drop-option" onclick="confirmDropRelation('parent-of')">
          <span>ğŸ‘¨â€ğŸ‘©</span>
          <span id="opt-parent">Ø£Ø¨/Ø£Ù…</span>
        </button>
        <button class="drop-option" onclick="confirmDropRelation('sibling-of')">
          <span>ğŸ‘«</span>
          <span id="opt-sibling">Ø£Ø®/Ø£Ø®Øª</span>
        </button>
        <button class="drop-option" onclick="confirmDropRelation('spouse-of')">
          <span>ğŸ’‘</span>
          <span id="opt-spouse">Ø²ÙˆØ¬/Ø²ÙˆØ¬Ø©</span>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="import-input" class="hidden-input" accept=".json" onchange="handleImport(event)">

<script>
const isArabic = document.documentElement.lang === 'ar';
const t = (ar, en) => isArabic ? ar : en;

// ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ±
if (!isArabic) {
  document.getElementById('sidebar-title').textContent = 'Persons List';
  document.getElementById('persons-search').placeholder = 'Search person...';
  document.getElementById('tab-existing').textContent = 'Existing Person';
  document.getElementById('tab-new').textContent = 'New Person';
  document.getElementById('ctx-edit').textContent = 'Edit';
  document.getElementById('ctx-relations').textContent = 'Edit Relations';
  document.getElementById('ctx-locate').textContent = 'Show in Tree';
  document.getElementById('ctx-delete').textContent = 'Delete';
  document.getElementById('add-parent').textContent = 'Father / Mother';
  document.getElementById('add-child').textContent = 'Son / Daughter';
  document.getElementById('add-sibling').textContent = 'Brother / Sister';
  document.getElementById('add-spouse').textContent = 'Spouse';
  document.getElementById('drop-title').textContent = 'Select Relation';
  document.getElementById('drop-relation-to').textContent = 'in relation to';
  document.getElementById('opt-child').textContent = 'Son/Daughter';
  document.getElementById('opt-parent').textContent = 'Father/Mother';
  document.getElementById('opt-sibling').textContent = 'Sibling';
  document.getElementById('opt-spouse').textContent = 'Spouse';
}

let data = { persons: {}, rootId: null };
let currentPersonId = null;
let editMode = false;
let currentPhoto = null;
let linkCallback = null;
let selectedLinkId = null;
let linkTab = 'existing';
let ctxTargetId = null;

let zoom = 1, panX = 0, panY = 0;
let isDragging = false, dragStartX = 0, dragStartY = 0;

const CARD_W = 125, CARD_H = 85, GAP_H = 40, GAP_V = 65;

function init() {
  setupCanvas();
  renderPersonsList();
  renderTree();
  updateStats();
  
  document.addEventListener('click', (e) => {
    document.getElementById('context-menu').classList.remove('show');
    document.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
    
    // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§
    if (!e.target.closest('.add-menu') && !e.target.closest('.add-btn-internal')) {
      hideAddMenu();
    }
  });
  
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      closeModal('person-modal');
      closeModal('relations-modal');
      closeModal('link-modal');
      closeModal('drop-relation-modal');
      hideAddMenu();
    }
  });
}

function generateId() { return 'p' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5); }

function getLineage(personId, maxDepth = 3) {
  const person = data.persons[personId];
  if (!person) return '';
  let result = person.name, current = person, depth = 0;
  while (current.fatherId && depth < maxDepth) {
    const father = data.persons[current.fatherId];
    if (!father) break;
    const prefix = current.gender === 'female' ? t('Ø¨Ù†Øª', 'd/o') : t('Ø¨Ù†', 's/o');
    result += ` ${prefix} ${father.name}`;
    current = father;
    depth++;
  }
  return result;
}

function getChildren(personId) {
  return Object.values(data.persons).filter(p => p.fatherId === personId || p.motherId === personId);
}

function getChildrenOfCouple(fatherId, motherId) {
  return Object.values(data.persons).filter(p => p.fatherId === fatherId && p.motherId === motherId);
}

function getSiblings(personId) {
  const person = data.persons[personId];
  if (!person) return [];
  return Object.values(data.persons).filter(p => 
    p.id !== personId && ((person.fatherId && p.fatherId === person.fatherId) || (person.motherId && p.motherId === person.motherId))
  );
}

function isDescendant(ancestorId, personId) {
  const person = data.persons[personId];
  if (!person) return false;
  if (person.fatherId === ancestorId || person.motherId === ancestorId) return true;
  if (person.fatherId && isDescendant(ancestorId, person.fatherId)) return true;
  if (person.motherId && isDescendant(ancestorId, person.motherId)) return true;
  return false;
}

// ========== PERSONS LIST ==========
function renderPersonsList() {
  const list = document.getElementById('persons-list');
  const search = document.getElementById('persons-search').value.toLowerCase();
  const persons = Object.values(data.persons);
  
  const linked = persons.filter(p => p.fatherId || p.motherId || (p.marriages && p.marriages.length > 0) || getChildren(p.id).length > 0);
  const unlinked = persons.filter(p => !p.fatherId && !p.motherId && (!p.marriages || p.marriages.length === 0) && getChildren(p.id).length === 0);
  const filterFn = p => p.name.toLowerCase().includes(search) || getLineage(p.id).toLowerCase().includes(search);
  
  let html = '';
  linked.filter(filterFn).forEach(p => { html += personListItem(p); });
  
  const fu = unlinked.filter(filterFn);
  if (fu.length > 0) {
    html += `<div class="section-title">âš ï¸ ${t('ØºÙŠØ± Ù…Ø±ØªØ¨Ø·ÙŠÙ†', 'Unlinked')} (${fu.length})</div>`;
    fu.forEach(p => { html += personListItem(p, true); });
  }
  
  list.innerHTML = html || `<div style="text-align:center;padding:20px;color:var(--text-muted)">${t('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø´Ø®Ø§Øµ', 'No persons')}</div>`;
  document.getElementById('persons-count').textContent = persons.length;
}

function personListItem(person, unlinked = false) {
  const avatar = person.photo ? `<img src="${person.photo}">` : (person.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨');
  return `<div class="person-list-item ${unlinked ? 'unlinked' : ''}" data-id="${person.id}" onclick="locateInTree('${person.id}')" oncontextmenu="showCtxMenu(event, '${person.id}')">
    <div class="avatar ${person.gender}">${avatar}</div>
    <div class="info"><div class="name">${person.name}</div><div class="lineage">${getLineage(person.id)}</div></div>
    <button class="menu-btn" onclick="event.stopPropagation(); showCtxMenu(event, '${person.id}')">â‹®</button>
  </div>`;
}

document.getElementById('persons-search').addEventListener('input', renderPersonsList);

// ========== CONTEXT MENU ==========
function showCtxMenu(e, personId) {
  e.preventDefault();
  e.stopPropagation();
  ctxTargetId = personId;
  const menu = document.getElementById('context-menu');
  menu.style.left = e.clientX + 'px';
  menu.style.top = e.clientY + 'px';
  menu.classList.add('show');
}

function ctxAction(action) {
  document.getElementById('context-menu').classList.remove('show');
  if (!ctxTargetId) return;
  switch (action) {
    case 'edit': openEditPersonModal(ctxTargetId); break;
    case 'relations': openRelationsModal(ctxTargetId); break;
    case 'locate': locateInTree(ctxTargetId); break;
    case 'delete':
      if (confirm(t('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ ÙˆÙƒÙ„ Ø°Ø±ÙŠØªÙ‡ØŸ', 'Delete this person and descendants?'))) deletePersonWithDescendants(ctxTargetId);
      break;
  }
}

// ========== PERSON MODAL ==========
function openAddPersonModal() {
  editMode = false;
  currentPersonId = null;
  currentPhoto = null;
  document.getElementById('modal-title').textContent = t('Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ', 'Add Person');
  document.getElementById('modal-icon').textContent = 'ğŸ‘¤';
  document.getElementById('delete-btn').style.display = 'none';
  resetPersonForm();
  openModal('person-modal');
}

function openEditPersonModal(personId) {
  editMode = true;
  currentPersonId = personId;
  const person = data.persons[personId];
  if (!person) return;
  
  document.getElementById('modal-title').textContent = t('ØªØ¹Ø¯ÙŠÙ„', 'Edit');
  document.getElementById('modal-icon').textContent = 'âœï¸';
  document.getElementById('delete-btn').style.display = 'block';
  
  document.getElementById('person-name').value = person.name || '';
  document.querySelector(`input[name="gender"][value="${person.gender}"]`).checked = true;
  document.getElementById('person-birth').value = person.birthDate || '';
  document.getElementById('person-death').value = person.deathDate || '';
  document.getElementById('person-notes').value = person.notes || '';
  currentPhoto = person.photo || null;
  updatePhotoPreview();
  openModal('person-modal');
}

function savePerson() {
  const name = document.getElementById('person-name').value.trim();
  if (!name) { showToast(t('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…', 'Please enter name')); return; }
  
  const personData = {
    name,
    gender: document.querySelector('input[name="gender"]:checked').value,
    photo: currentPhoto,
    birthDate: document.getElementById('person-birth').value || null,
    deathDate: document.getElementById('person-death').value || null,
    notes: document.getElementById('person-notes').value.trim()
  };
  
  if (editMode && currentPersonId) {
    Object.assign(data.persons[currentPersonId], personData);
  } else {
    const newId = generateId();
    data.persons[newId] = { id: newId, ...personData, fatherId: null, motherId: null, marriages: [] };
    if (!data.rootId) data.rootId = newId;
  }
  
  closeModal('person-modal');
  renderPersonsList();
  layoutTree();
  renderTree();
  updateStats();
  showToast(t('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'Saved'));
}

function deletePerson() {
  if (!currentPersonId) return;
  deletePersonWithDescendants(currentPersonId);
  closeModal('person-modal');
}

function deletePersonWithDescendants(personId) {
  const toDelete = [personId];
  function collect(pid) { getChildren(pid).forEach(c => { toDelete.push(c.id); collect(c.id); }); }
  collect(personId);
  
  toDelete.forEach(pid => {
    Object.values(data.persons).forEach(p => { if (p.marriages) p.marriages = p.marriages.filter(m => m.spouseId !== pid); });
    delete data.persons[pid];
  });
  
  if (data.rootId === personId) {
    const rem = Object.keys(data.persons);
    data.rootId = rem.length > 0 ? rem[0] : null;
  }
  
  renderPersonsList();
  layoutTree();
  renderTree();
  updateStats();
  showToast(t('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'Deleted'));
}

function resetPersonForm() {
  document.getElementById('person-name').value = '';
  document.querySelector('input[name="gender"][value="male"]').checked = true;
  document.getElementById('person-birth').value = '';
  document.getElementById('person-death').value = '';
  document.getElementById('person-notes').value = '';
  currentPhoto = null;
  updatePhotoPreview();
}

// ========== RELATIONS MODAL ==========
function openRelationsModal(personId) {
  currentPersonId = personId;
  const person = data.persons[personId];
  if (!person) return;
  
  document.getElementById('relations-title').textContent = t(`Ø¹Ù„Ø§Ù‚Ø§Øª "${person.name}"`, `Relations of "${person.name}"`);
  let html = '';
  
  // Ø§Ù„Ø£Ø¨
  html += `<div class="form-group"><label>ğŸ‘¨ ${t('Ø§Ù„Ø£Ø¨', 'Father')}</label>
    <div class="relation-item">
      <div class="info">${person.fatherId ? `<span class="name">${data.persons[person.fatherId]?.name || '?'}</span><span class="lineage">${getLineage(person.fatherId)}</span>` : `<span style="color:var(--text-muted)">${t('ØºÙŠØ± Ù…Ø­Ø¯Ø¯', 'Not set')}</span>`}</div>
      <div class="actions">
        <button class="action-btn" onclick="openLinkModal('father', '${personId}')">${t('ØªØºÙŠÙŠØ±', 'Change')}</button>
        ${person.fatherId ? `<button class="action-btn danger" onclick="unlinkParent('${personId}', 'father')">âœ•</button>` : ''}
      </div>
    </div></div>`;
  
  // Ø§Ù„Ø£Ù…
  html += `<div class="form-group"><label>ğŸ‘© ${t('Ø§Ù„Ø£Ù…', 'Mother')}</label>
    <div class="relation-item">
      <div class="info">${person.motherId ? `<span class="name">${data.persons[person.motherId]?.name || '?'}</span><span class="lineage">${getLineage(person.motherId)}</span>` : `<span style="color:var(--text-muted)">${t('ØºÙŠØ± Ù…Ø­Ø¯Ø¯', 'Not set')}</span>`}</div>
      <div class="actions">
        <button class="action-btn" onclick="openLinkModal('mother', '${personId}')">${t('ØªØºÙŠÙŠØ±', 'Change')}</button>
        ${person.motherId ? `<button class="action-btn danger" onclick="unlinkParent('${personId}', 'mother')">âœ•</button>` : ''}
      </div>
    </div></div>`;
  
  // Ø§Ù„Ø²ÙˆØ§Ø¬Ø§Øª
  html += `<div class="form-group"><label>ğŸ’‘ ${t('Ø§Ù„Ø²ÙˆØ§Ø¬Ø§Øª', 'Marriages')}</label>`;
  if (person.marriages && person.marriages.length > 0) {
    person.marriages.forEach((m, idx) => {
      const spouse = data.persons[m.spouseId];
      const children = getChildrenOfCouple(person.gender === 'male' ? personId : m.spouseId, person.gender === 'female' ? personId : m.spouseId);
      const statusClass = m.status === 'divorced' ? 'divorced' : m.status === 'widowed' ? 'widowed' : '';
      
      html += `<div class="marriage-item ${statusClass}">
        <div class="marriage-header">
          <div class="spouse-info"><span>${spouse?.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨'}</span><span class="spouse-name">${spouse?.name || '?'}</span></div>
          <button class="action-btn danger" onclick="removeMarriage('${personId}', ${idx})">âœ•</button>
        </div>
        <div class="marriage-details">
          <select onchange="updateMarriageStatus('${personId}', ${idx}, this.value)">
            <option value="married" ${m.status === 'married' ? 'selected' : ''}>ğŸ’‘ ${t('Ù…ØªØ²ÙˆØ¬Ø§Ù†', 'Married')}</option>
            <option value="divorced" ${m.status === 'divorced' ? 'selected' : ''}>ğŸ’” ${t('Ù…Ø·Ù„Ù‚Ø§Ù†', 'Divorced')}</option>
            <option value="widowed" ${m.status === 'widowed' ? 'selected' : ''}>âœï¸ ${t('Ø£Ø±Ù…Ù„/Ø©', 'Widowed')}</option>
          </select>
          <input type="number" placeholder="${t('Ù…Ù†', 'From')}" value="${m.startYear || ''}" onchange="updateMarriageYear('${personId}', ${idx}, 'start', this.value)" style="width:70px">
          <input type="number" placeholder="${t('Ø¥Ù„Ù‰', 'To')}" value="${m.endYear || ''}" onchange="updateMarriageYear('${personId}', ${idx}, 'end', this.value)" style="width:70px">
        </div>
        ${children.length > 0 ? `<div class="marriage-children">ğŸ‘¶ ${t('Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡', 'Children')}: ${children.map(c => c.name).join('ØŒ ')}</div>` : ''}
      </div>`;
    });
  } else {
    html += `<div style="color:var(--text-muted);padding:8px">${t('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙˆØ§Ø¬Ø§Øª', 'No marriages')}</div>`;
  }
  html += `<button class="action-btn" onclick="openLinkModal('spouse', '${personId}')" style="margin-top:6px">â• ${t('Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ¬/Ø©', 'Add Spouse')}</button></div>`;
  
  // Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
  const children = getChildren(personId);
  html += `<div class="form-group"><label>ğŸ‘¶ ${t('Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡', 'Children')} (${children.length})</label>`;
  if (children.length > 0) {
    children.forEach(child => {
      const otherParent = person.gender === 'male' ? (child.motherId ? data.persons[child.motherId]?.name : t('ØºÙŠØ± Ù…Ø­Ø¯Ø¯', 'Unknown')) : (child.fatherId ? data.persons[child.fatherId]?.name : t('ØºÙŠØ± Ù…Ø­Ø¯Ø¯', 'Unknown'));
      html += `<div class="relation-item"><div class="info"><span>${child.gender === 'female' ? 'ğŸ‘§' : 'ğŸ‘¦'}</span><span class="name">${child.name}</span><span class="lineage">(${t('Ù…Ù†', 'with')} ${otherParent})</span></div></div>`;
    });
  } else {
    html += `<div style="color:var(--text-muted);padding:8px">${t('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¨Ù†Ø§Ø¡', 'No children')}</div>`;
  }
  html += `<button class="action-btn" onclick="openLinkModal('child', '${personId}')" style="margin-top:6px">â• ${t('Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø©', 'Add Child')}</button></div>`;
  
  document.getElementById('relations-body').innerHTML = html;
  openModal('relations-modal');
}

function unlinkParent(personId, parentType) {
  const person = data.persons[personId];
  if (!person) return;
  if (parentType === 'father') person.fatherId = null;
  else person.motherId = null;
  openRelationsModal(personId);
  renderPersonsList();
  layoutTree();
  renderTree();
}

function removeMarriage(personId, idx) {
  const person = data.persons[personId];
  if (!person || !person.marriages) return;
  const m = person.marriages[idx];
  if (m) {
    const spouse = data.persons[m.spouseId];
    if (spouse && spouse.marriages) spouse.marriages = spouse.marriages.filter(x => x.spouseId !== personId);
  }
  person.marriages.splice(idx, 1);
  openRelationsModal(personId);
  renderPersonsList();
  layoutTree();
  renderTree();
}

function updateMarriageStatus(personId, idx, status) {
  const person = data.persons[personId];
  if (person?.marriages?.[idx]) {
    person.marriages[idx].status = status;
    const spouse = data.persons[person.marriages[idx].spouseId];
    if (spouse?.marriages) {
      const sm = spouse.marriages.find(m => m.spouseId === personId);
      if (sm) sm.status = status;
    }
  }
  renderTree();
}

function updateMarriageYear(personId, idx, type, value) {
  const person = data.persons[personId];
  if (person?.marriages?.[idx]) {
    const year = value ? parseInt(value) : null;
    if (type === 'start') person.marriages[idx].startYear = year;
    else person.marriages[idx].endYear = year;
    const spouse = data.persons[person.marriages[idx].spouseId];
    if (spouse?.marriages) {
      const sm = spouse.marriages.find(m => m.spouseId === personId);
      if (sm) { if (type === 'start') sm.startYear = year; else sm.endYear = year; }
    }
  }
}

function saveRelations() {
  closeModal('relations-modal');
  renderPersonsList();
  layoutTree();
  renderTree();
  updateStats();
}

// ========== LINK MODAL ==========
function openLinkModal(relationType, personId) {
  currentPersonId = personId;
  linkCallback = relationType;
  selectedLinkId = null;
  linkTab = 'existing';
  
  const titles = { 
    father: t('Ø§Ø®ØªØ± Ø§Ù„Ø£Ø¨', 'Select Father'), 
    mother: t('Ø§Ø®ØªØ± Ø§Ù„Ø£Ù…', 'Select Mother'), 
    parent: t('Ø§Ø®ØªØ± Ø§Ù„Ø£Ø¨/Ø§Ù„Ø£Ù…', 'Select Parent'),
    spouse: t('Ø§Ø®ØªØ± Ø§Ù„Ø²ÙˆØ¬/Ø©', 'Select Spouse'), 
    child: t('Ø§Ø®ØªØ± Ø§Ù„Ø§Ø¨Ù†/Ø©', 'Select Child'),
    sibling: t('Ø§Ø®ØªØ± Ø§Ù„Ø£Ø®/Ø§Ù„Ø£Ø®Øª', 'Select Sibling')
  };
  document.getElementById('link-title').textContent = titles[relationType] || t('Ø±Ø¨Ø·', 'Link');
  document.querySelectorAll('.link-tab').forEach(tab => { tab.classList.toggle('active', tab.dataset.tab === 'existing'); });
  renderLinkContent();
  openModal('link-modal');
}

function switchLinkTab(tab) {
  linkTab = tab;
  document.querySelectorAll('.link-tab').forEach(t => { t.classList.toggle('active', t.dataset.tab === tab); });
  renderLinkContent();
}

function renderLinkContent() {
  const content = document.getElementById('link-content');
  
  if (linkTab === 'new') {
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù†Ø³ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    let defaultGender = 'male';
    if (linkCallback === 'mother') defaultGender = 'female';
    
    content.innerHTML = `
      <div class="form-group"><label>${t('Ø§Ù„Ø§Ø³Ù…', 'Name')} *</label><input type="text" id="new-link-name"></div>
      <div class="form-group"><label>${t('Ø§Ù„Ø¬Ù†Ø³', 'Gender')}</label>
        <div class="gender-toggle">
          <label class="gender-option male"><input type="radio" name="new-gender" value="male" ${defaultGender === 'male' ? 'checked' : ''}><span>ğŸ‘¨ ${t('Ø°ÙƒØ±', 'Male')}</span></label>
          <label class="gender-option female"><input type="radio" name="new-gender" value="female" ${defaultGender === 'female' ? 'checked' : ''}><span>ğŸ‘© ${t('Ø£Ù†Ø«Ù‰', 'Female')}</span></label>
        </div>
      </div>`;
    return;
  }
  
  let candidates = Object.values(data.persons).filter(p => p.id !== currentPersonId);
  
  // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
  if (linkCallback === 'father') {
    candidates = candidates.filter(p => p.gender === 'male' && !isDescendant(p.id, currentPersonId));
  } else if (linkCallback === 'mother') {
    candidates = candidates.filter(p => p.gender === 'female' && !isDescendant(p.id, currentPersonId));
  } else if (linkCallback === 'parent') {
    candidates = candidates.filter(p => !isDescendant(p.id, currentPersonId));
  } else if (linkCallback === 'child') {
    candidates = candidates.filter(p => !isDescendant(currentPersonId, p.id));
  } else if (linkCallback === 'sibling') {
    // Ø§Ù„Ø¥Ø®ÙˆØ© ÙŠØ¬Ø¨ Ø£Ù† Ù„Ø§ ÙŠÙƒÙˆÙ†ÙˆØ§ Ø£Ø¬Ø¯Ø§Ø¯ Ø£Ùˆ Ø£Ø­ÙØ§Ø¯
    candidates = candidates.filter(p => !isDescendant(p.id, currentPersonId) && !isDescendant(currentPersonId, p.id));
  }
  
  content.innerHTML = `
    <input type="text" class="link-search" placeholder="${t('Ø§Ø¨Ø­Ø«...', 'Search...')}" oninput="filterLinkOptions(this.value)">
    <div class="link-list" id="link-list">
      <div class="link-option none ${!selectedLinkId ? 'selected' : ''}" onclick="selectLinkOption(null)">${t('Ø¨Ø¯ÙˆÙ† (ÙÙƒ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·)', 'None (Unlink)')}</div>
      ${candidates.map(p => `
        <div class="link-option ${selectedLinkId === p.id ? 'selected' : ''}" data-name="${p.name.toLowerCase()}" onclick="selectLinkOption('${p.id}')">
          <div class="avatar" style="background:${p.gender === 'female' ? 'rgba(236,72,153,0.2)' : 'rgba(59,130,246,0.2)'}">${p.photo ? `<img src="${p.photo}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">` : (p.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨')}</div>
          <div><div class="name">${p.name}</div><div class="lineage">${getLineage(p.id)}</div></div>
        </div>
      `).join('')}
    </div>`;
}

function filterLinkOptions(query) {
  const q = query.toLowerCase();
  document.querySelectorAll('#link-list .link-option:not(.none)').forEach(opt => { opt.style.display = (opt.dataset.name || '').includes(q) ? '' : 'none'; });
}

function selectLinkOption(id) {
  selectedLinkId = id;
  document.querySelectorAll('#link-list .link-option').forEach(opt => { opt.classList.remove('selected'); });
  if (id) document.querySelector(`#link-list .link-option[onclick*="${id}"]`)?.classList.add('selected');
  else document.querySelector('#link-list .link-option.none')?.classList.add('selected');
}

function confirmLink() {
  const person = data.persons[currentPersonId];
  if (!person) return;
  
  if (linkTab === 'new') {
    const name = document.getElementById('new-link-name').value.trim();
    if (!name) { showToast(t('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…', 'Please enter name')); return; }
    const gender = document.querySelector('input[name="new-gender"]:checked')?.value || 'male';
    const newId = generateId();
    data.persons[newId] = { id: newId, name, gender, photo: null, birthDate: null, deathDate: null, notes: '', fatherId: null, motherId: null, marriages: [] };
    selectedLinkId = newId;
  }
  
  switch (linkCallback) {
    case 'father': person.fatherId = selectedLinkId; break;
    case 'mother': person.motherId = selectedLinkId; break;
    case 'parent':
      if (selectedLinkId) {
        const selected = data.persons[selectedLinkId];
        if (selected) {
          if (selected.gender === 'male') person.fatherId = selectedLinkId;
          else person.motherId = selectedLinkId;
        }
      }
      break;
    case 'spouse':
      if (selectedLinkId) {
        const spouse = data.persons[selectedLinkId];
        if (spouse) {
          if (!person.marriages) person.marriages = [];
          if (!spouse.marriages) spouse.marriages = [];
          if (!person.marriages.find(m => m.spouseId === selectedLinkId)) person.marriages.push({ spouseId: selectedLinkId, status: 'married', startYear: null, endYear: null });
          if (!spouse.marriages.find(m => m.spouseId === currentPersonId)) spouse.marriages.push({ spouseId: currentPersonId, status: 'married', startYear: null, endYear: null });
        }
      }
      break;
    case 'child':
      if (selectedLinkId) {
        const child = data.persons[selectedLinkId];
        if (child) {
          if (person.gender === 'male') child.fatherId = currentPersonId;
          else child.motherId = currentPersonId;
        }
      }
      break;
    case 'sibling':
      if (selectedLinkId) {
        const sibling = data.persons[selectedLinkId];
        if (sibling) {
          if (person.fatherId) sibling.fatherId = person.fatherId;
          if (person.motherId) sibling.motherId = person.motherId;
        }
      }
      break;
  }
  
  closeModal('link-modal');
  renderPersonsList();
  layoutTree();
  renderTree();
  updateStats();
  showToast(t('ØªÙ…', 'Done'));
}

// ========== PHOTO ==========
function handlePhotoUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => { currentPhoto = ev.target.result; updatePhotoPreview(); };
  reader.readAsDataURL(file);
}

function removePhoto() {
  currentPhoto = null;
  updatePhotoPreview();
  document.getElementById('photo-input').value = '';
}

function updatePhotoPreview() {
  const preview = document.getElementById('photo-preview');
  const removeBtn = document.getElementById('remove-photo-btn');
  if (currentPhoto) { preview.innerHTML = `<img src="${currentPhoto}">`; removeBtn.style.display = 'block'; }
  else { preview.innerHTML = '<span class="placeholder">ğŸ‘¤</span>'; removeBtn.style.display = 'none'; }
}

// ========== LAYOUT ==========
function layoutTree() {
  const persons = Object.values(data.persons);
  if (persons.length === 0) return;
  
  const levels = {};
  const positioned = new Set();
  
  function assignLevel(personId, level) {
    if (positioned.has(personId)) return;
    positioned.add(personId);
    const person = data.persons[personId];
    if (!person) return;
    if (!levels[level]) levels[level] = [];
    levels[level].push(personId);
    person._level = level;
    
    if (person.fatherId) assignLevel(person.fatherId, level - 1);
    if (person.motherId) assignLevel(person.motherId, level - 1);
    getChildren(personId).forEach(child => assignLevel(child.id, level + 1));
    if (person.marriages) person.marriages.forEach(m => { if (!positioned.has(m.spouseId)) assignLevel(m.spouseId, level); });
    getSiblings(personId).forEach(sib => { if (!positioned.has(sib.id)) assignLevel(sib.id, level); });
  }
  
  const startId = data.rootId || Object.keys(data.persons)[0];
  if (startId) assignLevel(startId, 0);
  persons.forEach(p => { if (!positioned.has(p.id)) { if (!levels[0]) levels[0] = []; levels[0].push(p.id); p._level = 0; } });
  
  const levelNums = Object.keys(levels).map(Number).sort((a, b) => a - b);
  const minLevel = Math.min(...levelNums);
  const canvasW = document.getElementById('tree-canvas').clientWidth || 650;
  
  levelNums.forEach(lvl => {
    const pids = levels[lvl];
    const totalW = pids.length * CARD_W + (pids.length - 1) * GAP_H;
    const startX = Math.max(40, (canvasW - totalW) / 2);
    const y = 50 + (lvl - minLevel) * (CARD_H + GAP_V);
    pids.forEach((pid, idx) => { const p = data.persons[pid]; p._x = startX + idx * (CARD_W + GAP_H); p._y = y; });
  });
}

// ========== RENDER TREE ==========
function renderTree() {
  const connLayer = document.getElementById('connections-layer');
  const persLayer = document.getElementById('persons-layer');
  connLayer.innerHTML = '';
  persLayer.innerHTML = '';
  
  const persons = Object.values(data.persons);
  document.getElementById('empty-state').style.display = persons.length === 0 ? 'block' : 'none';
  if (persons.length === 0) return;
  
  persons.forEach(person => {
    if (person.fatherId) { const f = data.persons[person.fatherId]; if (f) drawParentLine(f, person, connLayer); }
    if (person.motherId) { const m = data.persons[person.motherId]; if (m) drawParentLine(m, person, connLayer); }
    if (person.marriages) person.marriages.forEach(m => { const s = data.persons[m.spouseId]; if (s && person.id < m.spouseId) drawMarriageLine(person, s, m.status, connLayer); });
  });
  
  persons.forEach(person => drawCard(person, persLayer));
  updateTransform();
}

function drawParentLine(parent, child, layer) {
  const x1 = parent._x + CARD_W / 2, y1 = parent._y + CARD_H;
  const x2 = child._x + CARD_W / 2, y2 = child._y;
  const midY = y1 + (y2 - y1) / 2;
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', `M ${x1} ${y1} L ${x1} ${midY} L ${x2} ${midY} L ${x2} ${y2}`);
  path.setAttribute('stroke', '#475569');
  path.setAttribute('stroke-width', '2');
  path.setAttribute('fill', 'none');
  layer.appendChild(path);
}

function drawMarriageLine(p1, p2, status, layer) {
  const x1 = Math.min(p1._x, p2._x) + CARD_W, x2 = Math.max(p1._x, p2._x), y = p1._y + CARD_H / 2;
  const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  line.setAttribute('x1', x1); line.setAttribute('y1', y); line.setAttribute('x2', x2); line.setAttribute('y2', y);
  if (status === 'divorced') { line.setAttribute('stroke', '#6b7280'); line.setAttribute('stroke-dasharray', '5,5'); }
  else if (status === 'widowed') { line.setAttribute('stroke', '#4b5563'); line.setAttribute('stroke-dasharray', '2,4'); }
  else { line.setAttribute('stroke', '#f59e0b'); }
  line.setAttribute('stroke-width', '2');
  layer.appendChild(line);
  
  const midX = (x1 + x2) / 2;
  const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  icon.setAttribute('x', midX); icon.setAttribute('y', y - 6); icon.setAttribute('text-anchor', 'middle'); icon.setAttribute('font-size', '11');
  icon.textContent = status === 'divorced' ? 'ğŸ’”' : status === 'widowed' ? 'âœï¸' : 'ğŸ’‘';
  layer.appendChild(icon);
}

function drawCard(person, layer) {
  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.setAttribute('transform', `translate(${person._x}, ${person._y})`);
  g.setAttribute('class', 'person-card-group');
  g.setAttribute('data-id', person.id);
  g.style.cursor = 'pointer';
  
  // Ø§Ù„Ø®Ù„ÙÙŠØ©
  const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  rect.setAttribute('width', CARD_W); rect.setAttribute('height', CARD_H); rect.setAttribute('rx', '8');
  rect.setAttribute('fill', '#334155');
  rect.setAttribute('stroke', person.gender === 'female' ? '#ec4899' : '#3b82f6');
  rect.setAttribute('stroke-width', person.deathDate ? '2' : '2.5');
  if (person.deathDate) rect.setAttribute('stroke-dasharray', '4,3');
  rect.setAttribute('filter', 'url(#shadow)');
  g.appendChild(rect);
  
  // Ø§Ù„ØµÙˆØ±Ø© Ø£Ùˆ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
  if (person.photo) {
    const img = document.createElementNS('http://www.w3.org/2000/svg', 'image');
    img.setAttribute('x', CARD_W/2 - 14); img.setAttribute('y', 5); img.setAttribute('width', 28); img.setAttribute('height', 28);
    img.setAttribute('href', person.photo); img.setAttribute('clip-path', 'circle(14px at 14px 14px)');
    g.appendChild(img);
  } else {
    const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    icon.setAttribute('x', CARD_W/2); icon.setAttribute('y', 24); icon.setAttribute('text-anchor', 'middle'); icon.setAttribute('font-size', '20');
    icon.textContent = person.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨';
    g.appendChild(icon);
  }
  
  // Ø§Ù„Ø§Ø³Ù…
  const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  name.setAttribute('x', CARD_W/2); name.setAttribute('y', 46); name.setAttribute('text-anchor', 'middle');
  name.setAttribute('fill', '#f8fafc'); name.setAttribute('font-size', '10'); name.setAttribute('font-weight', '600');
  name.textContent = person.name.length > 14 ? person.name.substring(0, 14) + '..' : person.name;
  g.appendChild(name);
  
  // Ø§Ù„Ø¹Ù…Ø±
  if (person.birthDate) {
    const age = calcAge(person.birthDate, person.deathDate);
    const ageText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    ageText.setAttribute('x', CARD_W/2); ageText.setAttribute('y', 58); ageText.setAttribute('text-anchor', 'middle');
    ageText.setAttribute('fill', '#94a3b8'); ageText.setAttribute('font-size', '8');
    ageText.textContent = age + (isArabic ? ' Ø³Ù†Ø©' : ' y') + (person.deathDate ? ' âœ' : '');
    g.appendChild(ageText);
  }
  
  // Ø²Ø± + Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
  const addBtnG = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  addBtnG.setAttribute('class', 'add-btn-internal');
  addBtnG.style.cursor = 'pointer';
  
  const addRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  addRect.setAttribute('x', CARD_W/2 - 14); addRect.setAttribute('y', CARD_H - 18);
  addRect.setAttribute('width', 28); addRect.setAttribute('height', 14);
  addRect.setAttribute('rx', 4);
  addRect.setAttribute('fill', '#1e293b');
  addRect.setAttribute('stroke', '#059669');
  addRect.setAttribute('stroke-width', '1.5');
  addBtnG.appendChild(addRect);
  
  const addText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  addText.setAttribute('x', CARD_W/2); addText.setAttribute('y', CARD_H - 8);
  addText.setAttribute('text-anchor', 'middle'); addText.setAttribute('fill', '#059669');
  addText.setAttribute('font-size', '11'); addText.setAttribute('font-weight', 'bold');
  addText.textContent = '+';
  addBtnG.appendChild(addText);
  
  addBtnG.addEventListener('click', e => {
    e.stopPropagation();
    showAddMenu(e, person.id, person._x + CARD_W/2, person._y + CARD_H);
  });
  
  addBtnG.addEventListener('mouseenter', () => {
    addRect.setAttribute('fill', '#059669');
    addText.setAttribute('fill', '#fff');
  });
  addBtnG.addEventListener('mouseleave', () => {
    addRect.setAttribute('fill', '#1e293b');
    addText.setAttribute('fill', '#059669');
  });
  
  g.appendChild(addBtnG);
  
  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
  g.addEventListener('click', e => {
    if (e.target.closest('.add-btn-internal')) return;
    e.stopPropagation();
    openEditPersonModal(person.id);
  });
  g.addEventListener('contextmenu', e => { e.preventDefault(); showCtxMenu(e, person.id); });
  g.addEventListener('dblclick', e => { e.stopPropagation(); openRelationsModal(person.id); });
  
  // Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
  g.setAttribute('draggable', 'true');
  g.addEventListener('mousedown', e => startDragCard(e, person.id));
  
  layer.appendChild(g);
}

function calcAge(birth, death) {
  const b = new Date(birth), e = death ? new Date(death) : new Date();
  let age = e.getFullYear() - b.getFullYear();
  if (e.getMonth() < b.getMonth() || (e.getMonth() === b.getMonth() && e.getDate() < b.getDate())) age--;
  return age;
}

// ========== ADD MENU ==========
function showAddMenu(e, personId, x, y) {
  hideAddMenu();
  const person = data.persons[personId];
  if (!person) return;
  
  const menu = document.getElementById('add-menu');
  const canvas = document.getElementById('tree-canvas');
  const rect = canvas.getBoundingClientRect();
  
  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ù€ zoom Ùˆ pan
  const screenX = rect.left + (x * zoom + panX);
  const screenY = rect.top + (y * zoom + panY);
  
  menu.style.left = screenX + 'px';
  menu.style.top = screenY + 'px';
  menu.dataset.personId = personId;
  menu.classList.add('show');
  
  e.stopPropagation();
}

function hideAddMenu() {
  document.getElementById('add-menu').classList.remove('show');
}

function addMenuAction(relationType) {
  const personId = document.getElementById('add-menu').dataset.personId;
  hideAddMenu();
  if (personId) openLinkModal(relationType, personId);
}

// ========== DRAG & DROP ==========
let dragState = {
  active: false,
  personId: null,
  startX: 0,
  startY: 0,
  ghost: null
};

function startDragCard(e, personId) {
  if (e.target.closest('.add-btn-internal')) return;
  if (e.button !== 0) return; // ÙÙ‚Ø· Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙŠØ³Ø±
  
  dragState.active = true;
  dragState.personId = personId;
  dragState.startX = e.clientX;
  dragState.startY = e.clientY;
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¨Ø­ Ù„Ù„Ø³Ø­Ø¨
  const person = data.persons[personId];
  const ghost = document.createElement('div');
  ghost.className = 'drag-ghost';
  ghost.innerHTML = `<span>${person.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨'}</span> ${person.name}`;
  ghost.style.left = e.clientX + 'px';
  ghost.style.top = e.clientY + 'px';
  document.body.appendChild(ghost);
  dragState.ghost = ghost;
  
  document.addEventListener('mousemove', onDragMove);
  document.addEventListener('mouseup', onDragEnd);
  
  e.preventDefault();
}

function onDragMove(e) {
  if (!dragState.active || !dragState.ghost) return;
  
  dragState.ghost.style.left = e.clientX + 'px';
  dragState.ghost.style.top = e.clientY + 'px';
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¥ÙÙ„Ø§Øª
  const canvas = document.getElementById('tree-canvas');
  const rect = canvas.getBoundingClientRect();
  
  // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØªØ­Øª Ø§Ù„Ù…Ø¤Ø´Ø±
  const cards = document.querySelectorAll('.person-card-group');
  let foundTarget = null;
  
  cards.forEach(card => {
    if (card.dataset.id === dragState.personId) return;
    
    const person = data.persons[card.dataset.id];
    if (!person) return;
    
    const cardX = rect.left + (person._x * zoom + panX);
    const cardY = rect.top + (person._y * zoom + panY);
    const cardW = CARD_W * zoom;
    const cardH = CARD_H * zoom;
    
    if (e.clientX >= cardX && e.clientX <= cardX + cardW &&
        e.clientY >= cardY && e.clientY <= cardY + cardH) {
      foundTarget = card.dataset.id;
      card.querySelector('rect').setAttribute('stroke', '#059669');
      card.querySelector('rect').setAttribute('stroke-width', '4');
    } else {
      const p = data.persons[card.dataset.id];
      card.querySelector('rect').setAttribute('stroke', p.gender === 'female' ? '#ec4899' : '#3b82f6');
      card.querySelector('rect').setAttribute('stroke-width', p.deathDate ? '2' : '2.5');
    }
  });
  
  dragState.targetId = foundTarget;
}

function onDragEnd(e) {
  document.removeEventListener('mousemove', onDragMove);
  document.removeEventListener('mouseup', onDragEnd);
  
  if (dragState.ghost) {
    dragState.ghost.remove();
    dragState.ghost = null;
  }
  
  // Ø¥Ø¹Ø§Ø¯Ø© Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
  document.querySelectorAll('.person-card-group').forEach(card => {
    const p = data.persons[card.dataset.id];
    if (p) {
      card.querySelector('rect').setAttribute('stroke', p.gender === 'female' ? '#ec4899' : '#3b82f6');
      card.querySelector('rect').setAttribute('stroke-width', p.deathDate ? '2' : '2.5');
    }
  });
  
  if (dragState.active && dragState.targetId && dragState.personId !== dragState.targetId) {
    showDropRelationModal(dragState.personId, dragState.targetId);
  }
  
  dragState.active = false;
  dragState.personId = null;
  dragState.targetId = null;
}

function showDropRelationModal(draggedId, targetId) {
  const dragged = data.persons[draggedId];
  const target = data.persons[targetId];
  if (!dragged || !target) return;
  
  // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©
  currentPersonId = draggedId;
  linkCallback = null;
  
  const modal = document.getElementById('drop-relation-modal');
  document.getElementById('drop-dragged-name').textContent = dragged.name;
  document.getElementById('drop-target-name').textContent = target.name;
  document.getElementById('drop-relation-modal').dataset.targetId = targetId;
  
  modal.classList.add('show');
}

function confirmDropRelation(relationType) {
  const draggedId = currentPersonId;
  const targetId = document.getElementById('drop-relation-modal').dataset.targetId;
  closeModal('drop-relation-modal');
  
  const dragged = data.persons[draggedId];
  const target = data.persons[targetId];
  if (!dragged || !target) return;
  
  switch (relationType) {
    case 'child-of': // Ø§Ù„Ù…Ø³Ø­ÙˆØ¨ ÙŠØµØ¨Ø­ Ø§Ø¨Ù† Ø§Ù„Ù‡Ø¯Ù
      if (target.gender === 'male') dragged.fatherId = targetId;
      else dragged.motherId = targetId;
      break;
    case 'parent-of': // Ø§Ù„Ù…Ø³Ø­ÙˆØ¨ ÙŠØµØ¨Ø­ Ø£Ø¨/Ø£Ù… Ø§Ù„Ù‡Ø¯Ù
      if (dragged.gender === 'male') target.fatherId = draggedId;
      else target.motherId = draggedId;
      break;
    case 'spouse-of': // Ø§Ù„Ù…Ø³Ø­ÙˆØ¨ ÙŠØµØ¨Ø­ Ø²ÙˆØ¬ Ø§Ù„Ù‡Ø¯Ù
      if (!dragged.marriages) dragged.marriages = [];
      if (!target.marriages) target.marriages = [];
      if (!dragged.marriages.find(m => m.spouseId === targetId)) {
        dragged.marriages.push({ spouseId: targetId, status: 'married', startYear: null, endYear: null });
      }
      if (!target.marriages.find(m => m.spouseId === draggedId)) {
        target.marriages.push({ spouseId: draggedId, status: 'married', startYear: null, endYear: null });
      }
      break;
    case 'sibling-of': // Ø§Ù„Ù…Ø³Ø­ÙˆØ¨ ÙŠØµØ¨Ø­ Ø£Ø® Ø§Ù„Ù‡Ø¯Ù
      dragged.fatherId = target.fatherId;
      dragged.motherId = target.motherId;
      break;
  }
  
  renderPersonsList();
  layoutTree();
  renderTree();
  updateStats();
  showToast(t('ØªÙ… Ø§Ù„Ø±Ø¨Ø·', 'Linked'));
}

function locateInTree(personId) {
  const person = data.persons[personId];
  if (!person || person._x === undefined) return;
  const canvas = document.getElementById('tree-canvas');
  panX = canvas.clientWidth / 2 - person._x - CARD_W / 2;
  panY = canvas.clientHeight / 2 - person._y - CARD_H / 2;
  zoom = 1;
  updateTransform();
  document.getElementById('zoom-level').textContent = '100%';
}

// ========== PAN & ZOOM ==========
function setupCanvas() {
  const canvas = document.getElementById('tree-canvas');
  const container = document.getElementById('canvas-container');
  
  canvas.addEventListener('mousedown', e => {
    if (e.target.closest('g[style*="cursor"]')) return;
    isDragging = true; dragStartX = e.clientX - panX; dragStartY = e.clientY - panY;
  });
  canvas.addEventListener('mousemove', e => { if (!isDragging) return; panX = e.clientX - dragStartX; panY = e.clientY - dragStartY; updateTransform(); });
  canvas.addEventListener('mouseup', () => isDragging = false);
  canvas.addEventListener('mouseleave', () => isDragging = false);
  
  container.addEventListener('wheel', e => {
    e.preventDefault();
    zoom = Math.max(0.3, Math.min(2, zoom + (e.deltaY > 0 ? -0.1 : 0.1)));
    updateTransform();
    document.getElementById('zoom-level').textContent = Math.round(zoom * 100) + '%';
  });
  
  let touchX, touchY;
  canvas.addEventListener('touchstart', e => { if (e.touches.length === 1) { touchX = e.touches[0].clientX - panX; touchY = e.touches[0].clientY - panY; } }, { passive: true });
  canvas.addEventListener('touchmove', e => { if (e.touches.length === 1) { panX = e.touches[0].clientX - touchX; panY = e.touches[0].clientY - touchY; updateTransform(); } }, { passive: true });
}

function zoomIn() { zoom = Math.min(2, zoom + 0.1); updateTransform(); document.getElementById('zoom-level').textContent = Math.round(zoom * 100) + '%'; }
function zoomOut() { zoom = Math.max(0.3, zoom - 0.1); updateTransform(); document.getElementById('zoom-level').textContent = Math.round(zoom * 100) + '%'; }
function fitToScreen() { zoom = 1; panX = 0; panY = 0; updateTransform(); document.getElementById('zoom-level').textContent = '100%'; }
function updateTransform() { document.getElementById('tree-content').setAttribute('transform', `translate(${panX}, ${panY}) scale(${zoom})`); }

// ========== STATS ==========
function updateStats() {
  const persons = Object.values(data.persons);
  document.getElementById('stat-total').textContent = persons.length;
  document.getElementById('stat-males').textContent = persons.filter(p => p.gender === 'male').length;
  document.getElementById('stat-females').textContent = persons.filter(p => p.gender === 'female').length;
  document.getElementById('stat-generations').textContent = new Set(persons.map(p => p._level).filter(l => l !== undefined)).size || 0;
}

// ========== SAVE/LOAD ==========
function saveToLocal() { localStorage.setItem('familyTreeV3', JSON.stringify(data)); showToast(t('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'Saved')); }
function loadFromLocal() {
  const saved = localStorage.getItem('familyTreeV3');
  if (saved) { data = JSON.parse(saved); renderPersonsList(); layoutTree(); renderTree(); updateStats(); showToast(t('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„', 'Loaded')); }
  else showToast(t('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'No data'));
}

function exportAsJSON() { download(JSON.stringify(data, null, 2), 'family-tree.json', 'application/json'); }
function handleImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try { data = JSON.parse(ev.target.result); renderPersonsList(); layoutTree(); renderTree(); updateStats(); showToast(t('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'Imported')); }
    catch { showToast(t('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­', 'Invalid file')); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function exportAsPNG() {
  const svg = document.getElementById('tree-canvas');
  const svgData = new XMLSerializer().serializeToString(svg);
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  const img = new Image();
  canvas.width = svg.clientWidth * 2; canvas.height = svg.clientHeight * 2;
  img.onload = () => {
    ctx.fillStyle = '#0f172a'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    const a = document.createElement('a'); a.download = 'family-tree.png'; a.href = canvas.toDataURL('image/png'); a.click();
  };
  img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
}

function exportAsSVG() { download(new XMLSerializer().serializeToString(document.getElementById('tree-canvas')), 'family-tree.svg', 'image/svg+xml'); }

function download(content, filename, type) {
  const blob = new Blob([content], { type });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
}

function clearAll() {
  if (!confirm(t('Ù…Ø³Ø­ Ø§Ù„Ø´Ø¬Ø±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ', 'Clear entire tree?'))) return;
  data = { persons: {}, rootId: null };
  renderPersonsList(); renderTree(); updateStats(); showToast(t('ØªÙ… Ø§Ù„Ù…Ø³Ø­', 'Cleared'));
}

// ========== UTILS ==========
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
function toggleDropdown(id) { document.getElementById(id).classList.toggle('open'); }

init();
</script>

<script>
  window.toolsData = [{"id":"percentage","icon":"ğŸ”¢","name":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©","keywords":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©ØŒ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø©ØŒ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…ØŒ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®ØµÙ…ØŒ percentage calculator","searchTerms":"Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ù†Ø³Ø¨ Ù…Ø¦ÙˆÙŠÙ‡ Ø¨Ø§Ù„Ù…ÙŠØ© Ø¨Ø§Ù„Ù…ÙŠÙ‡ Ø¨Ø§Ù„Ù…Ø¦Ø© Ø¨Ø§Ù„Ù…Ø¦Ù‡ Ø§Ù„Ù…Ø¦ÙˆÙŠÙ‡ Ø®ØµÙ… Ø§Ù„Ø®ØµÙ… ØªØ®ÙÙŠØ¶ Ø§Ù„ØªØ®ÙÙŠØ¶ Ø­Ø³Ù… Ø§Ù„Ø­Ø³Ù… Ø³Ø¹Ø± Ø§Ù„Ø³Ø¹Ø± Ø§ÙˆÙ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±Ø¶ ØªÙ†Ø²ÙŠÙ„Ø§Øª Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ù†Ù‚ØµØ§Ù† Ø§Ù„Ù†Ù‚ØµØ§Ù† ÙØ±Ù‚ Ø§Ù„ÙØ±Ù‚ Ø±Ø¨Ø¹ Ø§Ù„Ø±Ø¨Ø¹ Ù†Øµ Ø§Ù„Ù†Øµ Ø«Ù„Ø« Ø§Ù„Ø«Ù„Ø« percent percentage Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø±Ø¨Ø­ Ø§Ù„Ø±Ø¨Ø­ Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¶Ø±Ø§ÙŠØ¨ Ù‡Ø§Ù…Ø´ Ø§Ù„Ù‡Ø§Ù…Ø´ ÙƒØ³Ø± Ø§Ù„ÙƒØ³Ø± ÙƒØ³ÙˆØ± Ù‚Ø¨Ù„ Ø¨Ø¹Ø¯ Ø§ØµÙ„ÙŠ Ø§Ù„Ø§ØµÙ„ÙŠ Ø§ØµÙ„ Ø§Ù„Ø§ØµÙ„ ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙƒÙ„ÙØ© Ø¨ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ¹ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¬Ø²Ø¡ Ø§Ù„Ø¬Ø²Ø¡ ÙƒÙ„ Ø§Ù„ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹","category":"calculators","categoryName":"Ø­Ø§Ø³Ø¨Ø§Øª","url":"../../ar/tools/percentage.html"},{"id":"interest-calculator","icon":"ğŸ’°","name":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ§Ø¦Ø¯","keywords":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ§Ø¦Ø¯ØŒ ÙØ§Ø¦Ø¯Ø© Ø¨Ø³ÙŠØ·Ø©ØŒ ÙØ§Ø¦Ø¯Ø© Ù…Ø±ÙƒØ¨Ø©ØŒ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚Ø±Ø¶ØŒ interest calculator","searchTerms":"ÙØ§Ø¦Ø¯Ø© Ø§Ù„ÙØ§Ø¦Ø¯Ø© ÙÙˆØ§Ø¦Ø¯ Ø§Ù„ÙÙˆØ§Ø¦Ø¯ ÙØ§ÙŠØ¯Ø© Ø§Ù„ÙØ§ÙŠØ¯Ø© ÙÙˆØ§ÙŠØ¯ Ø¨Ø³ÙŠØ·Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ù…Ø±ÙƒØ¨Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ù…Ø±ÙƒØ¨Ù‡ Ù‚Ø±Ø¶ Ø§Ù„Ù‚Ø±Ø¶ Ù‚Ø±ÙˆØ¶ Ø§Ù„Ù‚Ø±ÙˆØ¶ Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø¹ÙˆØ§Ø¦Ø¯ Ø§Ù„Ø¹ÙˆØ§Ø¦Ø¯ Ø±Ø¨Ø­ Ø§Ù„Ø±Ø¨Ø­ Ø¨Ù†Ùƒ Ø§Ù„Ø¨Ù†Ùƒ Ø¨Ù†ÙˆÙƒ Ø§Ù„Ø¨Ù†ÙˆÙƒ Ù…Ø§Ù„ Ø§Ù„Ù…Ø§Ù„ Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙÙ„ÙˆØ³ Ø§Ù„ÙÙ„ÙˆØ³ Ø±Ø§Ø³ Ø±Ø£Ø³ Ø±Ø£Ø³Ù…Ø§Ù„ Ø³Ù†ÙˆÙŠ Ø§Ù„Ø³Ù†ÙˆÙŠ Ø´Ù‡Ø±ÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙŠÙˆÙ…ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø±Ø¨Ø¹ÙŠ Ù†ØµÙ ØªØ±Ø§ÙƒÙ… Ø§Ù„ØªØ±Ø§ÙƒÙ… ØªØ±Ø§ÙƒÙ…ÙŠ Ø±ØµÙŠØ¯ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¨Ù„Øº Ø§ØµÙ„ÙŠ Ø§Ù„Ø§ØµÙ„ÙŠ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ø­Ø³Ø¨ interest loan compound simple bank money investment","category":"calculators","categoryName":"Ø­Ø§Ø³Ø¨Ø§Øª","url":"../../ar/tools/interest-calculator.html"},{"id":"loan-calculator","icon":"ğŸ¦","name":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚Ø±ÙˆØ¶","keywords":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚Ø±ÙˆØ¶ØŒ Ù‚Ø³Ø· Ø´Ù‡Ø±ÙŠØŒ Ø¬Ø¯ÙˆÙ„ Ø³Ø¯Ø§Ø¯ØŒ ÙØ§Ø¦Ø¯Ø© Ø§Ù„Ù‚Ø±Ø¶ØŒ loan calculator","searchTerms":"Ù‚Ø±Ø¶ Ø§Ù„Ù‚Ø±Ø¶ Ù‚Ø±ÙˆØ¶ Ø§Ù„Ù‚Ø±ÙˆØ¶ ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø¨Ù†Ùƒ Ø§Ù„Ø¨Ù†Ùƒ Ø¨Ù†ÙˆÙƒ Ù‚Ø³Ø· Ø§Ù„Ù‚Ø³Ø· Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø´Ù‡Ø±ÙŠ Ø³Ø¯Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ ÙØ§Ø¦Ø¯Ø© ÙÙˆØ§Ø¦Ø¯ ØªÙ‚Ø³ÙŠØ· Ø³ÙŠØ§Ø±Ø© Ù…Ù†Ø²Ù„ Ø¹Ù‚Ø§Ø± Ø´Ø®ØµÙŠ loan payment installment bank mortgage","category":"calculators","categoryName":"Ø­Ø§Ø³Ø¨Ø§Øª","url":"../../ar/tools/loan-calculator.html"},{"id":"body-calculator","icon":"âš–ï¸","name":"Ø­Ø§Ø³Ø¨Ø© ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù…","keywords":"Ø­Ø§Ø³Ø¨Ø© BMIØŒ Ù…Ø¤Ø´Ø± ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù…ØŒ Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØŒ Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©ØŒ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†","searchTerms":"ÙˆØ²Ù† Ø§Ù„ÙˆØ²Ù† ÙƒØªÙ„Ø© Ø§Ù„ÙƒØªÙ„Ø© Ø¬Ø³Ù… Ø§Ù„Ø¬Ø³Ù… bmi Ø¨ÙŠ Ø§Ù… Ø§ÙŠ Ù…Ø¤Ø´Ø± Ø³Ù…Ù†Ø© Ø§Ù„Ø³Ù…Ù†Ø© Ù†Ø­Ø§ÙØ© Ø¯Ù‡ÙˆÙ† Ø§Ù„Ø¯Ù‡ÙˆÙ† Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø­Ø±Ø§Ø±ÙŠØ© Ø§ÙŠØ¶ Ø§Ù„Ø§ÙŠØ¶ Ù…Ø«Ø§Ù„ÙŠ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ Ø·ÙˆÙ„ Ø§Ù„Ø·ÙˆÙ„ Ø®ØµØ± Ø§Ù„Ø®ØµØ± ÙˆØ±Ùƒ body mass index weight fat calories ideal","category":"calculators","categoryName":"Ø­Ø§Ø³Ø¨Ø§Øª","url":"../../ar/tools/body-calculator.html"},{"id":"age-calculator","icon":"ğŸ‚","name":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…Ø±","keywords":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…Ø±ØŒ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø±ØŒ ÙƒÙ… Ø¹Ù…Ø±ÙŠØŒ Ø§Ù„Ø¨Ø±Ø¬ Ø§Ù„ÙÙ„ÙƒÙŠØŒ Ø¹ÙŠØ¯ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯","searchTerms":"Ø¹Ù…Ø± Ø§Ù„Ø¹Ù…Ø± Ø¹Ù…Ø±ÙŠ Ø³Ù† Ø§Ù„Ø³Ù† ÙƒÙ… Ù…ÙŠÙ„Ø§Ø¯ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ØªØ§Ø±ÙŠØ® Ø¨Ø±Ø¬ Ø§Ù„Ø¨Ø±Ø¬ Ø§Ø¨Ø±Ø§Ø¬ ÙÙ„ÙƒÙŠ Ø²ÙˆØ¯ÙŠØ§Ùƒ Ø³Ù†Ø© Ø´Ù‡Ø± ÙŠÙˆÙ… age birthday birth date zodiac calculate how old","category":"calculators","categoryName":"Ø­Ø§Ø³Ø¨Ø§Øª","url":"../../ar/tools/age-calculator.html"},{"id":"family-tree","icon":"ğŸŒ³","name":"Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©","keywords":"Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©ØŒ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„Ø©ØŒ Ù†Ø³Ø¨ØŒ Ø³Ù„Ø§Ù„Ø©ØŒ Ø£Ù†Ø³Ø§Ø¨ØŒ Ø¹Ù„Ø§Ù‚Ø§Øª Ø¹Ø§Ø¦Ù„ÙŠØ©ØŒ family tree","searchTerms":"Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„Ø© Ø¹Ø§Ø¦Ù„Ù‡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ù‡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ù†Ø³Ø¨ Ø£Ù†Ø³Ø§Ø¨ Ø§Ù„Ø£Ù†Ø³Ø§Ø¨ Ø³Ù„Ø§Ù„Ø© Ø¬Ø¯ Ø¬Ø¯Ø© Ø£Ø¨ Ø£Ù… Ø§Ø¨Ù† Ø§Ø¨Ù†Ø© Ø£Ø® Ø£Ø®Øª Ø¹Ù… Ø¹Ù…Ø© Ø®Ø§Ù„ Ø®Ø§Ù„Ø© Ù‚Ø±Ø§Ø¨Ø© Ù‚Ø±ÙŠØ¨ Ø£Ù‚Ø§Ø±Ø¨ Ø§Ù„Ø£Ù‚Ø§Ø±Ø¨ Ù†Ø³Ù„ Ø°Ø±ÙŠØ© family tree genealogy","category":"everyday","categoryName":"Ø£Ø¯ÙˆØ§Øª ÙŠÙˆÙ…ÙŠØ©","url":"../../ar/tools/family-tree.html"}];
</script>
      </main>
      
      <footer class="main-footer">
        <p>ØµÙÙ†Ø¹ Ø¨Ù€ â¤ï¸ | Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2026 Ø¹ÙØ¯Ù‘Ø©</p>
      </footer>
    </div>
  </div>
  
  <!-- Settings Panel -->
  <div class="settings-overlay"></div>
  <div class="settings-panel">
    <div class="settings-header">
      <h2 class="settings-title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
      <button class="settings-close" aria-label="Close">âœ•</button>
    </div>
    <div class="settings-content">
      <div class="settings-section">
        <div class="settings-section-title">Ø§Ù„Ù„ØºØ©</div>
        <div class="settings-option">
          <button class="settings-btn active" data-lang-btn="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
          <button class="settings-btn " data-lang-btn="en">English</button>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Ø§Ù„Ù…Ø¸Ù‡Ø±</div>
        <div class="settings-option">
          <button class="settings-btn" data-theme-btn="light">â˜€ï¸ ÙØ§ØªØ­</button>
          <button class="settings-btn" data-theme-btn="dark">ğŸŒ™ Ø¯Ø§ÙƒÙ†</button>
          <button class="settings-btn active" data-theme-btn="auto">ğŸ’» ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
        </div>
      </div>
      <div class="settings-section">
        <button class="settings-btn" data-clear-data style="width:100%;justify-content:center;color:var(--error);">
          ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        </button>
      </div>
    </div>
  </div>
  
  <div class="toast"></div>
  <script src="../../assets/js/app.js"></script>
</body>
</html>