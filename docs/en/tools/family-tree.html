<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Family Tree - Create Your Family Tree Free | Udda</title>
  <meta name="description" content="Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.">
  <meta name="keywords" content="family tree, genealogy, ancestry, lineage, family relationships, family tree maker">
  <meta name="author" content="Udda">
  <meta name="robots" content="index, follow">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="Family Tree - Create Your Family Tree Free | Udda">
  <meta property="og:description" content="Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.">
  <meta property="og:url" content="https://udda.tools/en/tools/family-tree.html">
  <meta property="og:site_name" content="Udda">
  <meta property="og:locale" content="en_US">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Family Tree - Create Your Family Tree Free | Udda">
  <meta name="twitter:description" content="Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.">
  
  <link rel="alternate" hreflang="ar" href="https://udda.tools/ar/tools/family-tree.html">
  <link rel="alternate" hreflang="en" href="https://udda.tools/en/tools/family-tree.html">
  <link rel="alternate" hreflang="x-default" href="https://udda.tools/ar/tools/family-tree.html">
  <link rel="canonical" href="https://udda.tools/en/tools/family-tree.html">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/main.css">
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Family Tree",
    "description": "Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.",
    "url": "https://udda.tools/en/tools/family-tree.html",
    "applicationCategory": "UtilityApplication",
    "operatingSystem": "Any",
    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
    "inLanguage": ["ar", "en"],
    "isAccessibleForFree": true
  }
  </script>
</head>
<body data-tool-id="family-tree">
  <div class="app-container">
    <div class="sidebar-overlay"></div>
    
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="../../en/" class="logo">
          <div class="logo-icon">ğŸ”§</div>
          <span class="logo-text sidebar-text">Udda</span>
        </a>
      </div>
      
      <div class="sidebar-search">
        <div class="search-input-wrapper">
          <input type="text" class="search-input" placeholder="Search for a tool..." aria-label="Search for a tool...">
          <svg class="search-icon" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        
        <a href="../../en/" class="nav-item ">
          <span class="nav-item-icon">ğŸ </span>
          <span class="sidebar-text">Home</span>
        </a>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ§®</span>
              <span class="sidebar-text">Calculators</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
            <a href="../../en/tools/percentage.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ”¢</span>
              <span class="sidebar-text">Percentage Calculator</span>
            </a>
            <a href="../../en/tools/interest-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ’°</span>
              <span class="sidebar-text">Interest Calculator</span>
            </a>
            <a href="../../en/tools/loan-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ¦</span>
              <span class="sidebar-text">Loan Calculator</span>
            </a>
            <a href="../../en/tools/body-calculator.html" class="nav-item ">
              <span class="nav-item-icon">âš–ï¸</span>
              <span class="sidebar-text">Body Calculator</span>
            </a>
            <a href="../../en/tools/age-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ‚</span>
              <span class="sidebar-text">Age Calculator</span>
            </a>
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ”„</span>
              <span class="sidebar-text">Converters</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ“</span>
              <span class="sidebar-text">Text Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ“…</span>
              <span class="sidebar-text">Date & Time</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">âš¡</span>
              <span class="sidebar-text">Generators</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ–¼ï¸</span>
              <span class="sidebar-text">Image Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ’»</span>
              <span class="sidebar-text">Developer Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section open">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ </span>
              <span class="sidebar-text">Everyday Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
            <a href="../../en/tools/family-tree.html" class="nav-item active">
              <span class="nav-item-icon">ğŸŒ³</span>
              <span class="sidebar-text">Family Tree</span>
            </a>
          </div>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <button class="sidebar-toggle" aria-label="Toggle sidebar">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
          </svg>
          <span class="sidebar-text">Sidebar</span>
        </button>
      </div>
    </aside>
    
    <div class="main-content">
      <header class="main-header">
        <button class="header-btn mobile-menu-btn" aria-label="Menu">
          <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        
        <nav class="header-breadcrumb">
          <a href="../../en/" class="breadcrumb-link">Home</a>
          <span class="breadcrumb-separator">â€º</span>
          <a href="../../en/category/everyday.html" class="breadcrumb-link">Everyday Tools</a>
          <span class="breadcrumb-separator">â€º</span>
          <span class="breadcrumb-current">Family Tree</span>
        </nav>
        
        <div class="header-actions">
          <button class="header-btn" data-favorite-btn aria-label="Add to Favorites">â˜†</button>
          <button class="header-btn" onclick="App.shareUrl('Family Tree')" aria-label="Share">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
              <polyline points="16 6 12 2 8 6"></polyline>
              <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg>
          </button>
          <button class="header-btn" data-open-settings aria-label="Settings">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </button>
        </div>
      </header>
      
      <main class="page-content">
        <style>
:root {
  --primary: #059669;
  --primary-dark: #047857;
  --male-color: #3b82f6;
  --female-color: #ec4899;
  --marriage-color: #f59e0b;
  --divorced-color: #6b7280;
  --widowed-color: #4b5563;
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --bg-card: #334155;
  --text-primary: #f8fafc;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border-color: #475569;
  --danger: #ef4444;
}

* { box-sizing: border-box; }

.family-tree-app {
  display: flex;
  gap: 12px;
  min-height: 75vh;
  font-family: inherit;
}

/* Sidebar */
.sidebar {
  width: 240px;
  background: var(--bg-secondary);
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  flex-shrink: 0;
}

.sidebar-header {
  padding: 12px 14px;
  border-bottom: 2px solid var(--border-color);
}

.sidebar-header h3 {
  font-size: 0.9rem;
  color: var(--text-primary);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 6px;
}

.sidebar-header .count {
  background: var(--primary);
  color: white;
  padding: 2px 7px;
  border-radius: 10px;
  font-size: 0.7rem;
}

.sidebar-search {
  padding: 8px 10px;
  border-bottom: 1px solid var(--border-color);
}

.sidebar-search input {
  width: 100%;
  padding: 7px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 0.8rem;
  font-family: inherit;
}

.sidebar-search input:focus { outline: none; border-color: var(--primary); }

.sidebar-list { flex: 1; overflow-y: auto; padding: 6px; }

.list-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 7px 8px;
  background: var(--bg-card);
  border-radius: 6px;
  margin-bottom: 4px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
}

.list-item:hover { border-color: var(--primary); }
.list-item.orphan { border: 2px dashed var(--divorced-color); }

.list-item .icon {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
  flex-shrink: 0;
}

.list-item .icon.male { background: rgba(59, 130, 246, 0.2); }
.list-item .icon.female { background: rgba(236, 72, 153, 0.2); }
.list-item .icon img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

.list-item .info { flex: 1; min-width: 0; }
.list-item .name { font-size: 0.75rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.list-item .sub { font-size: 0.65rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.list-item .menu-btn {
  padding: 2px 5px;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 0.85rem;
  border-radius: 3px;
}

.list-item .menu-btn:hover { background: var(--bg-secondary); color: var(--text-primary); }

.section-label {
  font-size: 0.65rem;
  color: var(--text-muted);
  padding: 6px 8px 4px;
  border-top: 1px solid var(--border-color);
  margin-top: 4px;
}

.add-btn {
  margin: 8px;
  padding: 9px;
  background: var(--primary);
  border: none;
  border-radius: 6px;
  color: white;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-family: inherit;
  font-size: 0.85rem;
}

.add-btn:hover { background: var(--primary-dark); }

/* Main */
.main-area { flex: 1; display: flex; flex-direction: column; min-width: 0; }

/* Toolbar */
.toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  padding: 8px 12px;
  background: var(--bg-secondary);
  border-radius: 8px;
  margin-bottom: 8px;
}

.toolbar-group {
  display: flex;
  gap: 3px;
  padding: 0 8px;
  border-right: 2px solid var(--border-color);
}

.toolbar-group:last-child { border-right: none; }

.tool-btn {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 5px;
  color: var(--text-primary);
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.2s;
}

.tool-btn:hover { border-color: var(--primary); }
.tool-btn .icon { font-size: 0.9rem; }

/* Canvas */
.canvas-wrap {
  flex: 1;
  position: relative;
  background: var(--bg-secondary);
  border-radius: 8px;
  overflow: hidden;
  min-height: 400px;
  border: 2px solid var(--border-color);
}

.tree-svg { width: 100%; height: 100%; min-height: 400px; cursor: grab; }
.tree-svg:active { cursor: grabbing; }
.tree-svg text { font-family: inherit; }

.empty-msg {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  color: var(--text-muted);
  pointer-events: none;
}

.empty-msg .icon { font-size: 2.5rem; margin-bottom: 8px; opacity: 0.5; }
.empty-msg h3 { margin: 0 0 4px; color: var(--text-secondary); }

/* Zoom */
.zoom-panel {
  position: absolute;
  bottom: 12px;
  right: 12px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  background: var(--bg-card);
  padding: 4px;
  border-radius: 6px;
  border: 2px solid var(--border-color);
}

.zoom-btn {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-secondary);
  border: none;
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 0.9rem;
  cursor: pointer;
}

.zoom-btn:hover { background: var(--primary); }
.zoom-level { text-align: center; font-size: 0.65rem; color: var(--text-muted); }

/* Stats */
.stats-bar {
  display: flex;
  gap: 12px;
  padding: 7px 12px;
  background: var(--bg-card);
  border-radius: 6px;
  margin-top: 8px;
  flex-wrap: wrap;
}

.stat { display: flex; align-items: center; gap: 4px; font-size: 0.75rem; }
.stat .label { color: var(--text-muted); }
.stat .val { font-weight: 700; color: var(--text-primary); }

/* Modal */
.modal-bg {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.modal-bg.show { opacity: 1; visibility: visible; }

.modal {
  background: var(--bg-secondary);
  border-radius: 12px;
  width: 90%;
  max-width: 420px;
  max-height: 85vh;
  overflow-y: auto;
  transform: scale(0.9);
  transition: transform 0.3s;
}

.modal-bg.show .modal { transform: scale(1); }

.modal-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 2px solid var(--border-color);
  position: sticky;
  top: 0;
  background: var(--bg-secondary);
  z-index: 10;
}

.modal-head h2 { font-size: 0.95rem; color: var(--text-primary); display: flex; align-items: center; gap: 6px; margin: 0; }

.modal-close {
  background: none;
  border: none;
  font-size: 1.2rem;
  color: var(--text-muted);
  cursor: pointer;
  padding: 3px 6px;
  border-radius: 4px;
}

.modal-close:hover { background: var(--bg-card); color: var(--text-primary); }

.modal-body { padding: 14px 16px; }

.form-group { margin-bottom: 12px; }
.form-group label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 8px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 0.85rem;
  font-family: inherit;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus { outline: none; border-color: var(--primary); }

.form-row { display: flex; gap: 10px; }
.form-row .form-group { flex: 1; }

/* Gender Toggle */
.gender-toggle { display: flex; gap: 6px; }

.gender-opt {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 9px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}

.gender-opt input { display: none; }
.gender-opt.male:has(input:checked) { border-color: var(--male-color); background: rgba(59,130,246,0.2); }
.gender-opt.female:has(input:checked) { border-color: var(--female-color); background: rgba(236,72,153,0.2); }
.gender-opt span { font-weight: 600; font-size: 0.8rem; }

/* Photo */
.photo-row { display: flex; align-items: center; gap: 10px; }

.photo-preview {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.photo-preview img { width: 100%; height: 100%; object-fit: cover; }
.photo-preview .ph { font-size: 1.3rem; color: var(--text-muted); }

.photo-btns { display: flex; flex-direction: column; gap: 4px; }

.photo-btn {
  padding: 4px 8px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 0.7rem;
  cursor: pointer;
  font-family: inherit;
}

.photo-btn:hover { border-color: var(--primary); }
.photo-btn.rm { border-color: var(--danger); color: var(--danger); }

/* Person Select */
.person-select {
  border: 2px solid var(--border-color);
  border-radius: 6px;
  overflow: hidden;
}

.person-select-search {
  width: 100%;
  padding: 7px 10px;
  background: var(--bg-card);
  border: none;
  border-bottom: 1px solid var(--border-color);
  color: var(--text-primary);
  font-size: 0.8rem;
  font-family: inherit;
}

.person-select-search:focus { outline: none; }

.person-select-list { max-height: 150px; overflow-y: auto; }

.person-select-opt {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  cursor: pointer;
  border: 2px solid transparent;
  margin: 3px;
  border-radius: 5px;
}

.person-select-opt:hover { background: var(--bg-card); }
.person-select-opt.selected { border-color: var(--primary); background: rgba(5,150,105,0.15); }
.person-select-opt.none { color: var(--text-muted); border: 2px dashed var(--border-color); justify-content: center; font-size: 0.8rem; }

.person-select-opt .av { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; }
.person-select-opt .nm { font-size: 0.8rem; color: var(--text-primary); }

/* Status Options */
.status-opts { display: flex; gap: 6px; }

.status-opt {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  padding: 8px 5px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}

.status-opt input { display: none; }
.status-opt:has(input:checked) { border-color: var(--primary); background: rgba(5,150,105,0.15); }
.status-opt .ic { font-size: 1.1rem; }
.status-opt .tx { font-size: 0.7rem; color: var(--text-secondary); }

/* Modal Footer */
.modal-foot {
  display: flex;
  gap: 6px;
  padding: 10px 16px;
  border-top: 2px solid var(--border-color);
  position: sticky;
  bottom: 0;
  background: var(--bg-secondary);
}

.modal-foot button {
  flex: 1;
  padding: 9px;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
}

.btn-cancel { background: var(--bg-card); border: 2px solid var(--border-color); color: var(--text-primary); }
.btn-save { background: var(--primary); border: none; color: white; }
.btn-save:hover { background: var(--primary-dark); }
.btn-del { background: var(--danger); border: none; color: white; flex: 0.4; }

/* Tabs */
.tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 12px; }

.tab {
  flex: 1;
  padding: 8px;
  background: none;
  border: none;
  color: var(--text-muted);
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  font-size: 0.8rem;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
}

.tab.active { color: var(--primary); border-bottom-color: var(--primary); }

/* Context Menu */
.ctx-menu {
  position: fixed;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  min-width: 140px;
  z-index: 2000;
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  display: none;
}

.ctx-menu.show { display: block; }

.ctx-item {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 8px 12px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.8rem;
}

.ctx-item:first-child { border-radius: 6px 6px 0 0; }
.ctx-item:last-child { border-radius: 0 0 6px 6px; }
.ctx-item:hover { background: var(--bg-secondary); }
.ctx-item.danger { color: var(--danger); }

.ctx-divider { height: 1px; background: var(--border-color); margin: 2px 0; }

/* Add Menu */
.add-menu {
  position: fixed;
  background: var(--bg-card);
  border: 2px solid var(--primary);
  border-radius: 8px;
  min-width: 150px;
  z-index: 2000;
  box-shadow: 0 6px 20px rgba(0,0,0,0.4);
  display: none;
  transform: translate(-50%, 4px);
}

.add-menu.show { display: block; }

.add-menu-item {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 9px 12px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 500;
}

.add-menu-item:first-child { border-radius: 6px 6px 0 0; }
.add-menu-item:last-child { border-radius: 0 0 6px 6px; }
.add-menu-item:hover { background: var(--primary); }

/* Toast */
.toast {
  position: fixed;
  bottom: 18px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--bg-card);
  border: 2px solid var(--primary);
  padding: 10px 16px;
  border-radius: 6px;
  color: var(--text-primary);
  font-weight: 600;
  z-index: 3000;
  opacity: 0;
  transition: all 0.3s;
}

.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* Dropdown */
.dropdown { position: relative; }

.dropdown-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 4px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  min-width: 120px;
  z-index: 100;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-5px);
  transition: all 0.2s;
}

.dropdown.open .dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }

.dropdown-item { display: flex; align-items: center; gap: 6px; padding: 7px 10px; color: var(--text-primary); font-size: 0.75rem; cursor: pointer; }
.dropdown-item:hover { background: var(--bg-secondary); }

.dropdown-divider { height: 1px; background: var(--border-color); margin: 2px 0; }

.hidden { display: none; }

@media (max-width: 800px) {
  .family-tree-app { flex-direction: column; }
  .sidebar { width: 100%; max-height: 200px; }
  .tool-btn span:not(.icon) { display: none; }
}
</style>

<div class="tool-card">
  <div class="tool-header">
    <div class="tool-icon">ğŸŒ³</div>
    <div>
      <h1 class="tool-title">Family Tree</h1>
      <p class="tool-description">Create your family tree easily and export it</p>
    </div>
  </div>

  <div class="family-tree-app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h3>ğŸ“‹ <span id="txt-persons">Ø§Ù„Ø£Ø´Ø®Ø§Øµ</span> <span class="count" id="persons-count">0</span></h3>
      </div>
      <div class="sidebar-search">
        <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø«...">
      </div>
      <div class="sidebar-list" id="persons-list"></div>
      <button class="add-btn" onclick="openPersonModal()">â• <span id="txt-add">Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</span></button>
    </aside>

    <main class="main-area">
      <div class="toolbar">
        <div class="toolbar-group">
          <button class="tool-btn" onclick="saveLocal()"><span class="icon">ğŸ’¾</span><span>Save Locally</span></button>
          <button class="tool-btn" onclick="loadLocal()"><span class="icon">ğŸ“‚</span><span>Load Saved</span></button>
        </div>
        <div class="toolbar-group">
          <div class="dropdown" id="export-dd">
            <button class="tool-btn" onclick="toggleDD('export-dd')"><span class="icon">ğŸ“¤</span><span>Export</span></button>
            <div class="dropdown-menu">
              <div class="dropdown-item" onclick="exportPNG()">ğŸ–¼ï¸ PNG</div>
              <div class="dropdown-item" onclick="exportSVG()">ğŸ“ SVG</div>
              <div class="dropdown-divider"></div>
              <div class="dropdown-item" onclick="exportJSON()">ğŸ“„ JSON</div>
            </div>
          </div>
          <button class="tool-btn" onclick="document.getElementById('import-file').click()"><span class="icon">ğŸ“¥</span><span>Import</span></button>
        </div>
        <div class="toolbar-group">
          <button class="tool-btn" onclick="clearAll()"><span class="icon">ğŸ—‘ï¸</span><span>Clear All</span></button>
        </div>
      </div>

      <div class="canvas-wrap" id="canvas-wrap">
        <svg class="tree-svg" id="tree-svg">
          <defs>
            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.2"/>
            </filter>
          </defs>
          <g id="tree-g">
            <g id="lines-layer"></g>
            <g id="cards-layer"></g>
          </g>
        </svg>
        <div class="empty-msg" id="empty-msg">
          <div class="icon">ğŸŒ³</div>
          <h3 id="txt-empty">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</h3>
        </div>
        <div class="zoom-panel">
          <button class="zoom-btn" onclick="zoomIn()">â•</button>
          <div class="zoom-level" id="zoom-level">100%</div>
          <button class="zoom-btn" onclick="zoomOut()">â–</button>
          <button class="zoom-btn" onclick="fitView()">âŠ¡</button>
        </div>
      </div>

      <div class="stats-bar">
        <div class="stat"><span class="label">ğŸ‘¥</span><span class="val" id="stat-total">0</span></div>
        <div class="stat"><span class="label">ğŸ‘¨</span><span class="val" id="stat-males">0</span></div>
        <div class="stat"><span class="label">ğŸ‘©</span><span class="val" id="stat-females">0</span></div>
        <div class="stat"><span class="label">ğŸ’‘</span><span class="val" id="stat-marriages">0</span></div>
        <div class="stat"><span class="label">ğŸ“Š</span><span class="val" id="stat-gens">0</span></div>
      </div>
    </main>
  </div>
</div>

<!-- Person Modal -->
<div class="modal-bg" id="person-modal">
  <div class="modal">
    <div class="modal-head">
      <h2 id="pm-title">ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</h2>
      <button class="modal-close" onclick="closeModal('person-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label id="lbl-name">Ø§Ù„Ø§Ø³Ù… *</label>
        <input type="text" id="p-name">
      </div>
      <div class="form-group">
        <label id="lbl-gender">Ø§Ù„Ø¬Ù†Ø³</label>
        <div class="gender-toggle">
          <label class="gender-opt male"><input type="radio" name="p-gender" value="male" checked><span>ğŸ‘¨ <span id="lbl-male">Ø°ÙƒØ±</span></span></label>
          <label class="gender-opt female"><input type="radio" name="p-gender" value="female"><span>ğŸ‘© <span id="lbl-female">Ø£Ù†Ø«Ù‰</span></span></label>
        </div>
      </div>
      <div class="form-group">
        <label id="lbl-photo">Ø§Ù„ØµÙˆØ±Ø©</label>
        <div class="photo-row">
          <div class="photo-preview" id="photo-prev"><span class="ph">ğŸ‘¤</span></div>
          <div class="photo-btns">
            <button type="button" class="photo-btn" onclick="document.getElementById('photo-input').click()">ğŸ“· <span id="lbl-upload">Ø±ÙØ¹</span></button>
            <button type="button" class="photo-btn rm" onclick="clearPhoto()" id="btn-rm-photo" style="display:none">ğŸ—‘ï¸</button>
          </div>
        </div>
        <input type="file" id="photo-input" class="hidden" accept="image/*" onchange="onPhotoSelect(event)">
      </div>
      <div class="form-row">
        <div class="form-group"><label id="lbl-birth">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input type="date" id="p-birth"></div>
        <div class="form-group"><label id="lbl-death">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙØ§Ø©</label><input type="date" id="p-death"></div>
      </div>
      <div class="form-group">
        <label id="lbl-notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <textarea id="p-notes" rows="2"></textarea>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn-del" id="pm-del" onclick="deletePerson()" style="display:none">ğŸ—‘ï¸</button>
      <button class="btn-cancel" onclick="closeModal('person-modal')" id="btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-save" onclick="savePerson()" id="btn-save">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Spouse Modal (Ø²ÙˆØ§Ø¬) -->
<div class="modal-bg" id="spouse-modal">
  <div class="modal">
    <div class="modal-head">
      <h2 id="sm-title">ğŸ’‘ Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ§Ø¬</h2>
      <button class="modal-close" onclick="closeModal('spouse-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label id="lbl-husband">Ø§Ù„Ø²ÙˆØ¬</label>
        <div class="person-select" id="husband-select"></div>
      </div>
      <div class="form-group">
        <label id="lbl-wife">Ø§Ù„Ø²ÙˆØ¬Ø©</label>
        <div class="person-select" id="wife-select"></div>
      </div>
      <div class="form-group">
        <label id="lbl-status">Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <div class="status-opts">
          <label class="status-opt"><input type="radio" name="sp-status" value="married" checked><span class="ic">ğŸ’‘</span><span class="tx" id="lbl-married">Ù…ØªØ²ÙˆØ¬Ø§Ù†</span></label>
          <label class="status-opt"><input type="radio" name="sp-status" value="divorced"><span class="ic">ğŸ’”</span><span class="tx" id="lbl-divorced">Ù…Ø·Ù„Ù‚Ø§Ù†</span></label>
          <label class="status-opt"><input type="radio" name="sp-status" value="widowed"><span class="ic">âœï¸</span><span class="tx" id="lbl-widowed">Ø£Ø±Ù…Ù„/Ø©</span></label>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label id="lbl-year-start">Ø³Ù†Ø© Ø§Ù„Ø²ÙˆØ§Ø¬</label><input type="number" id="sp-start" min="1900" max="2100"></div>
        <div class="form-group"><label id="lbl-year-end">Ø³Ù†Ø© Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input type="number" id="sp-end" min="1900" max="2100"></div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn-del" id="sm-del" onclick="deleteSpouseRel()" style="display:none">ğŸ—‘ï¸</button>
      <button class="btn-cancel" onclick="closeModal('spouse-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-save" onclick="saveSpouseRel()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Child Modal (Ø§Ø¨Ù†) -->
<div class="modal-bg" id="child-modal">
  <div class="modal">
    <div class="modal-head">
      <h2 id="cm-title">ğŸ‘¶ Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø©</h2>
      <button class="modal-close" onclick="closeModal('child-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="tabs">
        <button class="tab active" data-tab="new" onclick="switchChildTab('new')" id="tab-new">Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯</button>
        <button class="tab" data-tab="existing" onclick="switchChildTab('existing')" id="tab-existing">Ø´Ø®Øµ Ù…ÙˆØ¬ÙˆØ¯</button>
      </div>
      
      <div id="child-form-new">
        <div class="form-group">
          <label>Ø§Ù„Ø§Ø³Ù… *</label>
          <input type="text" id="c-name">
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ø¬Ù†Ø³</label>
          <div class="gender-toggle">
            <label class="gender-opt male"><input type="radio" name="c-gender" value="male" checked><span>ğŸ‘¨ Ø°ÙƒØ±</span></label>
            <label class="gender-opt female"><input type="radio" name="c-gender" value="female"><span>ğŸ‘© Ø£Ù†Ø«Ù‰</span></label>
          </div>
        </div>
      </div>
      
      <div id="child-form-existing" style="display:none">
        <div class="form-group">
          <label id="lbl-select-child">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®Øµ</label>
          <div class="person-select" id="child-select"></div>
        </div>
      </div>
      
      <div class="form-group" style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border-color)">
        <label id="lbl-child-type">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©</label>
        <div class="status-opts" id="child-type-opts">
          <!-- ÙŠÙÙ…Ù„Ø£ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal('child-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-save" onclick="saveChild()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-item" onclick="ctxAction('edit')">âœï¸ <span id="ctx-edit">ØªØ¹Ø¯ÙŠÙ„</span></div>
  <div class="ctx-item" onclick="ctxAction('spouse')">ğŸ’‘ <span id="ctx-spouse">Ø²ÙˆØ§Ø¬</span></div>
  <div class="ctx-item" onclick="ctxAction('child')">ğŸ‘¶ <span id="ctx-child">Ø§Ø¨Ù†/Ø©</span></div>
  <div class="ctx-item" onclick="ctxAction('locate')">ğŸ“ <span id="ctx-locate">Ø¥Ø¸Ù‡Ø§Ø±</span></div>
  <div class="ctx-divider"></div>
  <div class="ctx-item danger" onclick="ctxAction('delete')">ğŸ—‘ï¸ <span id="ctx-delete">Ø­Ø°Ù</span></div>
</div>

<!-- Add Menu (on card) -->
<div class="add-menu" id="add-menu">
  <div class="add-menu-item" onclick="addMenuAction('parent')">ğŸ‘¨â€ğŸ‘© <span id="am-parent">Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„Ø¯ÙŠÙ†</span></div>
  <div class="add-menu-item" onclick="addMenuAction('child')">ğŸ‘¶ <span id="am-child">Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø©</span></div>
  <div class="add-menu-item" onclick="addMenuAction('sibling')">ğŸ‘« <span id="am-sibling">Ø¥Ø¶Ø§ÙØ© Ø£Ø®/Ø£Ø®Øª</span></div>
  <div class="add-menu-item" onclick="addMenuAction('spouse')">ğŸ’‘ <span id="am-spouse">Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ¬/Ø©</span></div>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="import-file" class="hidden" accept=".json" onchange="importJSON(event)">

<script>
const isAr = document.documentElement.lang === 'ar';
const t = (ar, en) => isAr ? ar : en;

// ==================== DATA STRUCTURE ====================
// persons: { id: { id, name, gender, photo, birthDate, deathDate, notes } }
// relations: { id: { id, type, ...props } }
//   type: "spouse" â†’ { person1Id, person2Id, status, startYear, endYear }
//   type: "child"  â†’ { childId, fatherId, motherId } (Ø£Ø­Ø¯Ù‡Ù…Ø§ Ø£Ùˆ ÙƒÙ„Ø§Ù‡Ù…Ø§)

let db = { persons: {}, relations: {} };

let state = {
  editingPersonId: null,
  editingRelId: null,
  contextPersonId: null,
  addMenuPersonId: null,
  childContext: null, // { fatherId, motherId } - Ø³ÙŠØ§Ù‚ Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†
  currentPhoto: null,
  childTab: 'new',
  zoom: 1,
  panX: 0,
  panY: 0
};

const CARD_W = 115, CARD_H = 80;
const GAP_X = 35, GAP_Y = 60;
const SPOUSE_GAP = 25;

// ==================== INIT ====================
function init() {
  setupCanvas();
  setupI18n();
  render();
  
  document.addEventListener('click', e => {
    hideCtx();
    hideAddMenu();
    document.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
  });
  
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeAllModals();
  });
  
  document.getElementById('search-input').addEventListener('input', renderList);
}

function setupI18n() {
  if (!isAr) {
    document.getElementById('txt-persons').textContent = 'Persons';
    document.getElementById('txt-add').textContent = 'Add Person';
    document.getElementById('txt-empty').textContent = 'Start by adding a person';
    document.getElementById('search-input').placeholder = 'Search...';
    document.getElementById('lbl-name').textContent = 'Name *';
    document.getElementById('lbl-gender').textContent = 'Gender';
    document.getElementById('lbl-male').textContent = 'Male';
    document.getElementById('lbl-female').textContent = 'Female';
    document.getElementById('lbl-photo').textContent = 'Photo';
    document.getElementById('lbl-upload').textContent = 'Upload';
    document.getElementById('lbl-birth').textContent = 'Birth Date';
    document.getElementById('lbl-death').textContent = 'Death Date';
    document.getElementById('lbl-notes').textContent = 'Notes';
    document.getElementById('btn-cancel').textContent = 'Cancel';
    document.getElementById('btn-save').textContent = 'Save';
    document.getElementById('lbl-husband').textContent = 'Husband';
    document.getElementById('lbl-wife').textContent = 'Wife';
    document.getElementById('lbl-status').textContent = 'Status';
    document.getElementById('lbl-married').textContent = 'Married';
    document.getElementById('lbl-divorced').textContent = 'Divorced';
    document.getElementById('lbl-widowed').textContent = 'Widowed';
    document.getElementById('lbl-year-start').textContent = 'Marriage Year';
    document.getElementById('lbl-year-end').textContent = 'End Year';
    document.getElementById('tab-new').textContent = 'New Person';
    document.getElementById('tab-existing').textContent = 'Existing';
    document.getElementById('lbl-select-child').textContent = 'Select Person';
    document.getElementById('lbl-child-type').textContent = 'Relation Type';
    document.getElementById('ctx-edit').textContent = 'Edit';
    document.getElementById('ctx-spouse').textContent = 'Marriage';
    document.getElementById('ctx-child').textContent = 'Child';
    document.getElementById('ctx-locate').textContent = 'Show';
    document.getElementById('ctx-delete').textContent = 'Delete';
    document.getElementById('am-parent').textContent = 'Add Parents';
    document.getElementById('am-child').textContent = 'Add Child';
    document.getElementById('am-sibling').textContent = 'Add Sibling';
    document.getElementById('am-spouse').textContent = 'Add Spouse';
  }
}

// ==================== HELPERS ====================
const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø²ÙŠØ¬Ø§Øª Ø´Ø®Øµ
function getSpouseRels(personId) {
  return Object.values(db.relations).filter(r => r.type === 'spouse' && (r.person1Id === personId || r.person2Id === personId));
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙˆØ¬/Ø©
function getSpouse(personId, relId) {
  const rel = db.relations[relId];
  if (!rel || rel.type !== 'spouse') return null;
  const spouseId = rel.person1Id === personId ? rel.person2Id : rel.person1Id;
  return db.persons[spouseId];
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø¨Ù†Ø§Ø¡ Ø´Ø®Øµ (ÙƒØ£Ø¨ Ø£Ùˆ ÙƒØ£Ù…)
function getChildren(personId) {
  return Object.values(db.relations)
    .filter(r => r.type === 'child' && (r.fatherId === personId || r.motherId === personId))
    .map(r => ({ child: db.persons[r.childId], rel: r }))
    .filter(x => x.child);
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø¨Ù†Ø§Ø¡ Ù…Ù† Ø£Ø¨ ÙˆØ£Ù… Ù…Ø­Ø¯Ø¯ÙŠÙ†
function getChildrenOfBoth(fatherId, motherId) {
  return Object.values(db.relations)
    .filter(r => r.type === 'child' && r.fatherId === fatherId && r.motherId === motherId)
    .map(r => db.persons[r.childId])
    .filter(Boolean);
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØ§Ù„Ø¯ÙŠ Ø´Ø®Øµ
function getParents(personId) {
  const rel = Object.values(db.relations).find(r => r.type === 'child' && r.childId === personId);
  if (!rel) return { father: null, mother: null, rel: null };
  return {
    father: db.persons[rel.fatherId],
    mother: db.persons[rel.motherId],
    rel
  };
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø®ÙˆØ©
function getSiblings(personId) {
  const parents = getParents(personId);
  if (!parents.father && !parents.mother) return [];
  
  return Object.values(db.relations)
    .filter(r => {
      if (r.type !== 'child' || r.childId === personId) return false;
      // Ø£Ø® Ø´Ù‚ÙŠÙ‚ Ø£Ùˆ Ù…Ù† Ø£Ø¨ Ø£Ùˆ Ù…Ù† Ø£Ù…
      return (parents.father && r.fatherId === parents.father.id) ||
             (parents.mother && r.motherId === parents.mother.id);
    })
    .map(r => {
      const child = db.persons[r.childId];
      let sibType = 'half';
      if (parents.father && parents.mother && r.fatherId === parents.father.id && r.motherId === parents.mother.id) {
        sibType = 'full'; // Ø´Ù‚ÙŠÙ‚
      }
      return { person: child, type: sibType, rel: r };
    })
    .filter(x => x.person);
}

// Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ù†Ø³Ø¨
function getLineage(personId, depth = 2) {
  const p = db.persons[personId];
  if (!p) return '';
  let result = p.name;
  const parents = getParents(personId);
  if (parents.father && depth > 0) {
    result += ' ' + (p.gender === 'female' ? t('Ø¨Ù†Øª', 'd/o') : t('Ø¨Ù†', 's/o')) + ' ' + parents.father.name;
  } else if (parents.mother && depth > 0) {
    result += ' ' + (p.gender === 'female' ? t('Ø¨Ù†Øª', 'd/o') : t('Ø§Ø¨Ù†', 's/o')) + ' ' + parents.mother.name;
  }
  return result;
}

// Ù‡Ù„ Ø§Ù„Ø²ÙˆØ¬Ø© Ù…ØªØ²ÙˆØ¬Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ØŸ
function isWifeMarried(wifeId, excludeRelId = null) {
  return Object.values(db.relations).some(r => 
    r.type === 'spouse' && r.person2Id === wifeId && r.status === 'married' && r.id !== excludeRelId
  );
}

// ==================== RENDER LIST ====================
function renderList() {
  const list = document.getElementById('persons-list');
  const search = document.getElementById('search-input').value.toLowerCase();
  const persons = Object.values(db.persons);
  
  const hasRelation = p => {
    const parents = getParents(p.id);
    const spouses = getSpouseRels(p.id);
    const children = getChildren(p.id);
    return parents.father || parents.mother || spouses.length > 0 || children.length > 0;
  };
  
  const linked = persons.filter(hasRelation);
  const orphans = persons.filter(p => !hasRelation(p));
  const filter = p => p.name.toLowerCase().includes(search);
  
  let html = '';
  linked.filter(filter).forEach(p => html += renderListItem(p));
  
  const filteredOrphans = orphans.filter(filter);
  if (filteredOrphans.length) {
    html += `<div class="section-label">âš ï¸ ${t('ØºÙŠØ± Ù…Ø±ØªØ¨Ø·ÙŠÙ†', 'Unlinked')} (${filteredOrphans.length})</div>`;
    filteredOrphans.forEach(p => html += renderListItem(p, true));
  }
  
  list.innerHTML = html || `<div style="text-align:center;padding:20px;color:var(--text-muted)">${t('Ù„Ø§ ÙŠÙˆØ¬Ø¯', 'Empty')}</div>`;
  document.getElementById('persons-count').textContent = persons.length;
}

function renderListItem(p, orphan = false) {
  const icon = p.photo ? `<img src="${p.photo}">` : (p.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨');
  return `<div class="list-item ${orphan ? 'orphan' : ''}" onclick="locatePerson('${p.id}')" oncontextmenu="showCtx(event,'${p.id}')">
    <div class="icon ${p.gender}">${icon}</div>
    <div class="info"><div class="name">${p.name}</div><div class="sub">${getLineage(p.id)}</div></div>
    <button class="menu-btn" onclick="event.stopPropagation();showCtx(event,'${p.id}')">â‹®</button>
  </div>`;
}

// ==================== PERSON MODAL ====================
function openPersonModal(editId = null) {
  state.editingPersonId = editId;
  state.currentPhoto = null;
  
  const isEdit = !!editId;
  document.getElementById('pm-title').innerHTML = isEdit ? 'âœï¸ ' + t('ØªØ¹Ø¯ÙŠÙ„', 'Edit') : 'ğŸ‘¤ ' + t('Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ', 'Add Person');
  document.getElementById('pm-del').style.display = isEdit ? 'block' : 'none';
  
  if (isEdit) {
    const p = db.persons[editId];
    document.getElementById('p-name').value = p.name;
    document.querySelector(`input[name="p-gender"][value="${p.gender}"]`).checked = true;
    document.getElementById('p-birth').value = p.birthDate || '';
    document.getElementById('p-death').value = p.deathDate || '';
    document.getElementById('p-notes').value = p.notes || '';
    state.currentPhoto = p.photo;
  } else {
    document.getElementById('p-name').value = '';
    document.querySelector('input[name="p-gender"][value="male"]').checked = true;
    document.getElementById('p-birth').value = '';
    document.getElementById('p-death').value = '';
    document.getElementById('p-notes').value = '';
  }
  
  updatePhotoPreview();
  openModal('person-modal');
}

function savePerson() {
  const name = document.getElementById('p-name').value.trim();
  if (!name) return toast(t('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…', 'Enter name'));
  
  const data = {
    name,
    gender: document.querySelector('input[name="p-gender"]:checked').value,
    photo: state.currentPhoto,
    birthDate: document.getElementById('p-birth').value || null,
    deathDate: document.getElementById('p-death').value || null,
    notes: document.getElementById('p-notes').value.trim()
  };
  
  if (state.editingPersonId) {
    Object.assign(db.persons[state.editingPersonId], data);
  } else {
    const id = genId();
    db.persons[id] = { id, ...data };
  }
  
  closeModal('person-modal');
  render();
  toast(t('ØªÙ…', 'Done'));
}

function deletePerson() {
  if (!state.editingPersonId || !confirm(t('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®ØµØŸ', 'Delete this person?'))) return;
  
  const id = state.editingPersonId;
  
  // Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø©
  Object.keys(db.relations).forEach(rid => {
    const r = db.relations[rid];
    if (r.type === 'spouse' && (r.person1Id === id || r.person2Id === id)) delete db.relations[rid];
    if (r.type === 'child' && (r.childId === id || r.fatherId === id || r.motherId === id)) delete db.relations[rid];
  });
  
  delete db.persons[id];
  closeModal('person-modal');
  render();
  toast(t('ØªÙ…', 'Done'));
}

// ==================== PHOTO ====================
function onPhotoSelect(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => { state.currentPhoto = ev.target.result; updatePhotoPreview(); };
  reader.readAsDataURL(file);
}

function clearPhoto() {
  state.currentPhoto = null;
  document.getElementById('photo-input').value = '';
  updatePhotoPreview();
}

function updatePhotoPreview() {
  const prev = document.getElementById('photo-prev');
  const btn = document.getElementById('btn-rm-photo');
  if (state.currentPhoto) {
    prev.innerHTML = `<img src="${state.currentPhoto}">`;
    btn.style.display = 'block';
  } else {
    prev.innerHTML = '<span class="ph">ğŸ‘¤</span>';
    btn.style.display = 'none';
  }
}

// ==================== SPOUSE MODAL ====================
function openSpouseModal(editRelId = null, preselect = null) {
  state.editingRelId = editRelId;
  
  const males = Object.values(db.persons).filter(p => p.gender === 'male');
  const females = Object.values(db.persons).filter(p => p.gender === 'female');
  
  let selHusband = preselect?.husbandId || null;
  let selWife = preselect?.wifeId || null;
  
  if (editRelId) {
    const r = db.relations[editRelId];
    document.getElementById('sm-title').innerHTML = 'ğŸ’‘ ' + t('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø²ÙˆØ§Ø¬', 'Edit Marriage');
    document.getElementById('sm-del').style.display = 'block';
    selHusband = r.person1Id;
    selWife = r.person2Id;
    document.querySelector(`input[name="sp-status"][value="${r.status}"]`).checked = true;
    document.getElementById('sp-start').value = r.startYear || '';
    document.getElementById('sp-end').value = r.endYear || '';
  } else {
    document.getElementById('sm-title').innerHTML = 'ğŸ’‘ ' + t('Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ§Ø¬', 'Add Marriage');
    document.getElementById('sm-del').style.display = 'none';
    document.querySelector('input[name="sp-status"][value="married"]').checked = true;
    document.getElementById('sp-start').value = '';
    document.getElementById('sp-end').value = '';
  }
  
  renderPersonSelect('husband-select', males, selHusband);
  renderPersonSelect('wife-select', females, selWife);
  
  openModal('spouse-modal');
}

function saveSpouseRel() {
  const husbandId = getSelectedPerson('husband-select');
  const wifeId = getSelectedPerson('wife-select');
  
  if (!husbandId && !wifeId) return toast(t('Ø§Ø®ØªØ± Ø£Ø­Ø¯Ù‡Ù…Ø§', 'Select one'));
  
  const status = document.querySelector('input[name="sp-status"]:checked').value;
  
  // ØªØ­Ù‚Ù‚: Ø§Ù„Ø²ÙˆØ¬Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªØªØ²ÙˆØ¬ Ø£ÙƒØ«Ø± Ù…Ù† ÙˆØ§Ø­Ø¯ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª
  if (wifeId && status === 'married' && isWifeMarried(wifeId, state.editingRelId)) {
    return toast(t('Ù‡Ø°Ù‡ Ø§Ù„Ø²ÙˆØ¬Ø© Ù…ØªØ²ÙˆØ¬Ø© Ø­Ø§Ù„ÙŠØ§Ù‹', 'This wife is already married'));
  }
  
  const data = {
    type: 'spouse',
    person1Id: husbandId,
    person2Id: wifeId,
    status,
    startYear: parseInt(document.getElementById('sp-start').value) || null,
    endYear: parseInt(document.getElementById('sp-end').value) || null
  };
  
  if (state.editingRelId) {
    Object.assign(db.relations[state.editingRelId], data);
  } else {
    const id = genId();
    db.relations[id] = { id, ...data };
  }
  
  closeModal('spouse-modal');
  render();
  toast(t('ØªÙ…', 'Done'));
}

function deleteSpouseRel() {
  if (!state.editingRelId || !confirm(t('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø²ÙˆØ§Ø¬ØŸ', 'Delete?'))) return;
  delete db.relations[state.editingRelId];
  closeModal('spouse-modal');
  render();
  toast(t('ØªÙ…', 'Done'));
}

// ==================== CHILD MODAL ====================
function openChildModal(context) {
  // context: { fatherId?, motherId? }
  state.childContext = context;
  state.childTab = 'new';
  
  document.querySelector('.tab[data-tab="new"]').classList.add('active');
  document.querySelector('.tab[data-tab="existing"]').classList.remove('active');
  document.getElementById('child-form-new').style.display = 'block';
  document.getElementById('child-form-existing').style.display = 'none';
  
  document.getElementById('c-name').value = '';
  document.querySelector('input[name="c-gender"][value="male"]').checked = true;
  
  // Ø¨Ù†Ø§Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©
  const opts = document.getElementById('child-type-opts');
  let optsHtml = '';
  
  const father = context.fatherId ? db.persons[context.fatherId] : null;
  const mother = context.motherId ? db.persons[context.motherId] : null;
  
  if (father && mother) {
    // ÙƒÙ„Ø§ Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù†
    optsHtml += `<label class="status-opt"><input type="radio" name="c-type" value="both" checked><span class="ic">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span><span class="tx">${t('Ù…Ù† Ø§Ù„Ø£Ø¨ ÙˆØ§Ù„Ø£Ù…', 'Both Parents')}</span></label>`;
    optsHtml += `<label class="status-opt"><input type="radio" name="c-type" value="father"><span class="ic">ğŸ‘¨</span><span class="tx">${t('Ù…Ù† Ø§Ù„Ø£Ø¨ ÙÙ‚Ø·', 'Father Only')}</span></label>`;
    optsHtml += `<label class="status-opt"><input type="radio" name="c-type" value="mother"><span class="ic">ğŸ‘©</span><span class="tx">${t('Ù…Ù† Ø§Ù„Ø£Ù… ÙÙ‚Ø·', 'Mother Only')}</span></label>`;
  } else if (father) {
    optsHtml += `<label class="status-opt"><input type="radio" name="c-type" value="father" checked><span class="ic">ğŸ‘¨</span><span class="tx">${t('Ù…Ù† Ø§Ù„Ø£Ø¨', 'From Father')}: ${father.name}</span></label>`;
  } else if (mother) {
    optsHtml += `<label class="status-opt"><input type="radio" name="c-type" value="mother" checked><span class="ic">ğŸ‘©</span><span class="tx">${t('Ù…Ù† Ø§Ù„Ø£Ù…', 'From Mother')}: ${mother.name}</span></label>`;
  }
  
  opts.innerHTML = optsHtml;
  
  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† (Ø¨Ø¯ÙˆÙ† ÙˆØ§Ù„Ø¯ÙŠÙ†)
  const available = Object.values(db.persons).filter(p => {
    const parents = getParents(p.id);
    return !parents.father && !parents.mother;
  });
  renderPersonSelect('child-select', available, null);
  
  openModal('child-modal');
}

function switchChildTab(tab) {
  state.childTab = tab;
  document.querySelector('.tab[data-tab="new"]').classList.toggle('active', tab === 'new');
  document.querySelector('.tab[data-tab="existing"]').classList.toggle('active', tab === 'existing');
  document.getElementById('child-form-new').style.display = tab === 'new' ? 'block' : 'none';
  document.getElementById('child-form-existing').style.display = tab === 'existing' ? 'block' : 'none';
}

function saveChild() {
  let childId;
  
  if (state.childTab === 'new') {
    const name = document.getElementById('c-name').value.trim();
    if (!name) return toast(t('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…', 'Enter name'));
    
    childId = genId();
    db.persons[childId] = {
      id: childId,
      name,
      gender: document.querySelector('input[name="c-gender"]:checked').value,
      photo: null,
      birthDate: null,
      deathDate: null,
      notes: ''
    };
  } else {
    childId = getSelectedPerson('child-select');
    if (!childId) return toast(t('Ø§Ø®ØªØ± Ø´Ø®ØµØ§Ù‹', 'Select person'));
  }
  
  const relType = document.querySelector('input[name="c-type"]:checked')?.value || 'both';
  
  const relData = {
    id: genId(),
    type: 'child',
    childId,
    fatherId: null,
    motherId: null
  };
  
  if (relType === 'both' || relType === 'father') {
    relData.fatherId = state.childContext.fatherId || null;
  }
  if (relType === 'both' || relType === 'mother') {
    relData.motherId = state.childContext.motherId || null;
  }
  
  db.relations[relData.id] = relData;
  
  closeModal('child-modal');
  render();
  toast(t('ØªÙ…', 'Done'));
}

// ==================== PERSON SELECT ====================
function renderPersonSelect(containerId, persons, selectedId) {
  const container = document.getElementById(containerId);
  let html = `<input type="text" class="person-select-search" placeholder="${t('Ø§Ø¨Ø­Ø«...', 'Search...')}" oninput="filterPersonSelect('${containerId}', this.value)">`;
  html += `<div class="person-select-list">`;
  html += `<div class="person-select-opt none ${!selectedId ? 'selected' : ''}" onclick="selectPerson('${containerId}', null)">${t('Ø¨Ø¯ÙˆÙ†', 'None')}</div>`;
  
  persons.forEach(p => {
    const icon = p.photo ? `<img src="${p.photo}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">` : (p.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨');
    html += `<div class="person-select-opt ${selectedId === p.id ? 'selected' : ''}" data-id="${p.id}" data-name="${p.name.toLowerCase()}" onclick="selectPerson('${containerId}', '${p.id}')">
      <div class="av" style="background:${p.gender === 'female' ? 'rgba(236,72,153,0.2)' : 'rgba(59,130,246,0.2)'}">${icon}</div>
      <span class="nm">${p.name}</span>
    </div>`;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

function filterPersonSelect(containerId, q) {
  document.querySelectorAll(`#${containerId} .person-select-opt:not(.none)`).forEach(opt => {
    opt.style.display = (opt.dataset.name || '').includes(q.toLowerCase()) ? '' : 'none';
  });
}

function selectPerson(containerId, id) {
  document.querySelectorAll(`#${containerId} .person-select-opt`).forEach(opt => {
    opt.classList.toggle('selected', id ? opt.dataset.id === id : opt.classList.contains('none'));
  });
}

function getSelectedPerson(containerId) {
  const sel = document.querySelector(`#${containerId} .person-select-opt.selected:not(.none)`);
  return sel?.dataset.id || null;
}

// ==================== CONTEXT MENU ====================
function showCtx(e, personId) {
  e.preventDefault();
  e.stopPropagation();
  state.contextPersonId = personId;
  const menu = document.getElementById('ctx-menu');
  menu.style.left = e.clientX + 'px';
  menu.style.top = e.clientY + 'px';
  menu.classList.add('show');
}

function hideCtx() { document.getElementById('ctx-menu').classList.remove('show'); }

function ctxAction(action) {
  hideCtx();
  const id = state.contextPersonId;
  if (!id) return;
  
  const p = db.persons[id];
  
  switch (action) {
    case 'edit':
      openPersonModal(id);
      break;
    case 'spouse':
      openSpouseModal(null, p.gender === 'male' ? { husbandId: id } : { wifeId: id });
      break;
    case 'child':
      if (p.gender === 'male') openChildModal({ fatherId: id });
      else openChildModal({ motherId: id });
      break;
    case 'locate':
      locatePerson(id);
      break;
    case 'delete':
      state.editingPersonId = id;
      deletePerson();
      break;
  }
}

// ==================== ADD MENU ====================
function showAddMenu(e, personId, screenX, screenY) {
  e.stopPropagation();
  state.addMenuPersonId = personId;
  const menu = document.getElementById('add-menu');
  menu.style.left = screenX + 'px';
  menu.style.top = screenY + 'px';
  menu.classList.add('show');
}

function hideAddMenu() { document.getElementById('add-menu').classList.remove('show'); }

function addMenuAction(action) {
  hideAddMenu();
  const id = state.addMenuPersonId;
  if (!id) return;
  
  const p = db.persons[id];
  const parents = getParents(id);
  
  switch (action) {
    case 'parent':
      // Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„Ø¯ÙŠÙ† â†’ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø²ÙˆØ§Ø¬
      openSpouseModal();
      break;
    case 'child':
      // Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†
      const spouseRels = getSpouseRels(id);
      if (spouseRels.length > 0) {
        // Ù„Ù‡ Ø²ÙˆØ¬/Ø© - Ù†Ø¶ÙŠÙ Ø§Ø¨Ù† Ù…Ù† Ø§Ù„Ø²ÙˆØ§Ø¬
        const rel = spouseRels[0];
        const spouse = getSpouse(id, rel.id);
        if (p.gender === 'male') {
          openChildModal({ fatherId: id, motherId: spouse?.id });
        } else {
          openChildModal({ fatherId: spouse?.id, motherId: id });
        }
      } else {
        // Ø¨Ø¯ÙˆÙ† Ø²ÙˆØ¬/Ø©
        if (p.gender === 'male') openChildModal({ fatherId: id });
        else openChildModal({ motherId: id });
      }
      break;
    case 'sibling':
      // Ø¥Ø¶Ø§ÙØ© Ø£Ø® = Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù† Ù„Ù†ÙØ³ Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ†
      if (!parents.father && !parents.mother) {
        return toast(t('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØ§Ù„Ø¯ÙŠÙ†', 'No parents'));
      }
      openChildModal({ fatherId: parents.father?.id, motherId: parents.mother?.id });
      break;
    case 'spouse':
      openSpouseModal(null, p.gender === 'male' ? { husbandId: id } : { wifeId: id });
      break;
  }
}

// ==================== LAYOUT & RENDER ====================
function render() {
  renderList();
  layoutTree();
  renderTree();
  updateStats();
}

function layoutTree() {
  const positions = {};
  const processed = new Set();
  let currentX = 50;
  
  // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¬Ø°ÙˆØ± (Ø£Ø´Ø®Ø§Øµ Ø¨Ø¯ÙˆÙ† Ø¢Ø¨Ø§Ø¡)
  const roots = Object.values(db.persons).filter(p => {
    const parents = getParents(p.id);
    return !parents.father && !parents.mother;
  });
  
  function layoutFamily(personId, level, startX) {
    if (processed.has(personId)) return startX;
    
    const person = db.persons[personId];
    if (!person) return startX;
    
    processed.add(personId);
    
    let x = startX;
    const y = level * (CARD_H + GAP_Y);
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙŠØ¬Ø§Øª
    const spouseRels = getSpouseRels(personId);
    let totalWidth = CARD_W;
    
    // Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ ÙˆØ§Ù„Ø£Ø¨Ù†Ø§Ø¡
    const familyUnits = [];
    
    if (spouseRels.length > 0) {
      spouseRels.forEach(rel => {
        const spouse = getSpouse(personId, rel.id);
        if (spouse && !processed.has(spouse.id)) {
          processed.add(spouse.id);
          
          // Ø£Ø¨Ù†Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø²ÙˆØ§Ø¬
          const fatherId = person.gender === 'male' ? personId : spouse.id;
          const motherId = person.gender === 'female' ? personId : spouse.id;
          const children = getChildrenOfBoth(fatherId, motherId);
          
          familyUnits.push({ spouse, children, fatherId, motherId });
        }
      });
    }
    
    // Ø£Ø¨Ù†Ø§Ø¡ Ø¨Ø¯ÙˆÙ† Ø²ÙˆØ¬/Ø© Ù…Ø­Ø¯Ø¯Ø©
    const soloChildren = getChildren(personId).filter(({ rel }) => {
      if (person.gender === 'male') return !rel.motherId;
      return !rel.fatherId;
    }).map(x => x.child);
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
    positions[personId] = { x, y, level };
    
    let spouseX = x + CARD_W + SPOUSE_GAP;
    familyUnits.forEach(unit => {
      positions[unit.spouse.id] = { x: spouseX, y, level };
      
      // Ø±Ø³Ù… Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
      const childStartX = x;
      unit.children.forEach((child, i) => {
        const childX = layoutFamily(child.id, level + 1, childStartX + i * (CARD_W + GAP_X));
      });
      
      spouseX += CARD_W + SPOUSE_GAP;
    });
    
    // Ø£Ø¨Ù†Ø§Ø¡ Ù…Ù†ÙØ±Ø¯ÙŠÙ†
    let soloX = spouseX;
    soloChildren.forEach((child, i) => {
      layoutFamily(child.id, level + 1, x + i * (CARD_W + GAP_X));
    });
    
    return Math.max(spouseX, x + CARD_W + GAP_X);
  }
  
  roots.forEach(root => {
    currentX = layoutFamily(root.id, 0, currentX) + GAP_X * 2;
  });
  
  // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
  Object.entries(positions).forEach(([id, pos]) => {
    if (db.persons[id]) {
      db.persons[id]._x = pos.x;
      db.persons[id]._y = pos.y;
      db.persons[id]._level = pos.level;
    }
  });
}

function renderTree() {
  const linesLayer = document.getElementById('lines-layer');
  const cardsLayer = document.getElementById('cards-layer');
  linesLayer.innerHTML = '';
  cardsLayer.innerHTML = '';
  
  const persons = Object.values(db.persons);
  document.getElementById('empty-msg').style.display = persons.length ? 'none' : 'block';
  
  if (!persons.length) return;
  
  // Ø±Ø³Ù… Ø®Ø·ÙˆØ· Ø§Ù„Ø²ÙˆØ§Ø¬
  const drawnSpouse = new Set();
  Object.values(db.relations).filter(r => r.type === 'spouse').forEach(rel => {
    const p1 = db.persons[rel.person1Id];
    const p2 = db.persons[rel.person2Id];
    if (p1?._x !== undefined && p2?._x !== undefined) {
      drawSpouseLine(p1, p2, rel, linesLayer);
      drawnSpouse.add(rel.id);
    }
  });
  
  // Ø±Ø³Ù… Ø®Ø·ÙˆØ· Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
  Object.values(db.relations).filter(r => r.type === 'child').forEach(rel => {
    const child = db.persons[rel.childId];
    if (!child || child._x === undefined) return;
    
    const father = db.persons[rel.fatherId];
    const mother = db.persons[rel.motherId];
    
    if (father?._x !== undefined && mother?._x !== undefined) {
      // Ù…Ù† Ø£Ø¨ ÙˆØ£Ù…
      drawChildLineFromBoth(father, mother, child, linesLayer);
    } else if (father?._x !== undefined) {
      // Ù…Ù† Ø£Ø¨ ÙÙ‚Ø·
      drawChildLineFromSingle(father, child, linesLayer);
    } else if (mother?._x !== undefined) {
      // Ù…Ù† Ø£Ù… ÙÙ‚Ø·
      drawChildLineFromSingle(mother, child, linesLayer);
    }
  });
  
  // Ø±Ø³Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
  persons.forEach(p => {
    if (p._x !== undefined) drawCard(p, cardsLayer);
  });
  
  updateTransform();
}

function drawSpouseLine(p1, p2, rel, layer) {
  const x1 = Math.min(p1._x, p2._x) + CARD_W;
  const x2 = Math.max(p1._x, p2._x);
  const y = p1._y + CARD_H / 2;
  
  const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  line.setAttribute('x1', x1);
  line.setAttribute('y1', y);
  line.setAttribute('x2', x2);
  line.setAttribute('y2', y);
  
  if (rel.status === 'divorced') {
    line.setAttribute('stroke', '#6b7280');
    line.setAttribute('stroke-dasharray', '5,5');
  } else if (rel.status === 'widowed') {
    line.setAttribute('stroke', '#4b5563');
    line.setAttribute('stroke-dasharray', '2,4');
  } else {
    line.setAttribute('stroke', '#f59e0b');
  }
  line.setAttribute('stroke-width', '3');
  layer.appendChild(line);
  
  // Ø£ÙŠÙ‚ÙˆÙ†Ø©
  const midX = (x1 + x2) / 2;
  const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  icon.setAttribute('x', midX);
  icon.setAttribute('y', y - 8);
  icon.setAttribute('text-anchor', 'middle');
  icon.setAttribute('font-size', '12');
  icon.textContent = rel.status === 'divorced' ? 'ğŸ’”' : rel.status === 'widowed' ? 'âœï¸' : 'ğŸ’‘';
  layer.appendChild(icon);
  
  // Ø²Ø± + Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†
  const addBtn = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  addBtn.style.cursor = 'pointer';
  
  const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  circle.setAttribute('cx', midX);
  circle.setAttribute('cy', y + 15);
  circle.setAttribute('r', 8);
  circle.setAttribute('fill', '#1e293b');
  circle.setAttribute('stroke', '#059669');
  circle.setAttribute('stroke-width', '2');
  addBtn.appendChild(circle);
  
  const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  txt.setAttribute('x', midX);
  txt.setAttribute('y', y + 15);
  txt.setAttribute('text-anchor', 'middle');
  txt.setAttribute('dominant-baseline', 'central');
  txt.setAttribute('fill', '#059669');
  txt.setAttribute('font-size', '12');
  txt.setAttribute('font-weight', 'bold');
  txt.textContent = '+';
  addBtn.appendChild(txt);
  
  addBtn.addEventListener('click', e => {
    e.stopPropagation();
    openChildModal({ fatherId: rel.person1Id, motherId: rel.person2Id });
  });
  
  addBtn.addEventListener('mouseenter', () => { circle.setAttribute('fill', '#059669'); txt.setAttribute('fill', '#fff'); });
  addBtn.addEventListener('mouseleave', () => { circle.setAttribute('fill', '#1e293b'); txt.setAttribute('fill', '#059669'); });
  
  layer.appendChild(addBtn);
}

function drawChildLineFromBoth(father, mother, child, layer) {
  const parentMidX = (Math.min(father._x, mother._x) + Math.max(father._x, mother._x) + CARD_W) / 2;
  const parentY = father._y + CARD_H;
  const childX = child._x + CARD_W / 2;
  const childY = child._y;
  const midY = parentY + (childY - parentY) / 2;
  
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', `M ${parentMidX} ${parentY} L ${parentMidX} ${midY} L ${childX} ${midY} L ${childX} ${childY}`);
  path.setAttribute('stroke', '#475569');
  path.setAttribute('stroke-width', '2');
  path.setAttribute('fill', 'none');
  layer.appendChild(path);
}

function drawChildLineFromSingle(parent, child, layer) {
  const px = parent._x + CARD_W / 2;
  const py = parent._y + CARD_H;
  const cx = child._x + CARD_W / 2;
  const cy = child._y;
  const midY = py + (cy - py) / 2;
  
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', `M ${px} ${py} L ${px} ${midY} L ${cx} ${midY} L ${cx} ${cy}`);
  path.setAttribute('stroke', '#475569');
  path.setAttribute('stroke-width', '2');
  path.setAttribute('fill', 'none');
  layer.appendChild(path);
}

function drawCard(person, layer) {
  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.setAttribute('transform', `translate(${person._x}, ${person._y})`);
  g.setAttribute('data-id', person.id);
  g.style.cursor = 'pointer';
  
  // Ø§Ù„Ø®Ù„ÙÙŠØ©
  const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  rect.setAttribute('width', CARD_W);
  rect.setAttribute('height', CARD_H);
  rect.setAttribute('rx', '8');
  rect.setAttribute('fill', '#334155');
  rect.setAttribute('stroke', person.gender === 'female' ? '#ec4899' : '#3b82f6');
  rect.setAttribute('stroke-width', person.deathDate ? '2' : '2.5');
  if (person.deathDate) rect.setAttribute('stroke-dasharray', '4,3');
  rect.setAttribute('filter', 'url(#shadow)');
  g.appendChild(rect);
  
  // Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
  if (person.photo) {
    const img = document.createElementNS('http://www.w3.org/2000/svg', 'image');
    img.setAttribute('x', CARD_W/2 - 13);
    img.setAttribute('y', 6);
    img.setAttribute('width', 26);
    img.setAttribute('height', 26);
    img.setAttribute('href', person.photo);
    g.appendChild(img);
  } else {
    const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    icon.setAttribute('x', CARD_W/2);
    icon.setAttribute('y', 24);
    icon.setAttribute('text-anchor', 'middle');
    icon.setAttribute('font-size', '20');
    icon.textContent = person.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨';
    g.appendChild(icon);
  }
  
  // Ø§Ù„Ø§Ø³Ù…
  const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  name.setAttribute('x', CARD_W/2);
  name.setAttribute('y', 46);
  name.setAttribute('text-anchor', 'middle');
  name.setAttribute('fill', '#f8fafc');
  name.setAttribute('font-size', '10');
  name.setAttribute('font-weight', '600');
  name.textContent = person.name.length > 12 ? person.name.substring(0, 12) + '..' : person.name;
  g.appendChild(name);
  
  // Ø§Ù„Ø¹Ù…Ø±
  if (person.birthDate) {
    const age = calcAge(person.birthDate, person.deathDate);
    const ageText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    ageText.setAttribute('x', CARD_W/2);
    ageText.setAttribute('y', 58);
    ageText.setAttribute('text-anchor', 'middle');
    ageText.setAttribute('fill', '#94a3b8');
    ageText.setAttribute('font-size', '8');
    ageText.textContent = age + (isAr ? ' Ø³Ù†Ø©' : ' y') + (person.deathDate ? ' âœ' : '');
    g.appendChild(ageText);
  }
  
  // Ø²Ø± +
  const addG = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  addG.setAttribute('class', 'card-add-btn');
  addG.style.cursor = 'pointer';
  
  const addRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  addRect.setAttribute('x', CARD_W/2 - 12);
  addRect.setAttribute('y', CARD_H - 17);
  addRect.setAttribute('width', 24);
  addRect.setAttribute('height', 13);
  addRect.setAttribute('rx', 4);
  addRect.setAttribute('fill', '#1e293b');
  addRect.setAttribute('stroke', '#059669');
  addRect.setAttribute('stroke-width', '1.5');
  addG.appendChild(addRect);
  
  const addTxt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  addTxt.setAttribute('x', CARD_W/2);
  addTxt.setAttribute('y', CARD_H - 7);
  addTxt.setAttribute('text-anchor', 'middle');
  addTxt.setAttribute('fill', '#059669');
  addTxt.setAttribute('font-size', '11');
  addTxt.setAttribute('font-weight', 'bold');
  addTxt.textContent = '+';
  addG.appendChild(addTxt);
  
  addG.addEventListener('click', e => {
    e.stopPropagation();
    const svg = document.getElementById('tree-svg');
    const rect = svg.getBoundingClientRect();
    const screenX = rect.left + (person._x + CARD_W/2) * state.zoom + state.panX;
    const screenY = rect.top + (person._y + CARD_H) * state.zoom + state.panY;
    showAddMenu(e, person.id, screenX, screenY);
  });
  
  addG.addEventListener('mouseenter', () => { addRect.setAttribute('fill', '#059669'); addTxt.setAttribute('fill', '#fff'); });
  addG.addEventListener('mouseleave', () => { addRect.setAttribute('fill', '#1e293b'); addTxt.setAttribute('fill', '#059669'); });
  
  g.appendChild(addG);
  
  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
  g.addEventListener('click', e => {
    if (e.target.closest('.card-add-btn')) return;
    e.stopPropagation();
    openPersonModal(person.id);
  });
  
  g.addEventListener('contextmenu', e => {
    e.preventDefault();
    showCtx(e, person.id);
  });
  
  g.addEventListener('dblclick', e => {
    e.stopPropagation();
    const rels = getSpouseRels(person.id);
    if (rels.length > 0) {
      openSpouseModal(rels[0].id);
    } else {
      openSpouseModal(null, person.gender === 'male' ? { husbandId: person.id } : { wifeId: person.id });
    }
  });
  
  layer.appendChild(g);
}

function calcAge(birth, death) {
  const b = new Date(birth);
  const e = death ? new Date(death) : new Date();
  let age = e.getFullYear() - b.getFullYear();
  if (e.getMonth() < b.getMonth() || (e.getMonth() === b.getMonth() && e.getDate() < b.getDate())) age--;
  return age;
}

// ==================== CANVAS ====================
let isDragging = false, dragStartX = 0, dragStartY = 0;

function setupCanvas() {
  const svg = document.getElementById('tree-svg');
  const wrap = document.getElementById('canvas-wrap');
  
  svg.addEventListener('mousedown', e => {
    if (e.target.closest('g[data-id]') || e.target.closest('.card-add-btn')) return;
    isDragging = true;
    dragStartX = e.clientX - state.panX;
    dragStartY = e.clientY - state.panY;
  });
  
  svg.addEventListener('mousemove', e => {
    if (!isDragging) return;
    state.panX = e.clientX - dragStartX;
    state.panY = e.clientY - dragStartY;
    updateTransform();
  });
  
  svg.addEventListener('mouseup', () => isDragging = false);
  svg.addEventListener('mouseleave', () => isDragging = false);
  
  wrap.addEventListener('wheel', e => {
    e.preventDefault();
    state.zoom = Math.max(0.3, Math.min(2, state.zoom + (e.deltaY > 0 ? -0.1 : 0.1)));
    updateTransform();
    document.getElementById('zoom-level').textContent = Math.round(state.zoom * 100) + '%';
  });
}

function updateTransform() {
  document.getElementById('tree-g').setAttribute('transform', `translate(${state.panX}, ${state.panY}) scale(${state.zoom})`);
}

function zoomIn() {
  state.zoom = Math.min(2, state.zoom + 0.1);
  updateTransform();
  document.getElementById('zoom-level').textContent = Math.round(state.zoom * 100) + '%';
}

function zoomOut() {
  state.zoom = Math.max(0.3, state.zoom - 0.1);
  updateTransform();
  document.getElementById('zoom-level').textContent = Math.round(state.zoom * 100) + '%';
}

function fitView() {
  state.zoom = 1;
  state.panX = 0;
  state.panY = 0;
  updateTransform();
  document.getElementById('zoom-level').textContent = '100%';
}

function locatePerson(personId) {
  const p = db.persons[personId];
  if (!p || p._x === undefined) return;
  
  const svg = document.getElementById('tree-svg');
  state.panX = svg.clientWidth / 2 - p._x - CARD_W / 2;
  state.panY = svg.clientHeight / 2 - p._y - CARD_H / 2;
  state.zoom = 1;
  updateTransform();
  document.getElementById('zoom-level').textContent = '100%';
}

// ==================== STATS ====================
function updateStats() {
  const persons = Object.values(db.persons);
  const spouseRels = Object.values(db.relations).filter(r => r.type === 'spouse');
  const levels = new Set(persons.map(p => p._level).filter(l => l !== undefined));
  
  document.getElementById('stat-total').textContent = persons.length;
  document.getElementById('stat-males').textContent = persons.filter(p => p.gender === 'male').length;
  document.getElementById('stat-females').textContent = persons.filter(p => p.gender === 'female').length;
  document.getElementById('stat-marriages').textContent = spouseRels.length;
  document.getElementById('stat-gens').textContent = levels.size;
}

// ==================== SAVE/LOAD ====================
function saveLocal() {
  localStorage.setItem('familyTreeV56', JSON.stringify(db));
  toast(t('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'Saved'));
}

function loadLocal() {
  const saved = localStorage.getItem('familyTreeV56');
  if (saved) {
    db = JSON.parse(saved);
    render();
    toast(t('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„', 'Loaded'));
  } else {
    toast(t('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'No data'));
  }
}

function exportJSON() {
  download(JSON.stringify(db, null, 2), 'family-tree.json', 'application/json');
}

function importJSON(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      db = JSON.parse(ev.target.result);
      render();
      toast(t('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'Imported'));
    } catch {
      toast(t('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­', 'Invalid file'));
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function exportPNG() {
  const svg = document.getElementById('tree-svg');
  const data = new XMLSerializer().serializeToString(svg);
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  const img = new Image();
  canvas.width = svg.clientWidth * 2;
  canvas.height = svg.clientHeight * 2;
  img.onload = () => {
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    const a = document.createElement('a');
    a.download = 'family-tree.png';
    a.href = canvas.toDataURL('image/png');
    a.click();
  };
  img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(data)));
}

function exportSVG() {
  download(new XMLSerializer().serializeToString(document.getElementById('tree-svg')), 'family-tree.svg', 'image/svg+xml');
}

function download(content, filename, type) {
  const blob = new Blob([content], { type });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function clearAll() {
  if (!confirm(t('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ', 'Clear all?'))) return;
  db = { persons: {}, relations: {} };
  render();
  toast(t('ØªÙ…', 'Done'));
}

// ==================== UTILS ====================
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function closeAllModals() { document.querySelectorAll('.modal-bg.show').forEach(m => m.classList.remove('show')); }
function toast(msg) { const el = document.getElementById('toast'); el.textContent = msg; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 2000); }
function toggleDD(id) { event.stopPropagation(); document.getElementById(id).classList.toggle('open'); }

init();
</script>

<script>
  window.toolsData = [{"id":"percentage","icon":"ğŸ”¢","name":"Percentage Calculator","keywords":"percentage calculator, calculate percentage, discount calculator, percent change","searchTerms":"percent percentage % discount sale off price change increase decrease difference quarter half third ratio math calculator profit loss tax margin fraction calculate how much what is of total part whole original cost selling buying before after","category":"calculators","categoryName":"Calculators","url":"../../en/tools/percentage.html"},{"id":"interest-calculator","icon":"ğŸ’°","name":"Interest Calculator","keywords":"interest calculator, simple interest, compound interest, loan calculator","searchTerms":"interest simple compound loan investment return profit bank money calculate annual monthly daily quarterly yearly principal rate time period accumulate savings deposit growth calculator finance financial how much earn","category":"calculators","categoryName":"Calculators","url":"../../en/tools/interest-calculator.html"},{"id":"loan-calculator","icon":"ğŸ¦","name":"Loan Calculator","keywords":"loan calculator, monthly payment, amortization schedule, mortgage calculator","searchTerms":"loan loans payment payments installment installments bank mortgage mortgages monthly schedule amortization calculate calculator interest principal finance financing car home personal","category":"calculators","categoryName":"Calculators","url":"../../en/tools/loan-calculator.html"},{"id":"body-calculator","icon":"âš–ï¸","name":"Body Calculator","keywords":"BMI calculator, body mass index, ideal weight, calorie calculator, body fat","searchTerms":"bmi body mass index weight fat calories calorie bmr tdee ideal healthy obesity overweight underweight waist hip ratio calculate calculator health fitness","category":"calculators","categoryName":"Calculators","url":"../../en/tools/body-calculator.html"},{"id":"age-calculator","icon":"ğŸ‚","name":"Age Calculator","keywords":"age calculator, calculate age, how old am I, zodiac sign, birthday calculator","searchTerms":"age birthday birth date zodiac calculate how old years months days weeks hours born sign horoscope difference between dates","category":"calculators","categoryName":"Calculators","url":"../../en/tools/age-calculator.html"},{"id":"family-tree","icon":"ğŸŒ³","name":"Family Tree","keywords":"family tree, genealogy, ancestry, lineage, family relationships, family tree maker","searchTerms":"family tree genealogy ancestry lineage relatives father mother son daughter brother sister grandfather grandmother uncle aunt cousin relations","category":"everyday","categoryName":"Everyday Tools","url":"../../en/tools/family-tree.html"}];
</script>
      </main>
      
      <footer class="main-footer">
        <p>Made with â¤ï¸ | All Rights Reserved Â© 2026 Udda</p>
      </footer>
    </div>
  </div>
  
  <!-- Settings Panel -->
  <div class="settings-overlay"></div>
  <div class="settings-panel">
    <div class="settings-header">
      <h2 class="settings-title">Settings</h2>
      <button class="settings-close" aria-label="Close">âœ•</button>
    </div>
    <div class="settings-content">
      <div class="settings-section">
        <div class="settings-section-title">Language</div>
        <div class="settings-option">
          <button class="settings-btn " data-lang-btn="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
          <button class="settings-btn active" data-lang-btn="en">English</button>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Theme</div>
        <div class="settings-option">
          <button class="settings-btn" data-theme-btn="light">â˜€ï¸ Light</button>
          <button class="settings-btn" data-theme-btn="dark">ğŸŒ™ Dark</button>
          <button class="settings-btn active" data-theme-btn="auto">ğŸ’» Auto</button>
        </div>
      </div>
      <div class="settings-section">
        <button class="settings-btn" data-clear-data style="width:100%;justify-content:center;color:var(--error);">
          ğŸ—‘ï¸ Clear Saved Data
        </button>
      </div>
    </div>
  </div>
  
  <div class="toast"></div>
  <script src="../../assets/js/app.js"></script>
</body>
</html>