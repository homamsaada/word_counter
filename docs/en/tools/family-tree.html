<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Family Tree - Create Your Family Tree Free | Udda</title>
  <meta name="description" content="Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.">
  <meta name="keywords" content="family tree, genealogy, ancestry, lineage, family relationships, family tree maker">
  <meta name="author" content="Udda">
  <meta name="robots" content="index, follow">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="Family Tree - Create Your Family Tree Free | Udda">
  <meta property="og:description" content="Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.">
  <meta property="og:url" content="https://udda.tools/en/tools/family-tree.html">
  <meta property="og:site_name" content="Udda">
  <meta property="og:locale" content="en_US">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Family Tree - Create Your Family Tree Free | Udda">
  <meta name="twitter:description" content="Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.">
  
  <link rel="alternate" hreflang="ar" href="https://udda.tools/ar/tools/family-tree.html">
  <link rel="alternate" hreflang="en" href="https://udda.tools/en/tools/family-tree.html">
  <link rel="alternate" hreflang="x-default" href="https://udda.tools/ar/tools/family-tree.html">
  <link rel="canonical" href="https://udda.tools/en/tools/family-tree.html">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/main.css">
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Family Tree",
    "description": "Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.",
    "url": "https://udda.tools/en/tools/family-tree.html",
    "applicationCategory": "UtilityApplication",
    "operatingSystem": "Any",
    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
    "inLanguage": ["ar", "en"],
    "isAccessibleForFree": true
  }
  </script>
</head>
<body data-tool-id="family-tree">
  <div class="app-container">
    <div class="sidebar-overlay"></div>
    
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="../../en/" class="logo">
          <div class="logo-icon">üîß</div>
          <span class="logo-text sidebar-text">Udda</span>
        </a>
      </div>
      
      <div class="sidebar-search">
        <div class="search-input-wrapper">
          <input type="text" class="search-input" placeholder="Search for a tool..." aria-label="Search for a tool...">
          <svg class="search-icon" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        
        <a href="../../en/" class="nav-item ">
          <span class="nav-item-icon">üè†</span>
          <span class="sidebar-text">Home</span>
        </a>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">üßÆ</span>
              <span class="sidebar-text">Calculators</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
            <a href="../../en/tools/percentage.html" class="nav-item ">
              <span class="nav-item-icon">üî¢</span>
              <span class="sidebar-text">Percentage Calculator</span>
            </a>
            <a href="../../en/tools/interest-calculator.html" class="nav-item ">
              <span class="nav-item-icon">üí∞</span>
              <span class="sidebar-text">Interest Calculator</span>
            </a>
            <a href="../../en/tools/loan-calculator.html" class="nav-item ">
              <span class="nav-item-icon">üè¶</span>
              <span class="sidebar-text">Loan Calculator</span>
            </a>
            <a href="../../en/tools/body-calculator.html" class="nav-item ">
              <span class="nav-item-icon">‚öñÔ∏è</span>
              <span class="sidebar-text">Body Calculator</span>
            </a>
            <a href="../../en/tools/age-calculator.html" class="nav-item ">
              <span class="nav-item-icon">üéÇ</span>
              <span class="sidebar-text">Age Calculator</span>
            </a>
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">üîÑ</span>
              <span class="sidebar-text">Converters</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">üìù</span>
              <span class="sidebar-text">Text Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">üìÖ</span>
              <span class="sidebar-text">Date & Time</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">‚ö°</span>
              <span class="sidebar-text">Generators</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">üñºÔ∏è</span>
              <span class="sidebar-text">Image Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">üíª</span>
              <span class="sidebar-text">Developer Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section open">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">üè†</span>
              <span class="sidebar-text">Everyday Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
            <a href="../../en/tools/family-tree.html" class="nav-item active">
              <span class="nav-item-icon">üå≥</span>
              <span class="sidebar-text">Family Tree</span>
            </a>
          </div>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <button class="sidebar-toggle" aria-label="Toggle sidebar">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
          </svg>
          <span class="sidebar-text">Sidebar</span>
        </button>
      </div>
    </aside>
    
    <div class="main-content">
      <header class="main-header">
        <button class="header-btn mobile-menu-btn" aria-label="Menu">
          <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        
        <nav class="header-breadcrumb">
          <a href="../../en/" class="breadcrumb-link">Home</a>
          <span class="breadcrumb-separator">‚Ä∫</span>
          <a href="../../en/category/everyday.html" class="breadcrumb-link">Everyday Tools</a>
          <span class="breadcrumb-separator">‚Ä∫</span>
          <span class="breadcrumb-current">Family Tree</span>
        </nav>
        
        <div class="header-actions">
          <button class="header-btn" data-favorite-btn aria-label="Add to Favorites">‚òÜ</button>
          <button class="header-btn" onclick="App.shareUrl('Family Tree')" aria-label="Share">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
              <polyline points="16 6 12 2 8 6"></polyline>
              <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg>
          </button>
          <button class="header-btn" data-open-settings aria-label="Settings">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </button>
        </div>
      </header>
      
      <main class="page-content">
        <style>
:root {
  --primary: #059669;
  --primary-dark: #047857;
  --primary-light: #d1fae5;
  --male-color: #3b82f6;
  --male-light: #dbeafe;
  --female-color: #ec4899;
  --female-light: #fce7f3;
  --spouse-color: #f59e0b;
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --bg-card: #334155;
  --text-primary: #f8fafc;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border-color: #475569;
}

.family-tree-app {
  min-height: 80vh;
  display: flex;
  flex-direction: column;
  font-family: inherit;
}

/* Toolbar */
.tree-toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: 12px;
  margin-bottom: 16px;
  align-items: center;
}

.toolbar-group {
  display: flex;
  gap: 4px;
  padding: 0 12px;
  border-right: 2px solid var(--border-color);
}

.toolbar-group:last-child {
  border-right: none;
}

.tool-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px 16px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-family: inherit;
}

.tool-btn:hover {
  border-color: var(--primary);
  background: rgba(5, 150, 105, 0.1);
}

.tool-btn.primary {
  background: var(--primary);
  border-color: var(--primary);
}

.tool-btn.primary:hover {
  background: var(--primary-dark);
}

.tool-btn .icon { font-size: 1.1rem; }

/* Canvas Container */
.canvas-container {
  flex: 1;
  position: relative;
  background: var(--bg-secondary);
  border-radius: 16px;
  overflow: hidden;
  min-height: 500px;
  border: 2px solid var(--border-color);
}

.tree-canvas {
  width: 100%;
  height: 100%;
  min-height: 500px;
  cursor: grab;
  font-family: inherit;
}

.tree-canvas:active { cursor: grabbing; }

/* Empty State */
.empty-state {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  color: var(--text-muted);
}

.empty-state .icon { font-size: 4rem; margin-bottom: 16px; opacity: 0.5; }
.empty-state h3 { font-size: 1.5rem; margin-bottom: 8px; color: var(--text-secondary); }
.empty-state p { margin-bottom: 20px; }

.empty-state .start-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 14px 28px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  font-family: inherit;
}

.empty-state .start-btn:hover {
  background: var(--primary-dark);
  transform: scale(1.05);
}

/* SVG Text */
.tree-canvas text {
  font-family: inherit;
}

/* Modal */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.modal-overlay.show { opacity: 1; visibility: visible; }

.modal-content {
  background: var(--bg-secondary);
  border-radius: 20px;
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  transform: scale(0.9);
  transition: transform 0.3s;
}

.modal-overlay.show .modal-content { transform: scale(1); }

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px;
  border-bottom: 2px solid var(--border-color);
}

.modal-header h2 {
  font-size: 1.3rem;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--text-muted);
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
}

.modal-close:hover { background: var(--bg-card); color: var(--text-primary); }

.modal-body { padding: 24px; }

.form-group { margin-bottom: 20px; }

.form-group label {
  display: block;
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px 16px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 10px;
  color: var(--text-primary);
  font-size: 1rem;
  font-family: inherit;
  transition: border-color 0.2s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--primary);
}

.form-group textarea { min-height: 80px; resize: vertical; }

/* Gender Toggle */
.gender-toggle { display: flex; gap: 12px; }

.gender-option {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
}

.gender-option input { display: none; }

.gender-option.male:has(input:checked) {
  border-color: var(--male-color);
  background: rgba(59, 130, 246, 0.2);
}

.gender-option.female:has(input:checked) {
  border-color: var(--female-color);
  background: rgba(236, 72, 153, 0.2);
}

.gender-option .icon { font-size: 1.3rem; }
.gender-option span { font-weight: 600; }

/* Photo Upload */
.photo-upload { display: flex; align-items: center; gap: 16px; }

.photo-preview {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: var(--bg-card);
  border: 3px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.photo-preview img { width: 100%; height: 100%; object-fit: cover; }
.photo-preview .placeholder { font-size: 2rem; color: var(--text-muted); }

.photo-buttons { display: flex; flex-direction: column; gap: 8px; }

.photo-btn {
  padding: 8px 16px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 0.85rem;
  cursor: pointer;
  font-family: inherit;
}

.photo-btn:hover { border-color: var(--primary); }
.photo-btn.remove { border-color: #ef4444; color: #ef4444; }

/* Relation Grid */
.relation-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.relation-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  padding: 12px 8px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
}

.relation-option:hover { border-color: var(--primary); }

.relation-option.selected {
  border-color: var(--primary);
  background: rgba(5, 150, 105, 0.2);
}

.relation-option.disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.relation-option .icon { font-size: 1.5rem; }
.relation-option span { font-size: 0.8rem; font-weight: 600; text-align: center; }

/* Modal Footer */
.modal-footer {
  display: flex;
  gap: 12px;
  padding: 20px 24px;
  border-top: 2px solid var(--border-color);
}

.modal-footer button {
  flex: 1;
  padding: 14px;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
}

.btn-cancel {
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  color: var(--text-primary);
}

.btn-save { background: var(--primary); border: none; color: white; }
.btn-save:hover { background: var(--primary-dark); }

.btn-delete { background: #ef4444; border: none; color: white; flex: 0.5; }
.btn-delete:hover { background: #dc2626; }

/* Zoom Controls */
.zoom-controls {
  position: absolute;
  bottom: 20px;
  left: 20px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  background: var(--bg-card);
  padding: 8px;
  border-radius: 12px;
  border: 2px solid var(--border-color);
}

.zoom-btn {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-secondary);
  border: none;
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 1.2rem;
  cursor: pointer;
}

.zoom-btn:hover { background: var(--primary); }

.zoom-level {
  text-align: center;
  font-size: 0.8rem;
  color: var(--text-muted);
  padding: 4px 0;
}

/* Stats Bar */
.stats-bar {
  display: flex;
  gap: 20px;
  padding: 12px 20px;
  background: var(--bg-card);
  border-radius: 10px;
  margin-top: 16px;
  flex-wrap: wrap;
  justify-content: center;
}

.stat-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
}

.stat-item .icon { font-size: 1.1rem; }
.stat-item .label { color: var(--text-muted); }
.stat-item .value { font-weight: 700; color: var(--text-primary); }

/* Toast */
.toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--bg-card);
  border: 2px solid var(--primary);
  padding: 16px 24px;
  border-radius: 12px;
  color: var(--text-primary);
  font-weight: 600;
  z-index: 2000;
  opacity: 0;
  transition: all 0.3s;
}

.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* Dropdown */
.dropdown { position: relative; }

.dropdown-menu {
  position: absolute;
  top: 100%;
  left: 0;
  margin-top: 8px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 12px;
  min-width: 180px;
  z-index: 100;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.2s;
}

.dropdown.open .dropdown-menu {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  color: var(--text-primary);
  font-size: 0.9rem;
  cursor: pointer;
}

.dropdown-item:first-child { border-radius: 10px 10px 0 0; }
.dropdown-item:last-child { border-radius: 0 0 10px 10px; }
.dropdown-item:hover { background: var(--bg-secondary); }

.dropdown-divider { height: 1px; background: var(--border-color); margin: 4px 0; }

.hidden-input { display: none; }

@media (max-width: 768px) {
  .tree-toolbar { justify-content: center; }
  .toolbar-group { border-right: none; padding: 8px 0; width: 100%; justify-content: center; flex-wrap: wrap; }
  .tool-btn span:not(.icon) { display: none; }
  .relation-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>

<div class="tool-card">
  <div class="tool-header">
    <div class="tool-icon">üå≥</div>
    <div>
      <h1 class="tool-title">Family Tree</h1>
      <p class="tool-description">Create your family tree easily and export it</p>
    </div>
  </div>

  <div class="family-tree-app">
    <!-- Toolbar -->
    <div class="tree-toolbar">
      <div class="toolbar-group">
        <button class="tool-btn primary" onclick="addFirstPerson()" id="add-first-btn">
          <span class="icon">‚ûï</span>
          <span>Add Person</span>
        </button>
      </div>
      
      <div class="toolbar-group">
        <button class="tool-btn" onclick="saveToLocal()">
          <span class="icon">üíæ</span>
          <span>Save Locally</span>
        </button>
        <button class="tool-btn" onclick="loadFromLocal()">
          <span class="icon">üìÇ</span>
          <span>Load Saved</span>
        </button>
      </div>
      
      <div class="toolbar-group">
        <div class="dropdown" id="export-dropdown">
          <button class="tool-btn" onclick="toggleDropdown('export-dropdown')">
            <span class="icon">üì§</span>
            <span>Export</span>
          </button>
          <div class="dropdown-menu">
            <div class="dropdown-item" onclick="exportAsPNG()">üñºÔ∏è Export as PNG</div>
            <div class="dropdown-item" onclick="exportAsSVG()">üìê Export as SVG</div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" onclick="exportAsJSON()">üìÑ Export Data</div>
          </div>
        </div>
        <button class="tool-btn" onclick="importJSON()">
          <span class="icon">üì•</span>
          <span>Import</span>
        </button>
      </div>
      
      <div class="toolbar-group">
        <button class="tool-btn" onclick="clearAll()">
          <span class="icon">üóëÔ∏è</span>
          <span>Clear All</span>
        </button>
      </div>
    </div>

    <!-- Canvas -->
    <div class="canvas-container" id="canvas-container">
      <svg class="tree-canvas" id="tree-canvas">
        <defs>
          <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="4" stdDeviation="6" flood-opacity="0.3"/>
          </filter>
        </defs>
        <g id="tree-content">
          <g id="connections-layer"></g>
          <g id="persons-layer"></g>
        </g>
      </svg>
      
      <div class="empty-state" id="empty-state">
        <div class="icon">üå≥</div>
        <h3>Start by adding the first person</h3>
        <p>Click + to add relative</p>
        <button class="start-btn" onclick="addFirstPerson()">
          <span>‚ûï</span> Add Person
        </button>
      </div>
      
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()">‚ûï</button>
        <div class="zoom-level" id="zoom-level">100%</div>
        <button class="zoom-btn" onclick="zoomOut()">‚ûñ</button>
        <button class="zoom-btn" onclick="fitToScreen()">‚ä°</button>
      </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar" id="stats-bar" style="display: none;">
      <div class="stat-item">
        <span class="icon">üë•</span>
        <span class="label">Total Persons:</span>
        <span class="value" id="stat-total">0</span>
      </div>
      <div class="stat-item">
        <span class="icon">üë®</span>
        <span class="label">Males:</span>
        <span class="value" id="stat-males">0</span>
      </div>
      <div class="stat-item">
        <span class="icon">üë©</span>
        <span class="label">Females:</span>
        <span class="value" id="stat-females">0</span>
      </div>
      <div class="stat-item">
        <span class="icon">üìä</span>
        <span class="label">Generations:</span>
        <span class="value" id="stat-generations">0</span>
      </div>
    </div>
  </div>
</div>

<!-- Person Modal -->
<div class="modal-overlay" id="person-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2><span id="modal-icon">üë§</span> <span id="modal-title">Add Person</span></h2>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group" id="relation-group" style="display: none;">
        <label>Relation</label>
        <div class="relation-grid" id="relation-grid"></div>
      </div>
      
      <div class="form-group">
        <label>Name *</label>
        <input type="text" id="person-name" required>
      </div>
      
      <div class="form-group">
        <label>Gender</label>
        <div class="gender-toggle">
          <label class="gender-option male">
            <input type="radio" name="gender" value="male" checked>
            <span class="icon">üë®</span>
            <span>Male</span>
          </label>
          <label class="gender-option female">
            <input type="radio" name="gender" value="female">
            <span class="icon">üë©</span>
            <span>Female</span>
          </label>
        </div>
      </div>
      
      <div class="form-group">
        <label>Photo</label>
        <div class="photo-upload">
          <div class="photo-preview" id="photo-preview">
            <span class="placeholder">üë§</span>
          </div>
          <div class="photo-buttons">
            <button type="button" class="photo-btn" onclick="document.getElementById('photo-input').click()">
              üì∑ Upload Photo
            </button>
            <button type="button" class="photo-btn remove" onclick="removePhoto()" id="remove-photo-btn" style="display: none;">
              üóëÔ∏è Remove Photo
            </button>
          </div>
        </div>
        <input type="file" id="photo-input" class="hidden-input" accept="image/*" onchange="handlePhotoUpload(event)">
      </div>
      
      <div class="form-group">
        <label>Birth Date</label>
        <input type="date" id="person-birth">
      </div>
      
      <div class="form-group">
        <label>Death Date</label>
        <input type="date" id="person-death">
      </div>
      
      <div class="form-group">
        <label>Notes</label>
        <textarea id="person-notes"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-delete" id="delete-btn" onclick="deletePerson()" style="display: none;">
        üóëÔ∏è Delete
      </button>
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-save" onclick="savePerson()">Save</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="import-input" class="hidden-input" accept=".json" onchange="handleImport(event)">

<script>
const isArabic = document.documentElement.lang === 'ar';

// ==================== DATA STRUCTURE ====================
// ÿ®ŸÜŸäÿ© ÿ¨ÿØŸäÿØÿ©: ŸÉŸÑ ÿ¥ÿÆÿµ ŸÑŸá ÿ£ÿ® Ÿàÿ£ŸÖ ŸÖÿ≠ÿØÿØŸäŸÜ (ÿ£Ÿà null)
// ÿßŸÑÿ£ÿ®ŸÜÿßÿ° ŸäŸèÿ≥ÿ™ŸÜÿ™ÿ¨ŸàŸÜ ŸÖŸÜ fatherId/motherId
let familyData = {
  persons: {},
  rootId: null
};

let currentPersonId = null;
let editMode = false;
let addingRelativeTo = null;
let selectedRelation = null;
let currentPhoto = null;

// Canvas state
let zoom = 1;
let panX = 0;
let panY = 0;
let isDragging = false;
let dragStartX = 0;
let dragStartY = 0;

const CARD_W = 140;
const CARD_H = 90;
const GAP_H = 50;
const GAP_V = 70;

// Relations
const relations = [
  { id: 'father', icon: 'üë®', labelAr: 'ÿ£ÿ®', labelEn: 'Father', gender: 'male' },
  { id: 'mother', icon: 'üë©', labelAr: 'ÿ£ŸÖ', labelEn: 'Mother', gender: 'female' },
  { id: 'spouse', icon: 'üíë', labelAr: 'ÿ≤Ÿàÿ¨/ÿ©', labelEn: 'Spouse', gender: null },
  { id: 'child', icon: 'üë∂', labelAr: 'ÿßÿ®ŸÜ/ÿ©', labelEn: 'Child', gender: null },
  { id: 'sibling', icon: 'üë´', labelAr: 'ÿ£ÿÆ/ÿ£ÿÆÿ™', labelEn: 'Sibling', gender: null }
];

// ==================== INIT ====================
function init() {
  setupCanvas();
  buildRelationGrid();
  updateUI();
}

function setupCanvas() {
  const canvas = document.getElementById('tree-canvas');
  const container = document.getElementById('canvas-container');
  
  canvas.addEventListener('mousedown', startPan);
  canvas.addEventListener('mousemove', doPan);
  canvas.addEventListener('mouseup', endPan);
  canvas.addEventListener('mouseleave', endPan);
  container.addEventListener('wheel', handleZoom);
  
  canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
  canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
  canvas.addEventListener('touchend', handleTouchEnd);
}

function buildRelationGrid() {
  const grid = document.getElementById('relation-grid');
  grid.innerHTML = relations.map(r => `
    <div class="relation-option" data-relation="${r.id}" onclick="selectRelation('${r.id}')">
      <span class="icon">${r.icon}</span>
      <span>${isArabic ? r.labelAr : r.labelEn}</span>
    </div>
  `).join('');
}

// ==================== HELPERS ====================
function generateId() {
  return 'p' + Date.now() + Math.random().toString(36).substr(2, 5);
}

function getChildren(personId) {
  return Object.values(familyData.persons).filter(p => 
    p.fatherId === personId || p.motherId === personId
  );
}

function getSiblings(personId) {
  const person = familyData.persons[personId];
  if (!person) return [];
  
  return Object.values(familyData.persons).filter(p => 
    p.id !== personId && (
      (person.fatherId && p.fatherId === person.fatherId) ||
      (person.motherId && p.motherId === person.motherId)
    )
  );
}

function getSpouses(personId) {
  const person = familyData.persons[personId];
  if (!person) return [];
  return person.spouseIds.map(id => familyData.persons[id]).filter(Boolean);
}

// ==================== PERSON MANAGEMENT ====================
function addFirstPerson() {
  editMode = false;
  addingRelativeTo = null;
  selectedRelation = null;
  currentPhoto = null;
  
  document.getElementById('relation-group').style.display = 'none';
  document.getElementById('delete-btn').style.display = 'none';
  document.getElementById('modal-title').textContent = isArabic ? 'ÿ•ÿ∂ÿßŸÅÿ© ÿ¥ÿÆÿµ' : 'Add Person';
  document.getElementById('modal-icon').textContent = 'üë§';
  
  resetForm();
  openModal();
}

function addRelativeTo(personId) {
  editMode = false;
  addingRelativeTo = personId;
  selectedRelation = null;
  currentPhoto = null;
  
  const person = familyData.persons[personId];
  
  document.getElementById('relation-group').style.display = 'block';
  document.getElementById('delete-btn').style.display = 'none';
  document.getElementById('modal-title').textContent = isArabic ? 'ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ±Ÿäÿ®' : 'Add Relative';
  document.getElementById('modal-icon').textContent = '‚ûï';
  
  // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©
  document.querySelectorAll('.relation-option').forEach(el => {
    el.classList.remove('selected', 'disabled');
    const rel = el.dataset.relation;
    
    // ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑÿ£ÿ® ÿ•ÿ∞ÿß ŸÖŸàÿ¨ŸàÿØ
    if (rel === 'father' && person.fatherId) {
      el.classList.add('disabled');
    }
    // ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑÿ£ŸÖ ÿ•ÿ∞ÿß ŸÖŸàÿ¨ŸàÿØÿ©
    if (rel === 'mother' && person.motherId) {
      el.classList.add('disabled');
    }
  });
  
  resetForm();
  openModal();
}

function editPerson(personId) {
  editMode = true;
  currentPersonId = personId;
  addingRelativeTo = null;
  
  const person = familyData.persons[personId];
  if (!person) return;
  
  document.getElementById('relation-group').style.display = 'none';
  document.getElementById('delete-btn').style.display = 'block';
  document.getElementById('modal-title').textContent = isArabic ? 'ÿ™ÿπÿØŸäŸÑ' : 'Edit';
  document.getElementById('modal-icon').textContent = '‚úèÔ∏è';
  
  document.getElementById('person-name').value = person.name || '';
  document.querySelector(`input[name="gender"][value="${person.gender}"]`).checked = true;
  document.getElementById('person-birth').value = person.birthDate || '';
  document.getElementById('person-death').value = person.deathDate || '';
  document.getElementById('person-notes').value = person.notes || '';
  
  currentPhoto = person.photo || null;
  updatePhotoPreview();
  
  openModal();
}

function savePerson() {
  const name = document.getElementById('person-name').value.trim();
  if (!name) {
    showToast(isArabic ? 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿßÿ≥ŸÖ' : 'Please enter a name');
    return;
  }
  
  const gender = document.querySelector('input[name="gender"]:checked').value;
  const birthDate = document.getElementById('person-birth').value;
  const deathDate = document.getElementById('person-death').value;
  const notes = document.getElementById('person-notes').value.trim();
  
  if (editMode && currentPersonId) {
    // ÿ™ÿπÿØŸäŸÑ ŸÖŸàÿ¨ŸàÿØ
    const person = familyData.persons[currentPersonId];
    person.name = name;
    person.gender = gender;
    person.birthDate = birthDate;
    person.deathDate = deathDate;
    person.notes = notes;
    person.photo = currentPhoto;
  } else {
    // ÿ•ÿ∂ÿßŸÅÿ© ÿ¨ÿØŸäÿØ
    const newId = generateId();
    const newPerson = {
      id: newId,
      name,
      gender,
      birthDate,
      deathDate,
      notes,
      photo: currentPhoto,
      fatherId: null,
      motherId: null,
      spouseIds: []
    };
    
    if (addingRelativeTo && selectedRelation) {
      const relative = familyData.persons[addingRelativeTo];
      
      switch (selectedRelation) {
        case 'father':
          newPerson.gender = 'male';
          relative.fatherId = newId;
          break;
          
        case 'mother':
          newPerson.gender = 'female';
          relative.motherId = newId;
          break;
          
        case 'spouse':
          newPerson.spouseIds.push(addingRelativeTo);
          relative.spouseIds.push(newId);
          break;
          
        case 'child':
          // ÿßŸÑÿßÿ®ŸÜ/ÿßŸÑÿ®ŸÜÿ™: ŸÜÿ±ÿ®ÿ∑Ÿá ÿ®ÿßŸÑÿ¥ÿÆÿµ ÿßŸÑÿ≠ÿßŸÑŸä ŸÉÿ£ÿ® ÿ£Ÿà ÿ£ŸÖ
          if (relative.gender === 'male') {
            newPerson.fatherId = addingRelativeTo;
          } else {
            newPerson.motherId = addingRelativeTo;
          }
          break;
          
        case 'sibling':
          // ÿßŸÑÿ£ÿÆ/ÿßŸÑÿ£ÿÆÿ™: ŸÜÿ¥ÿßÿ±ŸÉ ŸÜŸÅÿ≥ ÿßŸÑÿ£ÿ® ŸàÿßŸÑÿ£ŸÖ
          newPerson.fatherId = relative.fatherId;
          newPerson.motherId = relative.motherId;
          break;
      }
    }
    
    familyData.persons[newId] = newPerson;
    
    if (!familyData.rootId) {
      familyData.rootId = newId;
    }
  }
  
  closeModal();
  layoutTree();
  renderTree();
  updateStats();
}

function deletePerson() {
  if (!currentPersonId) return;
  
  const msg = isArabic ? 'ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ¥ÿÆÿµÿü' : 'Delete this person?';
  if (!confirm(msg)) return;
  
  const person = familyData.persons[currentPersonId];
  
  // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑
  Object.values(familyData.persons).forEach(p => {
    if (p.fatherId === currentPersonId) p.fatherId = null;
    if (p.motherId === currentPersonId) p.motherId = null;
    p.spouseIds = p.spouseIds.filter(id => id !== currentPersonId);
  });
  
  delete familyData.persons[currentPersonId];
  
  // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ¨ÿ∞ÿ±
  const remaining = Object.keys(familyData.persons);
  if (familyData.rootId === currentPersonId) {
    familyData.rootId = remaining.length > 0 ? remaining[0] : null;
  }
  
  closeModal();
  layoutTree();
  renderTree();
  updateStats();
  showToast(isArabic ? 'ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ' : 'Deleted');
}

function selectRelation(relationId) {
  const option = document.querySelector(`.relation-option[data-relation="${relationId}"]`);
  if (option.classList.contains('disabled')) return;
  
  selectedRelation = relationId;
  document.querySelectorAll('.relation-option').forEach(el => {
    el.classList.toggle('selected', el.dataset.relation === relationId);
  });
  
  // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ¨ŸÜÿ≥ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
  const rel = relations.find(r => r.id === relationId);
  if (rel && rel.gender) {
    document.querySelector(`input[name="gender"][value="${rel.gender}"]`).checked = true;
  }
}

// ==================== PHOTO ====================
function handlePhotoUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    currentPhoto = e.target.result;
    updatePhotoPreview();
  };
  reader.readAsDataURL(file);
}

function removePhoto() {
  currentPhoto = null;
  updatePhotoPreview();
  document.getElementById('photo-input').value = '';
}

function updatePhotoPreview() {
  const preview = document.getElementById('photo-preview');
  const removeBtn = document.getElementById('remove-photo-btn');
  
  if (currentPhoto) {
    preview.innerHTML = `<img src="${currentPhoto}" alt="">`;
    removeBtn.style.display = 'block';
  } else {
    preview.innerHTML = '<span class="placeholder">üë§</span>';
    removeBtn.style.display = 'none';
  }
}

// ==================== LAYOUT ====================
function layoutTree() {
  const persons = Object.values(familyData.persons);
  if (persons.length === 0) return;
  
  // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™ (ÿßŸÑÿ£ÿ¨ŸäÿßŸÑ)
  const levels = {};
  const positioned = new Set();
  
  // BFS ŸÖŸÜ ÿßŸÑÿ¨ÿ∞ÿ±
  function assignLevel(personId, level) {
    if (positioned.has(personId)) return;
    positioned.add(personId);
    
    const person = familyData.persons[personId];
    if (!person) return;
    
    if (!levels[level]) levels[level] = [];
    levels[level].push(personId);
    person._level = level;
    
    // ÿßŸÑÿ¢ÿ®ÿßÿ° ŸÅŸä ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ£ÿπŸÑŸâ
    if (person.fatherId) assignLevel(person.fatherId, level - 1);
    if (person.motherId) assignLevel(person.motherId, level - 1);
    
    // ÿßŸÑÿ£ÿ®ŸÜÿßÿ° ŸÅŸä ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ£ÿØŸÜŸâ
    getChildren(personId).forEach(child => {
      assignLevel(child.id, level + 1);
    });
    
    // ÿßŸÑÿ£ÿ≤Ÿàÿßÿ¨ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ
    person.spouseIds.forEach(spouseId => {
      if (!positioned.has(spouseId)) {
        assignLevel(spouseId, level);
      }
    });
    
    // ÿßŸÑÿ•ÿÆŸàÿ© ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ
    getSiblings(personId).forEach(sib => {
      if (!positioned.has(sib.id)) {
        assignLevel(sib.id, level);
      }
    });
  }
  
  assignLevel(familyData.rootId, 0);
  
  // ÿ™ÿ±ÿ™Ÿäÿ® ÿ£ŸÅŸÇŸä
  const levelNums = Object.keys(levels).map(Number).sort((a, b) => a - b);
  const minLevel = Math.min(...levelNums);
  
  const canvasW = document.getElementById('tree-canvas').clientWidth || 800;
  
  levelNums.forEach(lvl => {
    const personsInLevel = levels[lvl];
    const totalW = personsInLevel.length * CARD_W + (personsInLevel.length - 1) * GAP_H;
    const startX = (canvasW - totalW) / 2;
    const y = 80 + (lvl - minLevel) * (CARD_H + GAP_V);
    
    personsInLevel.forEach((pid, idx) => {
      const p = familyData.persons[pid];
      p._x = startX + idx * (CARD_W + GAP_H);
      p._y = y;
    });
  });
}

// ==================== RENDER ====================
function renderTree() {
  const connLayer = document.getElementById('connections-layer');
  const persLayer = document.getElementById('persons-layer');
  
  connLayer.innerHTML = '';
  persLayer.innerHTML = '';
  
  const persons = Object.values(familyData.persons);
  if (persons.length === 0) return;
  
  // ÿ±ÿ≥ŸÖ ÿßŸÑÿÆÿ∑Ÿàÿ∑
  persons.forEach(person => {
    // ÿÆÿ∑ ŸÑŸÑÿ£ÿ®
    if (person.fatherId) {
      const father = familyData.persons[person.fatherId];
      if (father) drawLine(father, person, connLayer);
    }
    // ÿÆÿ∑ ŸÑŸÑÿ£ŸÖ
    if (person.motherId) {
      const mother = familyData.persons[person.motherId];
      if (mother) drawLine(mother, person, connLayer);
    }
    // ÿÆÿ∑ ŸÑŸÑÿ£ÿ≤Ÿàÿßÿ¨
    person.spouseIds.forEach(spId => {
      const spouse = familyData.persons[spId];
      if (spouse && person.id < spId) {
        drawSpouseLine(person, spouse, connLayer);
      }
    });
  });
  
  // ÿ±ÿ≥ŸÖ ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™
  persons.forEach(person => {
    drawCard(person, persLayer);
  });
  
  updateTransform();
  updateUI();
}

function drawLine(parent, child, layer) {
  const x1 = parent._x + CARD_W / 2;
  const y1 = parent._y + CARD_H;
  const x2 = child._x + CARD_W / 2;
  const y2 = child._y;
  
  const midY = (y1 + y2) / 2;
  
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', `M ${x1} ${y1} L ${x1} ${midY} L ${x2} ${midY} L ${x2} ${y2}`);
  path.setAttribute('stroke', '#475569');
  path.setAttribute('stroke-width', '2');
  path.setAttribute('fill', 'none');
  layer.appendChild(path);
}

function drawSpouseLine(p1, p2, layer) {
  const x1 = p1._x + CARD_W;
  const y1 = p1._y + CARD_H / 2;
  const x2 = p2._x;
  const y2 = p2._y + CARD_H / 2;
  
  const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  line.setAttribute('x1', x1);
  line.setAttribute('y1', y1);
  line.setAttribute('x2', x2);
  line.setAttribute('y2', y2);
  line.setAttribute('stroke', '#f59e0b');
  line.setAttribute('stroke-width', '2');
  line.setAttribute('stroke-dasharray', '5,5');
  layer.appendChild(line);
  
  // ÿ≤ÿ± + ÿπŸÑŸâ ÿÆÿ∑ ÿßŸÑÿ≤Ÿàÿßÿ¨ ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ£ÿ®ŸÜÿßÿ° ŸÖÿ¥ÿ™ÿ±ŸÉŸäŸÜ
  const midX = (x1 + x2) / 2;
  const midY = (y1 + y2) / 2 + 20;
  drawAddButton(midX, midY, () => addChildToCouple(p1.id, p2.id), layer);
}

function drawCard(person, layer) {
  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.setAttribute('transform', `translate(${person._x}, ${person._y})`);
  g.style.cursor = 'pointer';
  
  // ÿßŸÑÿÆŸÑŸÅŸäÿ©
  const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  rect.setAttribute('width', CARD_W);
  rect.setAttribute('height', CARD_H);
  rect.setAttribute('rx', '10');
  rect.setAttribute('fill', '#334155');
  rect.setAttribute('stroke', person.gender === 'female' ? '#ec4899' : '#3b82f6');
  rect.setAttribute('stroke-width', person.deathDate ? '2' : '3');
  if (person.deathDate) rect.setAttribute('stroke-dasharray', '5,3');
  rect.setAttribute('filter', 'url(#shadow)');
  g.appendChild(rect);
  
  // ÿßŸÑÿ£ŸäŸÇŸàŸÜÿ© ÿ£Ÿà ÿßŸÑÿµŸàÿ±ÿ©
  if (person.photo) {
    const img = document.createElementNS('http://www.w3.org/2000/svg', 'image');
    img.setAttribute('x', CARD_W/2 - 20);
    img.setAttribute('y', 8);
    img.setAttribute('width', 40);
    img.setAttribute('height', 40);
    img.setAttribute('href', person.photo);
    img.setAttribute('clip-path', 'circle(20px at 20px 20px)');
    g.appendChild(img);
  } else {
    const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    icon.setAttribute('x', CARD_W/2);
    icon.setAttribute('y', 35);
    icon.setAttribute('text-anchor', 'middle');
    icon.setAttribute('font-size', '28');
    icon.textContent = person.gender === 'female' ? 'üë©' : 'üë®';
    g.appendChild(icon);
  }
  
  // ÿßŸÑÿßÿ≥ŸÖ
  const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  name.setAttribute('x', CARD_W/2);
  name.setAttribute('y', 65);
  name.setAttribute('text-anchor', 'middle');
  name.setAttribute('fill', '#f8fafc');
  name.setAttribute('font-size', '13');
  name.setAttribute('font-weight', '600');
  name.textContent = person.name.length > 12 ? person.name.substring(0, 12) + '..' : person.name;
  g.appendChild(name);
  
  // ÿßŸÑÿπŸÖÿ±
  if (person.birthDate) {
    const age = calcAge(person.birthDate, person.deathDate);
    const ageText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    ageText.setAttribute('x', CARD_W/2);
    ageText.setAttribute('y', 80);
    ageText.setAttribute('text-anchor', 'middle');
    ageText.setAttribute('fill', '#94a3b8');
    ageText.setAttribute('font-size', '10');
    ageText.textContent = age + (isArabic ? ' ÿ≥ŸÜÿ©' : ' yrs') + (person.deathDate ? ' ‚úù' : '');
    g.appendChild(ageText);
  }
  
  g.addEventListener('click', (e) => {
    e.stopPropagation();
    editPerson(person.id);
  });
  
  layer.appendChild(g);
  
  // ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©
  // ÿ£ÿπŸÑŸâ - ÿßŸÑŸàÿßŸÑÿØŸäŸÜ
  drawAddButton(person._x + CARD_W/2, person._y - 15, () => addRelativeTo(person.id), layer);
  // ŸäŸÖŸäŸÜ - ÿ≤Ÿàÿ¨/ÿ©
  drawAddButton(person._x + CARD_W + 15, person._y + CARD_H/2, () => addRelativeTo(person.id), layer);
  // ÿ£ÿ≥ŸÅŸÑ - ÿ£ÿ®ŸÜÿßÿ°
  drawAddButton(person._x + CARD_W/2, person._y + CARD_H + 15, () => addRelativeTo(person.id), layer);
}

function drawAddButton(x, y, onClick, layer) {
  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.setAttribute('transform', `translate(${x - 12}, ${y - 12})`);
  g.style.cursor = 'pointer';
  
  const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  circle.setAttribute('cx', 12);
  circle.setAttribute('cy', 12);
  circle.setAttribute('r', 12);
  circle.setAttribute('fill', '#1e293b');
  circle.setAttribute('stroke', '#059669');
  circle.setAttribute('stroke-width', '2');
  g.appendChild(circle);
  
  const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  text.setAttribute('x', 12);
  text.setAttribute('y', 12);
  text.setAttribute('text-anchor', 'middle');
  text.setAttribute('dominant-baseline', 'central');
  text.setAttribute('fill', '#059669');
  text.setAttribute('font-size', '16');
  text.setAttribute('font-weight', 'bold');
  text.textContent = '+';
  g.appendChild(text);
  
  g.addEventListener('click', (e) => {
    e.stopPropagation();
    onClick();
  });
  
  g.addEventListener('mouseenter', () => {
    circle.setAttribute('fill', '#059669');
    text.setAttribute('fill', 'white');
  });
  
  g.addEventListener('mouseleave', () => {
    circle.setAttribute('fill', '#1e293b');
    text.setAttribute('fill', '#059669');
  });
  
  layer.appendChild(g);
}

function addChildToCouple(parent1Id, parent2Id) {
  const p1 = familyData.persons[parent1Id];
  const p2 = familyData.persons[parent2Id];
  
  // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ£ÿ® ŸàÿßŸÑÿ£ŸÖ
  const father = p1.gender === 'male' ? p1 : p2;
  const mother = p1.gender === 'female' ? p1 : p2;
  
  editMode = false;
  addingRelativeTo = null;
  selectedRelation = 'child_of_couple';
  currentPhoto = null;
  
  // ÿ≠ŸÅÿ∏ ŸÖÿ§ŸÇÿ™
  window._coupleChild = { fatherId: father.id, motherId: mother.id };
  
  document.getElementById('relation-group').style.display = 'none';
  document.getElementById('delete-btn').style.display = 'none';
  document.getElementById('modal-title').textContent = isArabic ? 'ÿ•ÿ∂ÿßŸÅÿ© ÿßÿ®ŸÜ/ÿßÿ®ŸÜÿ©' : 'Add Child';
  document.getElementById('modal-icon').textContent = 'üë∂';
  
  resetForm();
  openModal();
}

function calcAge(birth, death) {
  const b = new Date(birth);
  const e = death ? new Date(death) : new Date();
  let age = e.getFullYear() - b.getFullYear();
  if (e.getMonth() < b.getMonth() || (e.getMonth() === b.getMonth() && e.getDate() < b.getDate())) {
    age--;
  }
  return age;
}

// ==================== PAN & ZOOM ====================
function startPan(e) {
  if (e.target.closest('g[style*="cursor: pointer"]')) return;
  isDragging = true;
  dragStartX = e.clientX - panX;
  dragStartY = e.clientY - panY;
}

function doPan(e) {
  if (!isDragging) return;
  panX = e.clientX - dragStartX;
  panY = e.clientY - dragStartY;
  updateTransform();
}

function endPan() { isDragging = false; }

function handleZoom(e) {
  e.preventDefault();
  zoom = Math.max(0.3, Math.min(2, zoom + (e.deltaY > 0 ? -0.1 : 0.1)));
  updateTransform();
  document.getElementById('zoom-level').textContent = Math.round(zoom * 100) + '%';
}

function zoomIn() {
  zoom = Math.min(2, zoom + 0.1);
  updateTransform();
  document.getElementById('zoom-level').textContent = Math.round(zoom * 100) + '%';
}

function zoomOut() {
  zoom = Math.max(0.3, zoom - 0.1);
  updateTransform();
  document.getElementById('zoom-level').textContent = Math.round(zoom * 100) + '%';
}

function fitToScreen() {
  zoom = 1; panX = 0; panY = 0;
  updateTransform();
  document.getElementById('zoom-level').textContent = '100%';
}

function updateTransform() {
  const content = document.getElementById('tree-content');
  content.setAttribute('transform', `translate(${panX}, ${panY}) scale(${zoom})`);
}

let touchStartX, touchStartY;
function handleTouchStart(e) {
  if (e.touches.length === 1) {
    touchStartX = e.touches[0].clientX - panX;
    touchStartY = e.touches[0].clientY - panY;
  }
}
function handleTouchMove(e) {
  if (e.touches.length === 1) {
    e.preventDefault();
    panX = e.touches[0].clientX - touchStartX;
    panY = e.touches[0].clientY - touchStartY;
    updateTransform();
  }
}
function handleTouchEnd() {}

// ==================== SAVE/LOAD ====================
function saveToLocal() {
  localStorage.setItem('familyTree', JSON.stringify(familyData));
  showToast(isArabic ? 'ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏' : 'Saved');
}

function loadFromLocal() {
  const saved = localStorage.getItem('familyTree');
  if (saved) {
    familyData = JSON.parse(saved);
    layoutTree();
    renderTree();
    updateStats();
    showToast(isArabic ? 'ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ' : 'Loaded');
  } else {
    showToast(isArabic ? 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™' : 'No data');
  }
}

function exportAsJSON() {
  const data = JSON.stringify(familyData, null, 2);
  download(data, 'family-tree.json', 'application/json');
}

function importJSON() {
  document.getElementById('import-input').click();
}

function handleImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      familyData = JSON.parse(ev.target.result);
      layoutTree();
      renderTree();
      updateStats();
      showToast(isArabic ? 'ÿ™ŸÖ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ' : 'Imported');
    } catch {
      showToast(isArabic ? 'ŸÖŸÑŸÅ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠' : 'Invalid file');
    }
  };
  reader.readAsText(file);
}

function exportAsPNG() {
  const svg = document.getElementById('tree-canvas');
  const svgData = new XMLSerializer().serializeToString(svg);
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  const img = new Image();
  
  canvas.width = svg.clientWidth * 2;
  canvas.height = svg.clientHeight * 2;
  
  img.onload = function() {
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    
    const link = document.createElement('a');
    link.download = 'family-tree.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  };
  
  img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
}

function exportAsSVG() {
  const svg = document.getElementById('tree-canvas');
  const svgData = new XMLSerializer().serializeToString(svg);
  download(svgData, 'family-tree.svg', 'image/svg+xml');
}

function download(content, filename, type) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

function clearAll() {
  if (!confirm(isArabic ? 'ŸÖÿ≥ÿ≠ ÿßŸÑÿ¥ÿ¨ÿ±ÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑÿü' : 'Clear entire tree?')) return;
  familyData = { persons: {}, rootId: null };
  renderTree();
  updateUI();
  updateStats();
  showToast(isArabic ? 'ÿ™ŸÖ ÿßŸÑŸÖÿ≥ÿ≠' : 'Cleared');
}

// ==================== UI ====================
function updateUI() {
  const count = Object.keys(familyData.persons).length;
  document.getElementById('empty-state').style.display = count === 0 ? 'flex' : 'none';
  document.getElementById('stats-bar').style.display = count === 0 ? 'none' : 'flex';
}

function updateStats() {
  const persons = Object.values(familyData.persons);
  const males = persons.filter(p => p.gender === 'male').length;
  const females = persons.filter(p => p.gender === 'female').length;
  
  // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ÿ¨ŸäÿßŸÑ
  const levels = new Set(persons.map(p => p._level).filter(l => l !== undefined));
  
  document.getElementById('stat-total').textContent = persons.length;
  document.getElementById('stat-males').textContent = males;
  document.getElementById('stat-females').textContent = females;
  document.getElementById('stat-generations').textContent = levels.size || 0;
}

function openModal() {
  document.getElementById('person-modal').classList.add('show');
}

function closeModal() {
  document.getElementById('person-modal').classList.remove('show');
  currentPersonId = null;
  addingRelativeTo = null;
  selectedRelation = null;
  window._coupleChild = null;
}

function resetForm() {
  document.getElementById('person-name').value = '';
  document.querySelector('input[name="gender"][value="male"]').checked = true;
  document.getElementById('person-birth').value = '';
  document.getElementById('person-death').value = '';
  document.getElementById('person-notes').value = '';
  currentPhoto = null;
  updatePhotoPreview();
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

function toggleDropdown(id) {
  const dd = document.getElementById(id);
  dd.classList.toggle('open');
  
  setTimeout(() => {
    document.addEventListener('click', function close(e) {
      if (!dd.contains(e.target)) {
        dd.classList.remove('open');
        document.removeEventListener('click', close);
      }
    });
  }, 0);
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
});

// Override savePerson for couple children
const originalSavePerson = savePerson;
savePerson = function() {
  if (window._coupleChild) {
    const name = document.getElementById('person-name').value.trim();
    if (!name) {
      showToast(isArabic ? 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿßÿ≥ŸÖ' : 'Please enter name');
      return;
    }
    
    const newId = generateId();
    familyData.persons[newId] = {
      id: newId,
      name,
      gender: document.querySelector('input[name="gender"]:checked').value,
      birthDate: document.getElementById('person-birth').value,
      deathDate: document.getElementById('person-death').value,
      notes: document.getElementById('person-notes').value.trim(),
      photo: currentPhoto,
      fatherId: window._coupleChild.fatherId,
      motherId: window._coupleChild.motherId,
      spouseIds: []
    };
    
    closeModal();
    layoutTree();
    renderTree();
    updateStats();
    return;
  }
  
  originalSavePerson.call(this);
};

init();
</script>

<script>
  window.toolsData = [{"id":"percentage","icon":"üî¢","name":"Percentage Calculator","keywords":"percentage calculator, calculate percentage, discount calculator, percent change","searchTerms":"percent percentage % discount sale off price change increase decrease difference quarter half third ratio math calculator profit loss tax margin fraction calculate how much what is of total part whole original cost selling buying before after","category":"calculators","categoryName":"Calculators","url":"../../en/tools/percentage.html"},{"id":"interest-calculator","icon":"üí∞","name":"Interest Calculator","keywords":"interest calculator, simple interest, compound interest, loan calculator","searchTerms":"interest simple compound loan investment return profit bank money calculate annual monthly daily quarterly yearly principal rate time period accumulate savings deposit growth calculator finance financial how much earn","category":"calculators","categoryName":"Calculators","url":"../../en/tools/interest-calculator.html"},{"id":"loan-calculator","icon":"üè¶","name":"Loan Calculator","keywords":"loan calculator, monthly payment, amortization schedule, mortgage calculator","searchTerms":"loan loans payment payments installment installments bank mortgage mortgages monthly schedule amortization calculate calculator interest principal finance financing car home personal","category":"calculators","categoryName":"Calculators","url":"../../en/tools/loan-calculator.html"},{"id":"body-calculator","icon":"‚öñÔ∏è","name":"Body Calculator","keywords":"BMI calculator, body mass index, ideal weight, calorie calculator, body fat","searchTerms":"bmi body mass index weight fat calories calorie bmr tdee ideal healthy obesity overweight underweight waist hip ratio calculate calculator health fitness","category":"calculators","categoryName":"Calculators","url":"../../en/tools/body-calculator.html"},{"id":"age-calculator","icon":"üéÇ","name":"Age Calculator","keywords":"age calculator, calculate age, how old am I, zodiac sign, birthday calculator","searchTerms":"age birthday birth date zodiac calculate how old years months days weeks hours born sign horoscope difference between dates","category":"calculators","categoryName":"Calculators","url":"../../en/tools/age-calculator.html"},{"id":"family-tree","icon":"üå≥","name":"Family Tree","keywords":"family tree, genealogy, ancestry, lineage, family relationships, family tree maker","searchTerms":"family tree genealogy ancestry lineage relatives father mother son daughter brother sister grandfather grandmother uncle aunt cousin relations","category":"everyday","categoryName":"Everyday Tools","url":"../../en/tools/family-tree.html"}];
</script>
      </main>
      
      <footer class="main-footer">
        <p>Made with ‚ù§Ô∏è | All Rights Reserved ¬© 2026 Udda</p>
      </footer>
    </div>
  </div>
  
  <!-- Settings Panel -->
  <div class="settings-overlay"></div>
  <div class="settings-panel">
    <div class="settings-header">
      <h2 class="settings-title">Settings</h2>
      <button class="settings-close" aria-label="Close">‚úï</button>
    </div>
    <div class="settings-content">
      <div class="settings-section">
        <div class="settings-section-title">Language</div>
        <div class="settings-option">
          <button class="settings-btn " data-lang-btn="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
          <button class="settings-btn active" data-lang-btn="en">English</button>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Theme</div>
        <div class="settings-option">
          <button class="settings-btn" data-theme-btn="light">‚òÄÔ∏è Light</button>
          <button class="settings-btn" data-theme-btn="dark">üåô Dark</button>
          <button class="settings-btn active" data-theme-btn="auto">üíª Auto</button>
        </div>
      </div>
      <div class="settings-section">
        <button class="settings-btn" data-clear-data style="width:100%;justify-content:center;color:var(--error);">
          üóëÔ∏è Clear Saved Data
        </button>
      </div>
    </div>
  </div>
  
  <div class="toast"></div>
  <script src="../../assets/js/app.js"></script>
</body>
</html>