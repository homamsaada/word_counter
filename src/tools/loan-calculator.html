<style>
/* Loan Calculator Styles */
.loan-calculator {
  max-width: 900px;
  margin: 0 auto;
  font-family: inherit;
}

.loan-calculator * {
  font-family: inherit;
}

.loan-types {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.loan-type-btn {
  flex: 1;
  min-width: 140px;
  padding: 12px 16px;
  border: 2px solid var(--border-color);
  border-radius: 12px;
  background: var(--bg-secondary);
  color: var(--text-secondary);
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-fast);
  text-align: center;
}

.loan-type-btn:hover {
  border-color: var(--primary);
  color: var(--primary);
}

.loan-type-btn.active {
  background: var(--primary);
  border-color: var(--primary);
  color: white;
}

.loan-type-btn span {
  display: block;
  font-size: 0.8rem;
  font-weight: 400;
  opacity: 0.8;
  margin-top: 4px;
}

.loan-form {
  background: var(--bg-secondary);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 16px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group label {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 0.9rem;
}

.form-group input, .form-group select {
  padding: 12px 16px;
  border: 2px solid var(--border-color);
  border-radius: 10px;
  background: var(--bg-primary);
  color: var(--text-primary);
  font-size: 1rem;
  font-family: inherit;
  transition: border-color var(--transition-fast);
}

.form-group input:focus, .form-group select:focus {
  outline: none;
  border-color: var(--primary);
}

.input-with-suffix {
  position: relative;
}

.input-with-suffix input {
  width: 100%;
  padding-right: 50px;
}

.input-suffix {
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  font-weight: 600;
}

.calculate-btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all var(--transition-fast);
  margin-top: 8px;
}

.calculate-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
}

/* Results */
.loan-results {
  display: none;
}

.loan-results.show {
  display: block;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.results-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.result-card {
  background: var(--bg-secondary);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
}

.result-card.primary {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
}

.result-card.primary .result-label {
  color: rgba(255,255,255,0.85);
}

.result-label {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-bottom: 8px;
}

.result-value {
  font-size: 1.8rem;
  font-weight: 800;
  color: var(--text-primary);
}

.result-card.primary .result-value {
  color: white;
}

.result-value.green {
  color: #22c55e;
}

.result-value.orange {
  color: #f59e0b;
}

/* Charts Section */
.charts-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  margin-bottom: 24px;
}

@media (max-width: 768px) {
  .charts-section {
    grid-template-columns: 1fr;
  }
}

.chart-card {
  background: var(--bg-secondary);
  border-radius: 16px;
  padding: 20px;
}

.chart-card h3 {
  font-size: 1rem;
  color: var(--text-primary);
  margin-bottom: 16px;
  text-align: center;
}

.chart-container {
  height: 250px;
  position: relative;
}

/* Schedule Table */
.schedule-section {
  background: var(--bg-secondary);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 24px;
}

.schedule-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  flex-wrap: wrap;
  gap: 12px;
}

.schedule-header h3 {
  font-size: 1.1rem;
  color: var(--text-primary);
  margin: 0;
}

.schedule-toggle {
  display: flex;
  gap: 8px;
}

.toggle-btn {
  padding: 8px 16px;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  background: var(--bg-primary);
  color: var(--text-secondary);
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.toggle-btn.active {
  background: var(--primary);
  border-color: var(--primary);
  color: white;
}

.schedule-table-wrapper {
  max-height: 400px;
  overflow-y: auto;
  border-radius: 12px;
  border: 1px solid var(--border-color);
}

.schedule-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}

.schedule-table th {
  background: var(--primary);
  color: white;
  padding: 12px 16px;
  text-align: center;
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 1;
}

.schedule-table td {
  padding: 10px 16px;
  text-align: center;
  border-bottom: 1px solid var(--border-color);
}

.schedule-table tr:nth-child(even) {
  background: var(--bg-tertiary);
}

.schedule-table tr:hover {
  background: rgba(99, 102, 241, 0.1);
}

/* Export Buttons */
.export-buttons {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.export-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  border: none;
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.export-btn:hover {
  transform: translateY(-2px);
}

.export-btn.excel {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: white;
}

.export-btn.excel:hover {
  box-shadow: 0 6px 15px rgba(34, 197, 94, 0.3);
}

.export-btn.copy {
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  color: white;
}

.export-btn.copy:hover {
  box-shadow: 0 6px 15px rgba(139, 92, 246, 0.3);
}

/* Type Description */
.type-description {
  background: rgba(99, 102, 241, 0.1);
  border: 1px solid rgba(99, 102, 241, 0.2);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
}

.type-description p {
  margin: 0;
  color: var(--text-secondary);
  font-size: 0.9rem;
  line-height: 1.6;
}

.type-description strong {
  color: var(--primary);
}
</style>

<div class="loan-calculator">
  <!-- Loan Type Selection -->
  <div class="loan-types">
    <button class="loan-type-btn active" data-type="amortized" onclick="selectLoanType('amortized')">
      {{tool.amortized}}
      <span>{{tool.amortizedDesc}}</span>
    </button>
    <button class="loan-type-btn" data-type="declining" onclick="selectLoanType('declining')">
      {{tool.declining}}
      <span>{{tool.decliningDesc}}</span>
    </button>
    <button class="loan-type-btn" data-type="interest-only" onclick="selectLoanType('interest-only')">
      {{tool.interestOnly}}
      <span>{{tool.interestOnlyDesc}}</span>
    </button>
  </div>

  <!-- Type Description -->
  <div class="type-description" id="type-description">
    <p id="type-desc-text"></p>
  </div>

  <!-- Input Form -->
  <div class="loan-form">
    <div class="form-row">
      <div class="form-group">
        <label>{{tool.loanAmount}}</label>
        <div class="input-with-suffix">
          <input type="number" id="loan-amount" placeholder="100000" oninput="calculateLoan()">
          <span class="input-suffix">$</span>
        </div>
      </div>
      <div class="form-group">
        <label>{{tool.interestRate}}</label>
        <div class="input-with-suffix">
          <input type="number" id="interest-rate" placeholder="5" step="0.1" oninput="calculateLoan()">
          <span class="input-suffix">%</span>
        </div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>{{tool.loanTerm}}</label>
        <input type="number" id="loan-term" placeholder="5" oninput="calculateLoan()">
      </div>
      <div class="form-group">
        <label>{{tool.termUnit}}</label>
        <select id="term-unit" onchange="calculateLoan()">
          <option value="years">{{tool.years}}</option>
          <option value="months">{{tool.months}}</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div class="loan-results" id="loan-results">
    <div class="results-summary">
      <div class="result-card primary">
        <div class="result-label">{{tool.monthlyPayment}}</div>
        <div class="result-value" id="monthly-payment">$0</div>
      </div>
      <div class="result-card">
        <div class="result-label">{{tool.totalPayment}}</div>
        <div class="result-value" id="total-payment">$0</div>
      </div>
      <div class="result-card">
        <div class="result-label">{{tool.totalInterest}}</div>
        <div class="result-value orange" id="total-interest">$0</div>
      </div>
      <div class="result-card">
        <div class="result-label">{{tool.interestRatio}}</div>
        <div class="result-value" id="interest-ratio">0%</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-section">
      <div class="chart-card">
        <h3>{{tool.paymentBreakdown}}</h3>
        <div class="chart-container">
          <canvas id="pie-chart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h3>{{tool.balanceOverTime}}</h3>
        <div class="chart-container">
          <canvas id="balance-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Amortization Schedule -->
    <div class="schedule-section">
      <div class="schedule-header">
        <h3>{{tool.paymentSchedule}}</h3>
        <div class="schedule-toggle">
          <button class="toggle-btn active" onclick="toggleScheduleView('monthly')">{{tool.monthly}}</button>
          <button class="toggle-btn" onclick="toggleScheduleView('yearly')">{{tool.yearly}}</button>
        </div>
      </div>
      <div class="schedule-table-wrapper">
        <table class="schedule-table">
          <thead>
            <tr>
              <th id="period-header">{{tool.month}}</th>
              <th>{{tool.payment}}</th>
              <th>{{tool.principalPaid}}</th>
              <th>{{tool.interestPaid}}</th>
              <th>{{tool.remainingBalance}}</th>
            </tr>
          </thead>
          <tbody id="schedule-body">
          </tbody>
        </table>
      </div>
    </div>

    <!-- Export -->
    <div class="export-buttons">
      <button class="export-btn excel" onclick="exportLoanToExcel()">
        ðŸ“Š {{tool.exportExcel}}
      </button>
      <button class="export-btn copy" onclick="copyLoanData()">
        ðŸ“‹ {{tool.copyAll}}
      </button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
<script>
const isArabic = App.state.lang === 'ar';

// Translations
const t = {
  amortizedDesc: isArabic ? 'Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ø¨Øª Ù‡Ùˆ Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ø§Ù‹. ØªØ¯ÙØ¹ Ù†ÙØ³ Ø§Ù„Ù…Ø¨Ù„Øº ÙƒÙ„ Ø´Ù‡Ø±ØŒ Ù„ÙƒÙ† Ù†Ø³Ø¨Ø© Ø§Ù„ÙØ§Ø¦Ø¯Ø© ØªÙ‚Ù„ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹ ÙˆÙ†Ø³Ø¨Ø© Ø§Ù„Ø£ØµÙ„ ØªØ²ÙŠØ¯.' : 'Fixed payment is the most common. You pay the same amount each month, but the interest portion decreases while the principal portion increases.',
  decliningDesc: isArabic ? 'Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù…ØªÙ†Ø§Ù‚Øµ: ØªØ¯ÙØ¹ Ù…Ø¨Ù„ØºØ§Ù‹ Ø«Ø§Ø¨ØªØ§Ù‹ Ù…Ù† Ø§Ù„Ø£ØµÙ„ + Ø§Ù„ÙØ§Ø¦Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ. Ø§Ù„Ù‚Ø³Ø· ÙŠØ¨Ø¯Ø£ Ø¹Ø§Ù„ÙŠØ§Ù‹ Ø«Ù… ÙŠÙ‚Ù„.' : 'Declining balance: You pay a fixed principal amount + interest on remaining balance. Payments start high and decrease.',
  interestOnlyDesc: isArabic ? 'ØªØ¯ÙØ¹ Ø§Ù„ÙØ§Ø¦Ø¯Ø© ÙÙ‚Ø· Ø®Ù„Ø§Ù„ Ø§Ù„Ù…Ø¯Ø©ØŒ Ø«Ù… ØªØ³Ø¯Ø¯ ÙƒØ§Ù…Ù„ Ø§Ù„Ø£ØµÙ„ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©. Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª Ù‚ØµÙŠØ±Ø© Ø§Ù„Ù…Ø¯Ù‰.' : 'Pay only interest during the term, then pay the full principal at the end. Suitable for short-term investments.',
  month: isArabic ? 'Ø§Ù„Ø´Ù‡Ø±' : 'Month',
  year: isArabic ? 'Ø§Ù„Ø³Ù†Ø©' : 'Year',
  principal: isArabic ? 'Ø§Ù„Ø£ØµÙ„' : 'Principal',
  interest: isArabic ? 'Ø§Ù„ÙØ§Ø¦Ø¯Ø©' : 'Interest',
  remaining: isArabic ? 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ' : 'Remaining'
};

let currentLoanType = 'amortized';
let scheduleData = [];
let pieChart = null;
let balanceChart = null;
let scheduleView = 'monthly';

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  updateTypeDescription();
});

function selectLoanType(type) {
  currentLoanType = type;
  document.querySelectorAll('.loan-type-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.type === type);
  });
  updateTypeDescription();
  calculateLoan();
}

function updateTypeDescription() {
  const descText = document.getElementById('type-desc-text');
  switch(currentLoanType) {
    case 'amortized':
      descText.innerHTML = t.amortizedDesc;
      break;
    case 'declining':
      descText.innerHTML = t.decliningDesc;
      break;
    case 'interest-only':
      descText.innerHTML = t.interestOnlyDesc;
      break;
  }
}

function calculateLoan() {
  const principal = parseFloat(document.getElementById('loan-amount').value);
  const annualRate = parseFloat(document.getElementById('interest-rate').value);
  const term = parseFloat(document.getElementById('loan-term').value);
  const termUnit = document.getElementById('term-unit').value;

  if (!principal || !annualRate || !term) {
    document.getElementById('loan-results').classList.remove('show');
    return;
  }

  const monthlyRate = annualRate / 100 / 12;
  const totalMonths = termUnit === 'years' ? term * 12 : term;

  let monthlyPayment, totalPayment, totalInterest;
  scheduleData = [];

  switch(currentLoanType) {
    case 'amortized':
      ({ monthlyPayment, totalPayment, totalInterest, scheduleData } = 
        calculateAmortized(principal, monthlyRate, totalMonths));
      break;
    case 'declining':
      ({ monthlyPayment, totalPayment, totalInterest, scheduleData } = 
        calculateDeclining(principal, monthlyRate, totalMonths));
      break;
    case 'interest-only':
      ({ monthlyPayment, totalPayment, totalInterest, scheduleData } = 
        calculateInterestOnly(principal, monthlyRate, totalMonths));
      break;
  }

  // Update UI
  document.getElementById('monthly-payment').textContent = formatCurrency(monthlyPayment);
  document.getElementById('total-payment').textContent = formatCurrency(totalPayment);
  document.getElementById('total-interest').textContent = formatCurrency(totalInterest);
  document.getElementById('interest-ratio').textContent = ((totalInterest / totalPayment) * 100).toFixed(1) + '%';

  document.getElementById('loan-results').classList.add('show');

  updateCharts(principal, totalInterest);
  updateScheduleTable();
}

function calculateAmortized(principal, monthlyRate, totalMonths) {
  // M = P * [r(1+r)^n] / [(1+r)^n - 1]
  const monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) / 
                         (Math.pow(1 + monthlyRate, totalMonths) - 1);
  
  const totalPayment = monthlyPayment * totalMonths;
  const totalInterest = totalPayment - principal;

  let balance = principal;
  const schedule = [];

  for (let month = 1; month <= totalMonths; month++) {
    const interestPaid = balance * monthlyRate;
    const principalPaid = monthlyPayment - interestPaid;
    balance -= principalPaid;
    
    schedule.push({
      month,
      payment: monthlyPayment,
      principalPaid,
      interestPaid,
      balance: Math.max(0, balance)
    });
  }

  return { monthlyPayment, totalPayment, totalInterest, scheduleData: schedule };
}

function calculateDeclining(principal, monthlyRate, totalMonths) {
  const fixedPrincipal = principal / totalMonths;
  let balance = principal;
  const schedule = [];
  let totalPayment = 0;
  let totalInterest = 0;

  for (let month = 1; month <= totalMonths; month++) {
    const interestPaid = balance * monthlyRate;
    const payment = fixedPrincipal + interestPaid;
    balance -= fixedPrincipal;
    
    totalPayment += payment;
    totalInterest += interestPaid;

    schedule.push({
      month,
      payment,
      principalPaid: fixedPrincipal,
      interestPaid,
      balance: Math.max(0, balance)
    });
  }

  const monthlyPayment = schedule[0].payment; // First payment (highest)

  return { monthlyPayment, totalPayment, totalInterest, scheduleData: schedule };
}

function calculateInterestOnly(principal, monthlyRate, totalMonths) {
  const monthlyInterest = principal * monthlyRate;
  const totalInterest = monthlyInterest * totalMonths;
  const totalPayment = totalInterest + principal;

  const schedule = [];
  for (let month = 1; month <= totalMonths; month++) {
    const isLastMonth = month === totalMonths;
    schedule.push({
      month,
      payment: isLastMonth ? monthlyInterest + principal : monthlyInterest,
      principalPaid: isLastMonth ? principal : 0,
      interestPaid: monthlyInterest,
      balance: isLastMonth ? 0 : principal
    });
  }

  return { 
    monthlyPayment: monthlyInterest, 
    totalPayment, 
    totalInterest, 
    scheduleData: schedule 
  };
}

function updateCharts(principal, totalInterest) {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  const textColor = isDark ? '#E5E7EB' : '#374151';
  const gridColor = isDark ? '#374151' : '#E5E7EB';

  // Pie Chart
  const pieCtx = document.getElementById('pie-chart').getContext('2d');
  if (pieChart) pieChart.destroy();

  pieChart = new Chart(pieCtx, {
    type: 'doughnut',
    data: {
      labels: [t.principal, t.interest],
      datasets: [{
        data: [principal, totalInterest],
        backgroundColor: ['#22c55e', '#f59e0b'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          rtl: isArabic,
          labels: { color: textColor, padding: 20 }
        },
        tooltip: {
          rtl: isArabic,
          callbacks: {
            label: (ctx) => ctx.label + ': ' + formatCurrency(ctx.raw)
          }
        }
      }
    }
  });

  // Balance Chart
  const balanceCtx = document.getElementById('balance-chart').getContext('2d');
  if (balanceChart) balanceChart.destroy();

  const labels = scheduleData.map(d => d.month);
  const balances = scheduleData.map(d => d.balance);
  const principalPaid = [];
  let cumPrincipal = 0;
  scheduleData.forEach(d => {
    cumPrincipal += d.principalPaid;
    principalPaid.push(cumPrincipal);
  });

  balanceChart = new Chart(balanceCtx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: t.remaining,
          data: balances,
          borderColor: '#ef4444',
          backgroundColor: 'rgba(239, 68, 68, 0.1)',
          fill: true,
          tension: 0.3
        },
        {
          label: t.principal + ' ' + (isArabic ? 'Ø§Ù„Ù…Ø¯ÙÙˆØ¹' : 'Paid'),
          data: principalPaid,
          borderColor: '#22c55e',
          backgroundColor: 'rgba(34, 197, 94, 0.1)',
          fill: true,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          rtl: isArabic,
          labels: { color: textColor }
        }
      },
      scales: {
        x: {
          title: { display: true, text: t.month, color: textColor },
          ticks: { color: textColor },
          grid: { display: false }
        },
        y: {
          title: { display: true, text: '$', color: textColor },
          ticks: { 
            color: textColor,
            callback: (v) => v >= 1000 ? (v/1000).toFixed(0) + 'K' : v
          },
          grid: { color: gridColor }
        }
      }
    }
  });
}

function toggleScheduleView(view) {
  scheduleView = view;
  document.querySelectorAll('.schedule-toggle .toggle-btn').forEach(btn => {
    btn.classList.toggle('active', btn.textContent.includes(view === 'monthly' ? 
      (isArabic ? 'Ø´Ù‡Ø±ÙŠ' : 'Monthly') : (isArabic ? 'Ø³Ù†ÙˆÙŠ' : 'Yearly')));
  });
  
  const header = document.getElementById('period-header');
  header.textContent = view === 'monthly' ? t.month : t.year;
  
  updateScheduleTable();
}

function updateScheduleTable() {
  const tbody = document.getElementById('schedule-body');
  tbody.innerHTML = '';

  let dataToShow = scheduleData;

  if (scheduleView === 'yearly') {
    // Aggregate by year
    const yearlyData = [];
    for (let i = 0; i < scheduleData.length; i += 12) {
      const yearSlice = scheduleData.slice(i, i + 12);
      const year = Math.floor(i / 12) + 1;
      yearlyData.push({
        month: year,
        payment: yearSlice.reduce((s, d) => s + d.payment, 0),
        principalPaid: yearSlice.reduce((s, d) => s + d.principalPaid, 0),
        interestPaid: yearSlice.reduce((s, d) => s + d.interestPaid, 0),
        balance: yearSlice[yearSlice.length - 1].balance
      });
    }
    dataToShow = yearlyData;
  }

  dataToShow.forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.month}</td>
      <td>${formatCurrency(row.payment)}</td>
      <td style="color: #22c55e">${formatCurrency(row.principalPaid)}</td>
      <td style="color: #f59e0b">${formatCurrency(row.interestPaid)}</td>
      <td>${formatCurrency(row.balance)}</td>
    `;
    tbody.appendChild(tr);
  });
}

function formatCurrency(num) {
  return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// Export functions
async function exportLoanToExcel() {
  if (scheduleData.length === 0) return;

  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet(isArabic ? 'Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø¯Ø§Ø¯' : 'Payment Schedule');

  if (isArabic) worksheet.views = [{ rightToLeft: true }];

  // Title
  worksheet.mergeCells('A1:E1');
  const title = worksheet.getCell('A1');
  title.value = isArabic ? 'Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚Ø±ÙˆØ¶ - Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø¯Ø§Ø¯' : 'Loan Calculator - Payment Schedule';
  title.font = { size: 18, bold: true, color: { argb: 'FF6366F1' } };
  title.alignment = { horizontal: 'center' };

  // Summary
  const principal = parseFloat(document.getElementById('loan-amount').value);
  const rate = parseFloat(document.getElementById('interest-rate').value);
  const term = parseFloat(document.getElementById('loan-term').value);
  const unit = document.getElementById('term-unit').value;

  const summaryStart = 3;
  const summaryLabels = isArabic ? 
    ['Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø±Ø¶', 'Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ§Ø¦Ø¯Ø©', 'Ø§Ù„Ù…Ø¯Ø©', 'Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø±Ø¶', 'Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§Ø¦Ø¯'] :
    ['Loan Amount', 'Interest Rate', 'Term', 'Loan Type', 'Monthly Payment', 'Total Payments', 'Total Interest'];
  
  const loanTypeNames = {
    'amortized': isArabic ? 'Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ø¨Øª' : 'Fixed Payment',
    'declining': isArabic ? 'Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù…ØªÙ†Ø§Ù‚Øµ' : 'Declining Balance',
    'interest-only': isArabic ? 'ÙØ§Ø¦Ø¯Ø© ÙÙ‚Ø·' : 'Interest Only'
  };

  const monthlyPayment = document.getElementById('monthly-payment').textContent;
  const totalPayment = document.getElementById('total-payment').textContent;
  const totalInterest = document.getElementById('total-interest').textContent;

  const summaryValues = [
    principal, rate + '%', term + ' ' + (unit === 'years' ? (isArabic ? 'Ø³Ù†Ø©' : 'years') : (isArabic ? 'Ø´Ù‡Ø±' : 'months')),
    loanTypeNames[currentLoanType], monthlyPayment, totalPayment, totalInterest
  ];

  summaryLabels.forEach((label, i) => {
    worksheet.getCell(summaryStart + i, 1).value = label;
    worksheet.getCell(summaryStart + i, 1).font = { bold: true };
    worksheet.getCell(summaryStart + i, 2).value = summaryValues[i];
  });

  // Table headers
  const headerRow = summaryStart + summaryLabels.length + 2;
  const headers = isArabic ? 
    ['Ø§Ù„Ø´Ù‡Ø±', 'Ø§Ù„Ù‚Ø³Ø·', 'Ø§Ù„Ø£ØµÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹', 'Ø§Ù„ÙØ§Ø¦Ø¯Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©', 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ'] :
    ['Month', 'Payment', 'Principal Paid', 'Interest Paid', 'Remaining Balance'];

  headers.forEach((h, i) => {
    const cell = worksheet.getCell(headerRow, i + 1);
    cell.value = h;
    cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF6366F1' } };
    cell.alignment = { horizontal: 'center' };
  });

  // Data
  scheduleData.forEach((row, i) => {
    const rowNum = headerRow + 1 + i;
    worksheet.getCell(rowNum, 1).value = row.month;
    worksheet.getCell(rowNum, 2).value = row.payment;
    worksheet.getCell(rowNum, 3).value = row.principalPaid;
    worksheet.getCell(rowNum, 4).value = row.interestPaid;
    worksheet.getCell(rowNum, 5).value = row.balance;

    [2, 3, 4, 5].forEach(col => {
      worksheet.getCell(rowNum, col).numFmt = '$#,##0.00';
    });

    if (i % 2 === 0) {
      for (let col = 1; col <= 5; col++) {
        worksheet.getCell(rowNum, col).fill = { 
          type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF9FAFB' } 
        };
      }
    }
  });

  worksheet.columns = [{ width: 12 }, { width: 16 }, { width: 18 }, { width: 18 }, { width: 18 }];

  const buffer = await workbook.xlsx.writeBuffer();
  const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = isArabic ? 'Ø¬Ø¯ÙˆÙ„_Ø³Ø¯Ø§Ø¯_Ø§Ù„Ù‚Ø±Ø¶.xlsx' : 'loan_payment_schedule.xlsx';
  link.click();

  App.showToast(isArabic ? 'ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±!' : 'Exported!');
}

function copyLoanData() {
  if (scheduleData.length === 0) return;

  const principal = document.getElementById('loan-amount').value;
  const rate = document.getElementById('interest-rate').value;
  const term = document.getElementById('loan-term').value;
  const unit = document.getElementById('term-unit').value;

  let text = isArabic ? 'â•â•â• Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚Ø±ÙˆØ¶ â•â•â•\n\n' : 'â•â•â• Loan Calculator â•â•â•\n\n';
  
  text += isArabic ? `Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø±Ø¶: $${principal}\n` : `Loan Amount: $${principal}\n`;
  text += isArabic ? `Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ§Ø¦Ø¯Ø©: ${rate}%\n` : `Interest Rate: ${rate}%\n`;
  text += isArabic ? `Ø§Ù„Ù…Ø¯Ø©: ${term} ${unit === 'years' ? 'Ø³Ù†Ø©' : 'Ø´Ù‡Ø±'}\n\n` : `Term: ${term} ${unit}\n\n`;

  text += isArabic ? `Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ: ${document.getElementById('monthly-payment').textContent}\n` :
                     `Monthly Payment: ${document.getElementById('monthly-payment').textContent}\n`;
  text += isArabic ? `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª: ${document.getElementById('total-payment').textContent}\n` :
                     `Total Payments: ${document.getElementById('total-payment').textContent}\n`;
  text += isArabic ? `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§Ø¦Ø¯: ${document.getElementById('total-interest').textContent}\n` :
                     `Total Interest: ${document.getElementById('total-interest').textContent}\n`;

  navigator.clipboard.writeText(text);
  App.showToast(isArabic ? 'ØªÙ… Ø§Ù„Ù†Ø³Ø®!' : 'Copied!');
}

// Theme observer
const themeObserver = new MutationObserver(() => {
  if (scheduleData.length > 0) {
    const principal = parseFloat(document.getElementById('loan-amount').value);
    const totalInterest = parseFloat(document.getElementById('total-interest').textContent.replace(/[$,]/g, ''));
    updateCharts(principal, totalInterest);
  }
});
themeObserver.observe(document.documentElement, { attributes: true });
</script>
